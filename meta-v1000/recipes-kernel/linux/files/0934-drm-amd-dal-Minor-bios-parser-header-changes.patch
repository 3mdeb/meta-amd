From e89107e158e87ad81078fd15a28aeed46b060566 Mon Sep 17 00:00:00 2001
From: Hersen Wu <hersenxs.wu@amd.com>
Date: Thu, 18 Aug 2016 16:10:44 -0400
Subject: [PATCH 0934/1722] drm/amd/dal: Minor bios parser header changes

This is to get ready for new bios implementation

Change-Id: I4018c7bf93e0fd5f1e1dfcb6e26eeef67ae214f6
Signed-off-by: Jordan Lazare <Jordan.Lazare@amd.com>
Acked-by: Harry Wentland <harry.wentland@amd.com>
Signed-off-by: Kalyan Alle <kalyan.alle@amd.com>
---
 .../gpu/drm/amd/dal/dc/adapter/adapter_service.c   |  5 +-
 drivers/gpu/drm/amd/dal/dc/bios/Makefile           |  2 +-
 drivers/gpu/drm/amd/dal/dc/bios/bios_parser.c      | 16 ++++-
 drivers/gpu/drm/amd/dal/dc/bios/bios_parser.h      | 54 +-------------
 .../gpu/drm/amd/dal/dc/bios/bios_parser_helper.c   |  2 +-
 .../drm/amd/dal/dc/bios/bios_parser_interface.c    | 50 +++++++++++++
 .../amd/dal/dc/bios/bios_parser_types_internal.h   | 82 ++++++++++++++++++++++
 drivers/gpu/drm/amd/dal/dc/bios/command_table.c    |  2 +-
 .../drm/amd/dal/include/bios_parser_interface.h    |  3 +-
 .../gpu/drm/amd/dal/include/bios_parser_types.h    |  2 +
 .../drm/amd/dal/include/grph_object_ctrl_defs.h    |  7 ++
 11 files changed, 164 insertions(+), 61 deletions(-)
 create mode 100644 drivers/gpu/drm/amd/dal/dc/bios/bios_parser_interface.c
 create mode 100644 drivers/gpu/drm/amd/dal/dc/bios/bios_parser_types_internal.h

diff --git a/drivers/gpu/drm/amd/dal/dc/adapter/adapter_service.c b/drivers/gpu/drm/amd/dal/dc/adapter/adapter_service.c
index 06a4c2b..95d1f38 100644
--- a/drivers/gpu/drm/amd/dal/dc/adapter/adapter_service.c
+++ b/drivers/gpu/drm/amd/dal/dc/adapter/adapter_service.c
@@ -821,8 +821,9 @@ static bool adapter_service_construct(
 	}
 
 	/* Integrated info is not provided on discrete ASIC. NULL is allowed */
-	as->integrated_info = dc_bios_create_integrated_info(dcb);
-
+        if (dcb->funcs->create_integrated_info)
+                as->integrated_info = dcb->funcs->create_integrated_info(dcb);
+	
 	dc_bios_post_init(dcb, as);
 
 	/* Generate backlight translation table and initializes
diff --git a/drivers/gpu/drm/amd/dal/dc/bios/Makefile b/drivers/gpu/drm/amd/dal/dc/bios/Makefile
index 9c90230..691f970 100644
--- a/drivers/gpu/drm/amd/dal/dc/bios/Makefile
+++ b/drivers/gpu/drm/amd/dal/dc/bios/Makefile
@@ -2,7 +2,7 @@
 # Makefile for the 'bios' sub-component of DAL.
 # It provides the parsing and executing controls for atom bios image.
 
-BIOS = bios_parser.o bios_parser_helper.o command_table.o command_table_helper.o
+BIOS = bios_parser.o bios_parser_interface.o  bios_parser_helper.o command_table.o command_table_helper.o
 
 AMD_DAL_BIOS = $(addprefix $(AMDDALPATH)/dc/bios/,$(BIOS))
 
diff --git a/drivers/gpu/drm/amd/dal/dc/bios/bios_parser.c b/drivers/gpu/drm/amd/dal/dc/bios/bios_parser.c
index 9096b51..2fee1a6 100644
--- a/drivers/gpu/drm/amd/dal/dc/bios/bios_parser.c
+++ b/drivers/gpu/drm/amd/dal/dc/bios/bios_parser.c
@@ -40,6 +40,7 @@
 #endif
 #include "command_table_helper.h"
 #include "bios_parser.h"
+#include "bios_parser_types_internal.h"
 #include "bios_parser_interface.h"
 
 #define THREE_PERCENT_OF_10000 300
@@ -107,7 +108,7 @@ enum bp_result dc_bios_get_embedded_panel_info(struct dc_bios *dcb,
 
 /*****************************************************************************/
 
-struct dc_bios *dal_bios_parser_create(
+struct dc_bios *bios_parser_create(
 	struct bp_init_data *init,
 	enum dce_version dce_version)
 {
@@ -131,7 +132,7 @@ static void destruct(struct bios_parser *bp)
 		dm_free(bp->bios_local_image);
 }
 
-void dal_bios_parser_destroy(struct dc_bios **dcb)
+static void bios_parser_destroy(struct dc_bios **dcb)
 {
 	struct bios_parser *bp = BP_FROM_DCB(*dcb);
 
@@ -549,7 +550,10 @@ enum bp_result dc_bios_get_voltage_ddc_info(struct dc_bios *dcb,
 	return result;
 }
 
-enum bp_result bios_parser_get_ddc_info_for_i2c_line(struct bios_parser *bp,
+/* TODO: temporary commented out to suppress 'defined but not used' warning */
+#if 0
+static enum bp_result bios_parser_get_ddc_info_for_i2c_line(
+	struct bios_parser *bp,
 	uint8_t i2c_line, struct graphics_object_i2c_info *info)
 {
 	uint32_t offset;
@@ -612,6 +616,7 @@ enum bp_result bios_parser_get_ddc_info_for_i2c_line(struct bios_parser *bp,
 
 	return BP_RESULT_NORECORD;
 }
+#endif
 
 enum bp_result dc_bios_get_hpd_info(struct dc_bios *dcb,
 				    struct graphics_object_id id,
@@ -4353,6 +4358,7 @@ static bool bios_parser_construct(
 	uint16_t *rom_header_offset = NULL;
 	ATOM_ROM_HEADER *rom_header = NULL;
 	ATOM_OBJECT_HEADER *object_info_tbl;
+	struct atom_data_revision tbl_rev = {0};
 
 	if (!init)
 		return false;
@@ -4377,6 +4383,10 @@ static bool bios_parser_construct(
 	if (!rom_header)
 		return false;
 
+	get_atom_data_table_revision(&rom_header->sHeader, &tbl_rev);
+	if (tbl_rev.major >= 2 && tbl_rev.minor >= 2)
+		return false;
+
 	bp->master_data_tbl =
 	GET_IMAGE(ATOM_MASTER_DATA_TABLE,
 		rom_header->usMasterDataTableOffset);
diff --git a/drivers/gpu/drm/amd/dal/dc/bios/bios_parser.h b/drivers/gpu/drm/amd/dal/dc/bios/bios_parser.h
index cca65e1..2cf9911 100644
--- a/drivers/gpu/drm/amd/dal/dc/bios/bios_parser.h
+++ b/drivers/gpu/drm/amd/dal/dc/bios/bios_parser.h
@@ -26,56 +26,8 @@
 #ifndef __DAL_BIOS_PARSER_H__
 #define __DAL_BIOS_PARSER_H__
 
-#include "dc_bios_types.h"
-#include "bios_parser_helper.h"
-
-struct atom_data_revision {
-	uint32_t major;
-	uint32_t minor;
-};
-
-struct object_info_table {
-	struct atom_data_revision revision;
-	union {
-		ATOM_OBJECT_HEADER *v1_1;
-		ATOM_OBJECT_HEADER_V3 *v1_3;
-	};
-};
-
-enum spread_spectrum_id {
-	SS_ID_UNKNOWN = 0,
-	SS_ID_DP1 = 0xf1,
-	SS_ID_DP2 = 0xf2,
-	SS_ID_LVLINK_2700MHZ = 0xf3,
-	SS_ID_LVLINK_1620MHZ = 0xf4
-};
-
-struct bios_parser {
-	struct dc_context *ctx;
-
-	struct object_info_table object_info_tbl;
-	uint32_t object_info_tbl_offset;
-	ATOM_MASTER_DATA_TABLE *master_data_tbl;
-
-	uint8_t *bios;
-	uint32_t bios_size;
-
-#if defined(CONFIG_DRM_AMD_DAL_VBIOS_PRESENT)
-	const struct bios_parser_helper *bios_helper;
-#endif /* CONFIG_DRM_AMD_DAL_VBIOS_PRESENT */
-
-	const struct command_table_helper *cmd_helper;
-	struct cmd_tbl cmd_tbl;
-
-	uint8_t *bios_local_image;
-	enum lcd_scale lcd_scale;
-
-	bool remap_device_tags;
-	bool headless_no_opm;
-};
-
-/* Bios Parser from DC Bios */
-#define BP_FROM_DCB(dc_bios) \
-	(struct bios_parser *)(dc_bios)
+struct dc_bios *bios_parser_create(
+        struct bp_init_data *init,
+        enum dce_version dce_version);
 
 #endif
diff --git a/drivers/gpu/drm/amd/dal/dc/bios/bios_parser_helper.c b/drivers/gpu/drm/amd/dal/dc/bios/bios_parser_helper.c
index 63f753a..9da523c 100644
--- a/drivers/gpu/drm/amd/dal/dc/bios/bios_parser_helper.c
+++ b/drivers/gpu/drm/amd/dal/dc/bios/bios_parser_helper.c
@@ -31,7 +31,7 @@
 #include "bios_parser_helper.h"
 #include "command_table_helper.h"
 #include "command_table.h"
-#include "bios_parser.h"
+#include "bios_parser_types_internal.h"
 
 bool dal_bios_parser_init_bios_helper(
 	struct bios_parser *bp,
diff --git a/drivers/gpu/drm/amd/dal/dc/bios/bios_parser_interface.c b/drivers/gpu/drm/amd/dal/dc/bios/bios_parser_interface.c
new file mode 100644
index 0000000..42272c3
--- /dev/null
+++ b/drivers/gpu/drm/amd/dal/dc/bios/bios_parser_interface.c
@@ -0,0 +1,50 @@
+/*
+ * Copyright 2012-15 Advanced Micro Devices, Inc.
+ *
+ * Permission is hereby granted, free of charge, to any person obtaining a
+ * copy of this software and associated documentation files (the "Software"),
+ * to deal in the Software without restriction, including without limitation
+ * the rights to use, copy, modify, merge, publish, distribute, sublicense,
+ * and/or sell copies of the Software, and to permit persons to whom the
+ * Software is furnished to do so, subject to the following conditions:
+ *
+ * The above copyright notice and this permission notice shall be included in
+ * all copies or substantial portions of the Software.
+ *
+ * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL
+ * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR
+ * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,
+ * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
+ * OTHER DEALINGS IN THE SOFTWARE.
+ *
+ * Authors: AMD
+ *
+ */
+
+#include "dm_services.h"
+#include "include/logger_interface.h"
+
+#include "bios_parser_interface.h"
+#include "bios_parser.h"
+
+
+struct dc_bios *dal_bios_parser_create(
+	struct bp_init_data *init,
+	enum dce_version dce_version)
+{
+	struct dc_bios *bios = NULL;
+
+	bios = bios_parser_create(init, dce_version);
+
+	return bios;
+}
+
+void dal_bios_parser_destroy(struct dc_bios **dcb)
+{
+	struct dc_bios *bios = *dcb;
+
+	bios->funcs->bios_parser_destroy(dcb);
+}
+
diff --git a/drivers/gpu/drm/amd/dal/dc/bios/bios_parser_types_internal.h b/drivers/gpu/drm/amd/dal/dc/bios/bios_parser_types_internal.h
new file mode 100644
index 0000000..e710f76
--- /dev/null
+++ b/drivers/gpu/drm/amd/dal/dc/bios/bios_parser_types_internal.h
@@ -0,0 +1,82 @@
+/*
+ * Copyright 2012-15 Advanced Micro Devices, Inc.
+ *
+ * Permission is hereby granted, free of charge, to any person obtaining a
+ * copy of this software and associated documentation files (the "Software"),
+ * to deal in the Software without restriction, including without limitation
+ * the rights to use, copy, modify, merge, publish, distribute, sublicense,
+ * and/or sell copies of the Software, and to permit persons to whom the
+ * Software is furnished to do so, subject to the following conditions:
+ *
+ * The above copyright notice and this permission notice shall be included in
+ * all copies or substantial portions of the Software.
+ *
+ * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL
+ * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR
+ * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,
+ * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
+ * OTHER DEALINGS IN THE SOFTWARE.
+ *
+ * Authors: AMD
+ *
+ */
+
+#ifndef __DAL_BIOS_PARSER_TYPES_BIOS_H__
+#define __DAL_BIOS_PARSER_TYPES_BIOS_H__
+
+#include "dc_bios_types.h"
+#include "bios_parser_helper.h"
+
+struct atom_data_revision {
+	uint32_t major;
+	uint32_t minor;
+};
+
+struct object_info_table {
+	struct atom_data_revision revision;
+	union {
+		ATOM_OBJECT_HEADER *v1_1;
+		ATOM_OBJECT_HEADER_V3 *v1_3;
+	};
+};
+
+enum spread_spectrum_id {
+	SS_ID_UNKNOWN = 0,
+	SS_ID_DP1 = 0xf1,
+	SS_ID_DP2 = 0xf2,
+	SS_ID_LVLINK_2700MHZ = 0xf3,
+	SS_ID_LVLINK_1620MHZ = 0xf4
+};
+
+struct bios_parser {
+	struct dc_bios base;
+	struct dc_context *ctx;
+
+	struct object_info_table object_info_tbl;
+	uint32_t object_info_tbl_offset;
+	ATOM_MASTER_DATA_TABLE *master_data_tbl;
+
+	uint8_t *bios;
+	uint32_t bios_size;
+
+#if defined(CONFIG_DRM_AMD_DAL_VBIOS_PRESENT)
+	const struct bios_parser_helper *bios_helper;
+#endif /* CONFIG_DRM_AMD_DAL_VBIOS_PRESENT */
+
+	const struct command_table_helper *cmd_helper;
+	struct cmd_tbl cmd_tbl;
+
+	uint8_t *bios_local_image;
+	enum lcd_scale lcd_scale;
+
+	bool remap_device_tags;
+	bool headless_no_opm;
+};
+
+/* Bios Parser from DC Bios */
+#define BP_FROM_DCB(dc_bios) \
+	container_of(dc_bios, struct bios_parser, base)
+
+#endif
diff --git a/drivers/gpu/drm/amd/dal/dc/bios/command_table.c b/drivers/gpu/drm/amd/dal/dc/bios/command_table.c
index 06798cd..81fbb47 100644
--- a/drivers/gpu/drm/amd/dal/dc/bios/command_table.c
+++ b/drivers/gpu/drm/amd/dal/dc/bios/command_table.c
@@ -32,7 +32,7 @@
 #include "command_table.h"
 #include "command_table_helper.h"
 #include "bios_parser_helper.h"
-#include "bios_parser.h"
+#include "bios_parser_types_internal.h"
 
 #define EXEC_BIOS_CMD_TABLE(command, params)\
 	(cgs_atom_exec_cmd_table(bp->ctx->cgs_device, \
diff --git a/drivers/gpu/drm/amd/dal/include/bios_parser_interface.h b/drivers/gpu/drm/amd/dal/include/bios_parser_interface.h
index 5f1c567..7c0e1bf 100644
--- a/drivers/gpu/drm/amd/dal/include/bios_parser_interface.h
+++ b/drivers/gpu/drm/amd/dal/include/bios_parser_interface.h
@@ -40,7 +40,6 @@ struct dc_bios *dal_bios_parser_create(
 	struct bp_init_data *init,
 	enum dce_version dce_version);
 
-void dal_bios_parser_destroy(
-	struct dc_bios **dcb);
+void dal_bios_parser_destroy(struct dc_bios **dcb);
 
 #endif /* __DAL_BIOS_PARSER_INTERFACE_H__ */
diff --git a/drivers/gpu/drm/amd/dal/include/bios_parser_types.h b/drivers/gpu/drm/amd/dal/include/bios_parser_types.h
index 83766fe..f986012 100644
--- a/drivers/gpu/drm/amd/dal/include/bios_parser_types.h
+++ b/drivers/gpu/drm/amd/dal/include/bios_parser_types.h
@@ -316,6 +316,8 @@ struct bp_spread_spectrum_parameters {
 struct bp_encoder_cap_info {
 	uint32_t DP_HBR2_CAP:1;
 	uint32_t DP_HBR2_EN:1;
+	uint32_t DP_HBR3_EN:1;
+	uint32_t HDMI_6GB_EN:1;
 	uint32_t RESERVED:30;
 };
 
diff --git a/drivers/gpu/drm/amd/dal/include/grph_object_ctrl_defs.h b/drivers/gpu/drm/amd/dal/include/grph_object_ctrl_defs.h
index 6bb3d3a..ab0a972 100644
--- a/drivers/gpu/drm/amd/dal/include/grph_object_ctrl_defs.h
+++ b/drivers/gpu/drm/amd/dal/include/grph_object_ctrl_defs.h
@@ -161,6 +161,7 @@ struct embedded_panel_info {
 	struct supported_refresh_rate supported_rr;
 	uint32_t drr_enabled;
 	uint32_t min_drr_refresh_rate;
+	bool realtek_eDPToLVDS;
 };
 
 struct firmware_info {
@@ -182,6 +183,12 @@ struct firmware_info {
 	uint32_t smu_gpu_pll_output_freq; /* in KHz */
 	uint8_t min_allowed_bl_level;
 	uint8_t remote_display_config;
+	uint32_t default_memory_clk; /* in KHz */
+	uint32_t default_engine_clk; /* in KHz */
+	uint32_t dp_phy_ref_clk; /* in KHz - DCE12 only */
+	uint32_t i2c_engine_ref_clk; /* in KHz - DCE12 only */
+
+
 };
 
 struct step_and_delay_info {
-- 
2.7.4

