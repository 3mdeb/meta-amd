From 0b1a6e1962ce24adfc08bf86dc19a2a055a147b3 Mon Sep 17 00:00:00 2001
From: Yongqiang Sun <yongqiang.sun@amd.com>
Date: Tue, 23 Aug 2016 14:15:20 -0400
Subject: [PATCH 0840/1722] drm/amd/dal: only update stream src in
 serviewports.

Signed-off-by: Yongqiang Sun <yongqiang.sun@amd.com>
Acked-by: Harry Wentland <harry.wentland@amd.com>
Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
Signed-off-by: Kalyan Alle <kalyan.alle@amd.com>
---
 drivers/gpu/drm/amd/dal/dc/core/dc.c     | 22 ++++++++++++----------
 drivers/gpu/drm/amd/dal/dc/dm_services.h |  1 -
 2 files changed, 12 insertions(+), 11 deletions(-)

diff --git a/drivers/gpu/drm/amd/dal/dc/core/dc.c b/drivers/gpu/drm/amd/dal/dc/core/dc.c
index e79add5..dc63548 100644
--- a/drivers/gpu/drm/amd/dal/dc/core/dc.c
+++ b/drivers/gpu/drm/amd/dal/dc/core/dc.c
@@ -1195,22 +1195,24 @@ val_ctx_fail:
  
         for (i = 0; i < new_surface_count; i++)
                 for (j = 0; j < context->res_ctx.pool->pipe_count; j++) {
-                        struct pipe_ctx *pipe_ctx = &context->res_ctx.pipe_ctx[j];
- 
-                        if (pipe_ctx->surface !=
+                        struct pipe_ctx *old_pipe_ctx = &core_dc->current_context->res_ctx.pipe_ctx[j]; 
+                        
+			if (pipe_ctx->surface !=
                                         DC_SURFACE_TO_CORE(new_surfaces[i]))
                                 continue;
  
-                        if (surface_needs_programming) {
-                                resource_build_scaling_params(new_surfaces[i], pipe_ctx);
- 
-                                if (dc->debug.surface_visual_confirm) {
-                                        pipe_ctx->scl_data.recout.height -= 2;
-                                        pipe_ctx->scl_data.recout.width -= 2;
-                                }
+                        resource_build_scaling_params(new_surfaces[i], pipe_ctx); 
  
+                        if (dc->debug.surface_visual_confirm) {
+                                pipe_ctx->scl_data.recout.height -= 2;
+                                pipe_ctx->scl_data.recout.width -= 2; 
                         }
 
+                        if (memcmp(&pipe_ctx->scl_data,
+                                        &old_pipe_ctx->scl_data,
+                                        sizeof(pipe_ctx->scl_data)))
+                                surface_needs_programming = true;
+ 
                         core_dc->hwss.pipe_control_lock(
                                         core_dc->ctx,
                                         pipe_ctx->pipe_idx,
diff --git a/drivers/gpu/drm/amd/dal/dc/dm_services.h b/drivers/gpu/drm/amd/dal/dc/dm_services.h
index bbb44d0..02dfc75 100644
--- a/drivers/gpu/drm/amd/dal/dc/dm_services.h
+++ b/drivers/gpu/drm/amd/dal/dc/dm_services.h
@@ -242,7 +242,6 @@ bool dm_get_platform_info(
 struct persistent_data_flag {
 	bool save_per_link;
 	bool save_per_edid;
-	bool save_per_mode;
 };
 
 /* Call to write data in registry editor for persistent data storage.
-- 
2.7.4

