From 3c20012bb5c15fd88b312dfb552c0b3e1363f580 Mon Sep 17 00:00:00 2001
From: Dmytro Laktyushkin <Dmytro.Laktyushkin@amd.com>
Date: Thu, 21 Jul 2016 17:48:13 -0400
Subject: [PATCH 0662/1722] drm/amd/dal: lower mpo bandwidth when possible

Signed-off-by: Dmytro Laktyushkin <Dmytro.Laktyushkin@amd.com>
Acked-by: Harry Wentland <harry.wentland@amd.com>
Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
Signed-off-by: Kalyan Alle <kalyan.alle@amd.com>
---
 drivers/gpu/drm/amd/dal/dc/core/dc.c | 23 ++++++++++++++++++++---
 1 file changed, 20 insertions(+), 3 deletions(-)

diff --git a/drivers/gpu/drm/amd/dal/dc/core/dc.c b/drivers/gpu/drm/amd/dal/dc/core/dc.c
index a5a411d..995fcad 100644
--- a/drivers/gpu/drm/amd/dal/dc/core/dc.c
+++ b/drivers/gpu/drm/amd/dal/dc/core/dc.c
@@ -1000,7 +1000,7 @@ struct validate_context *dc_pre_commit_surfaces_to_target(
         }
         if (prev_disp_clk < context->bw_results.dispclk_khz) {
 		pplib_apply_display_requirements(core_dc, context,
-                                                                &context->pp_display_cfg);
+                                                &context->pp_display_cfg);
                 core_dc->hwss.set_display_clock(context);
 	}
 
@@ -1044,12 +1044,29 @@ bool dc_post_commit_surfaces_to_target(
                 struct dc *dc,
                 struct validate_context *context)
 {
+        int i;
         struct core_dc *core_dc = DC_TO_CORE(dc);
-        /* TODO: lower display clock if needed*/
  
         if (context->locked)
-                dc_isr_commit_surfaces_to_target(dc, context);
+                return false;
+ 
+        for (i = 0; i < context->res_ctx.pool->pipe_count; i++) {
+                if (core_dc->current_context->res_ctx.pipe_ctx[i].stream != NULL
+                                && context->res_ctx.pipe_ctx[i].stream == NULL) {
+                        core_dc->hwss.enable_display_power_gating(
+                                core_dc->ctx, i, core_dc->ctx->dc_bios,
+                                PIPE_GATING_CONTROL_ENABLE);
+                        memset(&context->res_ctx.pipe_ctx[i], 0, sizeof(struct pipe_ctx));
+                }
+        }
  
+        if (core_dc->current_context->bw_results.dispclk_khz
+                        > context->bw_results.dispclk_khz) {
+                pplib_apply_display_requirements(
+                                core_dc, context, &context->pp_display_cfg);
+                core_dc->hwss.set_display_clock(context);
+        }
+  
 	resource_validate_ctx_destruct(core_dc->current_context);
 	dm_free(core_dc->current_context);
 	core_dc->current_context = context;
-- 
2.7.4

