From 8f740dd199c5cf1a8ace48380be2986a9185e7fc Mon Sep 17 00:00:00 2001
From: Awais Belal <awais_belal@mentor.com>
Date: Wed, 13 Dec 2017 15:08:36 +0500
Subject: [PATCH] configure.ac: for llvm-config to report correct libdir

In cross compiling environments llvm-config messes up
as it reports native environment because it is built
for the host system. Hence if the target system and
host system have different baselibs the llvm-config
fails to find libraries for the target system
appropriately.
This now forces llvm-config to use the target specific
libdir.

Signed-off-by: Awais Belal <awais_belal@mentor.com>
---
 configure.ac | 6 +++---
 1 file changed, 3 insertions(+), 3 deletions(-)

diff --git a/configure.ac b/configure.ac
index 82b76d2..d132523 100644
--- a/configure.ac
+++ b/configure.ac
@@ -1035,7 +1035,7 @@ llvm_set_environment_variables() {
         LLVM_VERSION=`$LLVM_CONFIG --version | cut -c1-5`
         LLVM_CPPFLAGS=`strip_unwanted_llvm_flags "$LLVM_CONFIG --cppflags"`
         LLVM_INCLUDEDIR=`$LLVM_CONFIG --includedir`
-        LLVM_LIBDIR=`$LLVM_CONFIG --libdir`
+        LLVM_LIBDIR=${llvm_prefix}
 
         # We need to respect LLVM_CPPFLAGS when compiling LLVM headers.
         save_CFLAGS="$CFLAGS"
@@ -2672,10 +2672,10 @@ if test "x$enable_llvm" = xyes; then
     dnl this was causing the same libraries to be appear multiple times
     dnl in LLVM_LIBS.
 
-    if ! $LLVM_CONFIG --libs ${LLVM_COMPONENTS} >/dev/null; then
+    if ! $LLVM_CONFIG --tgtlibdir ${llvm_prefix} --libs ${LLVM_COMPONENTS} >/dev/null; then
        AC_MSG_ERROR([Calling ${LLVM_CONFIG} failed])
     fi
-    LLVM_LIBS="`$LLVM_CONFIG --libs ${LLVM_COMPONENTS}`"
+    LLVM_LIBS="`$LLVM_CONFIG --tgtlibdir ${llvm_prefix} --libs ${LLVM_COMPONENTS}`"
 
     dnl llvm-config may not give the right answer when llvm is a built as a
     dnl single shared library, so we must work the library name out for
-- 
2.11.1

