From 1d4f3e2b377870a6e5968fba444eee8804983ed8 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Michel=20D=C3=A4nzer?= <michel.daenzer@amd.com>
Date: Tue, 14 Jul 2015 12:42:19 +0900
Subject: [PATCH 54/55] amdgpu: Use drmIoctl in amdgpu_ioctl_wait_cs
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

This is safe now because the ioctl uses an absolute timeout.

This prevents amdgpu_cs_query_fence_status from returning early e.g.
when a signal is delivered, which in turn caused Mesa winsys code to
assume a BO was idle when it actually wasn't yet.

Reviewed-by: Christian KÃ¶nig <christian.koenig@amd.com>
Signed-off-by: Arindam Nath <arindam.nath@amd.com>
---
 amdgpu/amdgpu_cs.c | 8 ++------
 1 file changed, 2 insertions(+), 6 deletions(-)

diff --git a/amdgpu/amdgpu_cs.c b/amdgpu/amdgpu_cs.c
index 91a7b05..d9aa22d 100644
--- a/amdgpu/amdgpu_cs.c
+++ b/amdgpu/amdgpu_cs.c
@@ -367,12 +367,8 @@ static int amdgpu_ioctl_wait_cs(amdgpu_context_handle context,
 	else
 		args.in.timeout = amdgpu_cs_calculate_timeout(timeout_ns);
 
-	/* Handle errors manually here because of timeout */
-	r = ioctl(dev->fd, DRM_IOCTL_AMDGPU_WAIT_CS, &args);
-	if (r == -1 && (errno == EINTR || errno == EAGAIN)) {
-		*busy = true;
-		return 0;
-	} else if (r)
+	r = drmIoctl(dev->fd, DRM_IOCTL_AMDGPU_WAIT_CS, &args);
+	if (r)
 		return -errno;
 
 	*busy = args.out.status;
-- 
1.9.1

