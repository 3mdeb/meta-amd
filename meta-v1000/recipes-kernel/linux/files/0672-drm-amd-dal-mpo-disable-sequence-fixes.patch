From 0518ee7652fe602fc2165b9d5fa4e917caf8e0af Mon Sep 17 00:00:00 2001
From: Dmytro Laktyushkin <Dmytro.Laktyushkin@amd.com>
Date: Wed, 27 Jul 2016 16:11:41 -0400
Subject: [PATCH 0672/1722] drm/amd/dal: mpo disable sequence fixes

Signed-off-by: Dmytro Laktyushkin <Dmytro.Laktyushkin@amd.com>
Acked-by: Harry Wentland <harry.wentland@amd.com>
Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
Signed-off-by: Kalyan Alle <kalyan.alle@amd.com>
---
 drivers/gpu/drm/amd/dal/dc/core/dc.c               | 26 ++--------------------
 .../gpu/drm/amd/dal/dc/dce110/dce110_transform.c   | 13 +++++++++++
 .../gpu/drm/amd/dal/dc/dce110/dce110_transform_v.c | 12 ++++++++++
 drivers/gpu/drm/amd/dal/dc/dce80/dce80_transform.c |  6 +++++
 drivers/gpu/drm/amd/dal/dc/inc/hw/transform.h      |  3 +++
 5 files changed, 36 insertions(+), 24 deletions(-)

diff --git a/drivers/gpu/drm/amd/dal/dc/core/dc.c b/drivers/gpu/drm/amd/dal/dc/core/dc.c
index 112b30c..c1915ac 100644
--- a/drivers/gpu/drm/amd/dal/dc/core/dc.c
+++ b/drivers/gpu/drm/amd/dal/dc/core/dc.c
@@ -1050,6 +1050,8 @@ bool dc_post_commit_surfaces_to_target(
                         core_dc->hwss.enable_display_power_gating(
                                 core_dc->ctx, i, core_dc->ctx->dc_bios,
                                 PIPE_GATING_CONTROL_ENABLE);
+                        context->res_ctx.pipe_ctx[i].xfm->funcs->transform_reset(
+                                        context->res_ctx.pipe_ctx[i].xfm);
                         memset(&context->res_ctx.pipe_ctx[i], 0, sizeof(struct pipe_ctx));
                 }
         }
@@ -1214,33 +1216,9 @@ void dc_flip_surface_addrs_on_context(
                         ctx_surface->public.address = flip_addrs[i].address;
                         ctx_surface->public.flip_immediate = flip_addrs[i].flip_immediate;
  
-                        if (!ctx_surface->public.flip_immediate)
-                                core_dc->hwss.pipe_control_lock(
-                                                core_dc->ctx,
-                                                pipe_ctx->pipe_idx,
-                                                PIPE_LOCK_CONTROL_SURFACE |
-                                                PIPE_LOCK_CONTROL_MODE,
-                                                true);
- 
                         core_dc->hwss.update_plane_addr(core_dc, pipe_ctx);
                 }
  
-        for (j = pipe_count - 1; j >= 0; j--)
-                for (i = count - 1; i >= 0; i--) {
-                        struct pipe_ctx *pipe_ctx =
-                                &context->res_ctx.pipe_ctx[j];
-                        struct core_surface *ctx_surface = pipe_ctx->surface;
- 
-                        if (DC_SURFACE_TO_CORE(surfaces[i]) != ctx_surface)
-                                continue;
- 
-                        if (!ctx_surface->public.flip_immediate)
-                                core_dc->hwss.pipe_control_lock(
-                                                core_dc->ctx,
-                                                pipe_ctx->pipe_idx,
-                                                PIPE_LOCK_CONTROL_SURFACE,
-                                                false);
-                }
 }
 
 void dc_flip_surface_addrs(
diff --git a/drivers/gpu/drm/amd/dal/dc/dce110/dce110_transform.c b/drivers/gpu/drm/amd/dal/dc/dce110/dce110_transform.c
index 24d159e..232dccb 100644
--- a/drivers/gpu/drm/amd/dal/dc/dce110/dce110_transform.c
+++ b/drivers/gpu/drm/amd/dal/dc/dce110/dce110_transform.c
@@ -61,7 +61,20 @@ bool dce110_transform_get_optimal_number_of_taps(
 
 }
 
+static void dce110_transform_reset(struct transform *xfm)
+{
+	struct dce110_transform *xfm110 = TO_DCE110_TRANSFORM(xfm);
+
+	xfm110->filter_h = NULL;
+	xfm110->filter_v = NULL;
+	xfm110->filter_h_c = NULL;
+	xfm110->filter_v_c = NULL;
+}
+
+
 static const struct transform_funcs dce110_transform_funcs = {
+	.transform_reset =
+			dce110_transform_reset,
 	.transform_power_up =
 		dce110_transform_power_up,
 	.transform_set_scaler =
diff --git a/drivers/gpu/drm/amd/dal/dc/dce110/dce110_transform_v.c b/drivers/gpu/drm/amd/dal/dc/dce110/dce110_transform_v.c
index 56b3735d..08dca03 100644
--- a/drivers/gpu/drm/amd/dal/dc/dce110/dce110_transform_v.c
+++ b/drivers/gpu/drm/amd/dal/dc/dce110/dce110_transform_v.c
@@ -808,7 +808,19 @@ static bool dce110_transform_v_power_up_line_buffer(struct transform *xfm)
 	return true;
 }
 
+static void dce110_transform_v_reset(struct transform *xfm)
+{
+	struct dce110_transform *xfm110 = TO_DCE110_TRANSFORM(xfm);
+
+	xfm110->filter_h = NULL;
+	xfm110->filter_v = NULL;
+	xfm110->filter_h_c = NULL;
+	xfm110->filter_v_c = NULL;
+}
+
 static const struct transform_funcs dce110_transform_v_funcs = {
+	.transform_reset =
+			dce110_transform_v_reset,
 	.transform_power_up =
 		dce110_transform_v_power_up_line_buffer,
 	.transform_set_scaler =
diff --git a/drivers/gpu/drm/amd/dal/dc/dce80/dce80_transform.c b/drivers/gpu/drm/amd/dal/dc/dce80/dce80_transform.c
index 9f5336d..a37ecb8 100644
--- a/drivers/gpu/drm/amd/dal/dc/dce80/dce80_transform.c
+++ b/drivers/gpu/drm/amd/dal/dc/dce80/dce80_transform.c
@@ -55,7 +55,13 @@ bool dce80_transform_get_optimal_number_of_taps(
 	return true;
 }
 
+static void dce80_transform_reset(struct transform *xfm)
+{
+}
+
+
 static const struct transform_funcs dce80_transform_funcs = {
+	.transform_reset = dce80_transform_reset,
 	.transform_power_up =
 		dce80_transform_power_up,
 	.transform_set_scaler =
diff --git a/drivers/gpu/drm/amd/dal/dc/inc/hw/transform.h b/drivers/gpu/drm/amd/dal/dc/inc/hw/transform.h
index b0fa06a..8053455 100644
--- a/drivers/gpu/drm/amd/dal/dc/inc/hw/transform.h
+++ b/drivers/gpu/drm/amd/dal/dc/inc/hw/transform.h
@@ -164,6 +164,9 @@ struct line_buffer_params {
 };
 
 struct transform_funcs {
+	void (*transform_reset)(
+		struct transform *xfm);
+
 	bool (*transform_power_up)(
 		struct transform *xfm);
 
-- 
2.7.4

