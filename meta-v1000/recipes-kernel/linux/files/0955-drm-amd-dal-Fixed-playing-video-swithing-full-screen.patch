From 9eae8254a9c4c8df7185799dc148482fa7864109 Mon Sep 17 00:00:00 2001
From: Yongqiang Sun <yongqiang.sun@amd.com>
Date: Wed, 31 Aug 2016 14:33:33 -0400
Subject: [PATCH 0955/1722] drm/amd/dal: Fixed playing video swithing full
 screen crash.

Change-Id: Ifff969cb0a514a1eac2728ce6d0d87407b6aebd1
Signed-off-by: Yongqiang Sun <yongqiang.sun@amd.com>
Acked-by: Harry Wentland <harry.wentland@amd.com>
Signed-off-by: Kalyan Alle <kalyan.alle@amd.com>
---
 drivers/gpu/drm/amd/dal/dc/core/dc.c | 41 ++++++++++++++++++++++--------------
 1 file changed, 25 insertions(+), 16 deletions(-)

diff --git a/drivers/gpu/drm/amd/dal/dc/core/dc.c b/drivers/gpu/drm/amd/dal/dc/core/dc.c
index 8e2976a..b0ff7b1 100644
--- a/drivers/gpu/drm/amd/dal/dc/core/dc.c
+++ b/drivers/gpu/drm/amd/dal/dc/core/dc.c
@@ -1387,6 +1387,17 @@ void dc_update_surfaces_for_target(struct dc *dc, struct dc_surface_update *upda
 			BREAK_TO_DEBUGGER();
 			return;
 		}
+
+		for (i = 0; i < surface_count; i++) {
+			struct core_surface *surface = DC_SURFACE_TO_CORE(updates[i].surface);
+			struct pipe_ctx *pipe_ctx = find_pipe_ctx_by_surface(context, surface);
+
+			core_dc->hwss.pipe_control_lock(
+						core_dc->ctx,
+						pipe_ctx->pipe_idx,
+						PIPE_LOCK_CONTROL_SURFACE,
+						true);
+		}
 	}
 
 	for (i = 0; i < surface_count; i++) {
@@ -1427,26 +1438,10 @@ void dc_update_surfaces_for_target(struct dc *dc, struct dc_surface_update *upda
 				pipe_ctx->scl_data.recout.height -= 2;
 				pipe_ctx->scl_data.recout.width -= 2;
 			}
-
-			core_dc->hwss.pipe_control_lock(
-					core_dc->ctx,
-					pipe_ctx->pipe_idx,
-					PIPE_LOCK_CONTROL_SURFACE,
-					true);
-
 			core_dc->hwss.update_plane_addr(core_dc, pipe_ctx);
 
 			core_dc->hwss.apply_ctx_to_surface(core_dc, context);
 
-			core_dc->hwss.pipe_control_lock(
-					core_dc->ctx,
-					pipe_ctx->pipe_idx,
-					PIPE_LOCK_CONTROL_GRAPHICS |
-					PIPE_LOCK_CONTROL_SCL |
-					PIPE_LOCK_CONTROL_BLENDER |
-					PIPE_LOCK_CONTROL_SURFACE,
-					false);
-
 		} else if (updates[i].flip_addr) {
 			surface->public.address = updates[i].flip_addr->address;
 			surface->public.flip_immediate = updates[i].flip_addr->flip_immediate;
@@ -1459,6 +1454,20 @@ void dc_update_surfaces_for_target(struct dc *dc, struct dc_surface_update *upda
 	}
 
 	if (dc_target) {
+
+		for (i = context->res_ctx.pool->pipe_count - 1; i >= 0; i--) {
+			struct pipe_ctx *pipe_ctx = &context->res_ctx.pipe_ctx[i];
+
+			core_dc->hwss.pipe_control_lock(
+								core_dc->ctx,
+								pipe_ctx->pipe_idx,
+								PIPE_LOCK_CONTROL_GRAPHICS |
+								PIPE_LOCK_CONTROL_SCL |
+								PIPE_LOCK_CONTROL_BLENDER |
+								PIPE_LOCK_CONTROL_SURFACE,
+								false);
+		}
+
 		core_dc->temp_flip_context = core_dc->current_context;
 		core_dc->current_context = context;
 	}
-- 
2.7.4

