From 15a13eb13c61f5430427c77d1515bebaa3693628 Mon Sep 17 00:00:00 2001
From: Hersen Wu <hersenxs.wu@amd.com>
Date: Tue, 7 Jun 2016 11:42:07 -0400
Subject: [PATCH 0564/1722] drm/amd/dal: Make update_plane_surface DCE specific

Signed-off-by: Hersen Wu <hersenxs.wu@amd.com>
Acked-by: Harry Wentland <harry.wentland@amd.com>
Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
Signed-off-by: Kalyan Alle <kalyan.alle@amd.com>
---
 drivers/gpu/drm/amd/dal/dc/core/dc.c               | 15 ++------------
 .../drm/amd/dal/dc/dce110/dce110_hw_sequencer.c    | 24 +++++++++++++++++++++-
 drivers/gpu/drm/amd/dal/dc/inc/hw_sequencer.h      |  6 ++++++
 3 files changed, 31 insertions(+), 14 deletions(-)

diff --git a/drivers/gpu/drm/amd/dal/dc/core/dc.c b/drivers/gpu/drm/amd/dal/dc/core/dc.c
index 8b51afa..4699f26 100644
--- a/drivers/gpu/drm/amd/dal/dc/core/dc.c
+++ b/drivers/gpu/drm/amd/dal/dc/core/dc.c
@@ -1050,19 +1050,8 @@ bool dc_update_surfaces_for_target(
 				new_surfaces[i], &context->res_ctx.pipe_ctx[j]);
 		}
 
-	for (i = 0; i < new_surface_count; i++)
-		for (j = 0; j < context->res_ctx.pool.pipe_count; j++) {
-			struct pipe_ctx *pipe_ctx =
-						&context->res_ctx.pipe_ctx[j];
-
-			if (pipe_ctx->surface !=
-					DC_SURFACE_TO_CORE(new_surfaces[i]))
-				continue;
-
-			core_dc->hwss.set_plane_config(
-				core_dc, pipe_ctx, &context->res_ctx);
-		}
-
+        core_dc->hwss.update_plane_surface(core_dc, context, new_surfaces,
+                        new_surface_count);
 	return true;
 }
 
diff --git a/drivers/gpu/drm/amd/dal/dc/dce110/dce110_hw_sequencer.c b/drivers/gpu/drm/amd/dal/dc/dce110/dce110_hw_sequencer.c
index d0c1058..9dd2e2e 100644
--- a/drivers/gpu/drm/amd/dal/dc/dce110/dce110_hw_sequencer.c
+++ b/drivers/gpu/drm/amd/dal/dc/dce110/dce110_hw_sequencer.c
@@ -897,7 +897,6 @@ static void enable_accelerated_mode(struct core_dc *dc)
 	power_down_all_hw_blocks(dc);
 
 	disable_vga_and_power_gate_all_controllers(dc);
-
 	dce110_set_scratch_acc_mode_change(dc->ctx);
 }
 
@@ -1708,12 +1707,35 @@ static enum dc_status apply_ctx_to_surface(
 	return DC_OK;
 }
 
+static void update_plane_surface(
+	struct core_dc *dc,
+	struct validate_context *context,
+	struct dc_surface *new_surfaces[],
+	uint8_t new_surface_count)
+{
+	int i, j;
+
+	for (i = 0; i < new_surface_count; i++)
+		for (j = 0; j < context->res_ctx.pool->pipe_count; j++) {
+			struct pipe_ctx *pipe_ctx =
+						&context->res_ctx.pipe_ctx[j];
+
+			if (pipe_ctx->surface !=
+					DC_SURFACE_TO_CORE(new_surfaces[i]))
+				continue;
+
+			dc->hwss.set_plane_config(
+				dc, pipe_ctx, &context->res_ctx);
+		}
+}
+
 static const struct hw_sequencer_funcs dce110_funcs = {
 	.init_hw = init_hw,
 	.apply_ctx_to_hw = apply_ctx_to_hw,
 	.apply_ctx_to_surface = apply_ctx_to_surface,
 	.set_plane_config = set_plane_config,
 	.update_plane_addr = update_plane_addr,
+	.update_plane_surface = update_plane_surface,
 	.set_gamma_correction = set_gamma_ramp,
 	.power_down = power_down,
 	.enable_accelerated_mode = enable_accelerated_mode,
diff --git a/drivers/gpu/drm/amd/dal/dc/inc/hw_sequencer.h b/drivers/gpu/drm/amd/dal/dc/inc/hw_sequencer.h
index de607df..53b3f82 100644
--- a/drivers/gpu/drm/amd/dal/dc/inc/hw_sequencer.h
+++ b/drivers/gpu/drm/amd/dal/dc/inc/hw_sequencer.h
@@ -64,6 +64,12 @@ struct hw_sequencer_funcs {
 		struct core_dc *dc,
 		struct pipe_ctx *pipe_ctx);
 
+	void (*update_plane_surface)(
+		struct core_dc *dc,
+		struct validate_context *context,
+		struct dc_surface *new_surfaces[],
+		uint8_t new_surface_count);
+
 	bool (*set_gamma_correction)(
 				struct input_pixel_processor *ipp,
 				struct output_pixel_processor *opp,
-- 
2.7.4

