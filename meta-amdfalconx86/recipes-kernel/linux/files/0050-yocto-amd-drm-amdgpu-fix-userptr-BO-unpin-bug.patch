From 5605868b56405c363e58ec2b3dd237f61237d251 Mon Sep 17 00:00:00 2001
From: "monk.liu" <monk.liu@amd.com>
Date: Thu, 30 Apr 2015 15:23:04 +0800
Subject: [PATCH 163/343] drm/amdgpu: fix userptr BO unpin bug
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

sg could point to array of contigiouse page*, only free page could lead
to memory leak.

Signed-off-by: monk.liu <monk.liu@amd.com>
Reviewed-by: Christian KÃ¶nig <christian.koenig@amd.com>
Reviewed-by: Jammy Zhou <jammy.zhou@amd.com>
Signed-off-by: Sanjay R Mehta <sanju.mehta@amd.com>
---
 drivers/gpu/drm/amd/amdgpu/amdgpu_ttm.c | 13 +++++++++----
 1 file changed, 9 insertions(+), 4 deletions(-)

diff --git a/drivers/gpu/drm/amd/amdgpu/amdgpu_ttm.c b/drivers/gpu/drm/amd/amdgpu/amdgpu_ttm.c
index 120e6e7..8e60218 100644
--- a/drivers/gpu/drm/amd/amdgpu/amdgpu_ttm.c
+++ b/drivers/gpu/drm/amd/amdgpu/amdgpu_ttm.c
@@ -570,13 +570,18 @@ static void amdgpu_ttm_tt_unpin_userptr(struct ttm_tt *ttm)
 	dma_unmap_sg(adev->dev, ttm->sg->sgl, ttm->sg->nents, direction);
 
 	for_each_sg(ttm->sg->sgl, sg, ttm->sg->nents, i) {
+		int len = sg->length >> PAGE_SHIFT;
 		struct page *page = sg_page(sg);
+		while (len > 0) {
+			if (!(gtt->userflags & AMDGPU_GEM_USERPTR_READONLY))
+				set_page_dirty(page);
 
-		if (!(gtt->userflags & AMDGPU_GEM_USERPTR_READONLY))
-			set_page_dirty(page);
+			mark_page_accessed(page);
+			page_cache_release(page);
 
-		mark_page_accessed(page);
-		page_cache_release(page);
+			page++;
+			len--;
+		}
 	}
 
 	sg_free_table(ttm->sg);
-- 
1.9.1

