From eab639ffb556a6fea0aa38d00e4a7d42ac20e17c Mon Sep 17 00:00:00 2001
From: Chunming Zhou <David1.Zhou@amd.com>
Date: Thu, 30 Jun 2016 16:44:41 +0800
Subject: [PATCH 0280/1722] drm/amdgpu: block ttm first before parking
 scheduler
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Signed-off-by: Chunming Zhou <David1.Zhou@amd.com>
Reviewed-by: Christian KÃ¶nig <christian.koenig@amd.com>
Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
Signed-off-by: Kalyan Alle <kalyan.alle@amd.com>
---
 drivers/gpu/drm/amd/amdgpu/amdgpu_device.c | 5 +++--
 1 file changed, 3 insertions(+), 2 deletions(-)

diff --git a/drivers/gpu/drm/amd/amdgpu/amdgpu_device.c b/drivers/gpu/drm/amd/amdgpu/amdgpu_device.c
index 9088789..d294f4f 100644
--- a/drivers/gpu/drm/amd/amdgpu/amdgpu_device.c
+++ b/drivers/gpu/drm/amd/amdgpu/amdgpu_device.c
@@ -2000,6 +2000,9 @@ int amdgpu_gpu_reset(struct amdgpu_device *adev)
 	int resched;
 
 	atomic_inc(&adev->gpu_reset_counter);
+ 
+        /* block TTM */
+        resched = ttm_bo_lock_delayed_workqueue(&adev->mman.bdev);
   
  	/* block scheduler */
         for (i = 0; i < AMDGPU_MAX_RINGS; ++i) {
@@ -2010,8 +2013,6 @@ int amdgpu_gpu_reset(struct amdgpu_device *adev)
                 kthread_park(ring->sched.thread);
         }
 
-	/* block TTM */
-	resched = ttm_bo_lock_delayed_workqueue(&adev->mman.bdev);
         /* save scratch */
         amdgpu_atombios_scratch_regs_save(adev);
 
-- 
2.7.4

