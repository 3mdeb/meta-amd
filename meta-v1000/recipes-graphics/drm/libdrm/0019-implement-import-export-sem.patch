From 30a578514f6bce5b295a733f99f7c76a6b3d416d Mon Sep 17 00:00:00 2001
From: Flora Cui <Flora.Cui@amd.com>
Date: Thu, 12 Jan 2017 11:03:44 +0800
Subject: [PATCH 19/38] implement import/export sem

Change-Id: I4900fbb046c912a905eded8a8349fa98b3ba822b
Signed-off-by: Flora Cui <Flora.Cui@amd.com>
Acked-by: Hawking Zhang <Hawking.Zhang@amd.com>
---
 amdgpu/amdgpu.h          |  8 ++++++++
 amdgpu/amdgpu_cs.c       | 43 +++++++++++++++++++++++++++++++++++++++++++
 include/drm/amdgpu_drm.h |  2 ++
 3 files changed, 53 insertions(+)

diff --git a/amdgpu/amdgpu.h b/amdgpu/amdgpu.h
index 2ab429a..fb58624 100644
--- a/amdgpu/amdgpu.h
+++ b/amdgpu/amdgpu.h
@@ -1575,6 +1575,14 @@ int amdgpu_cs_wait_sem(amdgpu_device_handle dev,
 		       uint32_t ring,
 		       amdgpu_sem_handle sem);
 
+int amdgpu_cs_export_sem(amdgpu_device_handle dev,
+			  amdgpu_sem_handle sem,
+			  int *shared_handle);
+
+int amdgpu_cs_import_sem(amdgpu_device_handle dev,
+			  int shared_handle,
+			  amdgpu_sem_handle *sem);
+
 /**
  *  destroy sem
  *
diff --git a/amdgpu/amdgpu_cs.c b/amdgpu/amdgpu_cs.c
index e1160a4..087e1d4 100644
--- a/amdgpu/amdgpu_cs.c
+++ b/amdgpu/amdgpu_cs.c
@@ -668,6 +668,49 @@ int amdgpu_cs_wait_sem(amdgpu_device_handle dev,
 	return drmCommandWriteRead(dev->fd, DRM_AMDGPU_SEM, &args, sizeof(args));
 }
 
+int amdgpu_cs_export_sem(amdgpu_device_handle dev,
+			  amdgpu_sem_handle sem,
+			  int *shared_handle)
+{
+	union drm_amdgpu_sem args;
+	int r;
+
+	if (NULL == dev)
+		return -EINVAL;
+
+	/* Create the context */
+	memset(&args, 0, sizeof(args));
+	args.in.op = AMDGPU_SEM_OP_EXPORT_SEM;
+	args.in.handle = sem;
+	r = drmCommandWriteRead(dev->fd, DRM_AMDGPU_SEM, &args, sizeof(args));
+	if (r)
+		return r;
+	*shared_handle = args.out.fd;
+	return 0;
+}
+
+int amdgpu_cs_import_sem(amdgpu_device_handle dev,
+			  int shared_handle,
+			  amdgpu_sem_handle *sem)
+{
+	union drm_amdgpu_sem args;
+	int r;
+
+	if (NULL == dev)
+		return -EINVAL;
+
+	/* Create the context */
+	memset(&args, 0, sizeof(args));
+	args.in.op = AMDGPU_SEM_OP_IMPORT_SEM;
+	args.in.handle = shared_handle;
+	r = drmCommandWriteRead(dev->fd, DRM_AMDGPU_SEM, &args, sizeof(args));
+	if (r)
+		return r;
+	*sem = args.out.handle;
+	return 0;
+}
+
+
 int amdgpu_cs_destroy_sem(amdgpu_device_handle dev,
 			  amdgpu_sem_handle sem)
 {
diff --git a/include/drm/amdgpu_drm.h b/include/drm/amdgpu_drm.h
index d5b8125..c3fcb65 100644
--- a/include/drm/amdgpu_drm.h
+++ b/include/drm/amdgpu_drm.h
@@ -207,6 +207,8 @@ union drm_amdgpu_ctx {
 #define AMDGPU_SEM_OP_WAIT_SEM         2
 #define AMDGPU_SEM_OP_SIGNAL_SEM       3
 #define AMDGPU_SEM_OP_DESTROY_SEM      4
+#define AMDGPU_SEM_OP_IMPORT_SEM       5
+#define AMDGPU_SEM_OP_EXPORT_SEM       6
 
 struct drm_amdgpu_sem_in {
 	/** AMDGPU_SEM_OP_* */
-- 
2.7.4

