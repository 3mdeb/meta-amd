From 2b4c4d825b516e8eba8758e7ce686f56537a775d Mon Sep 17 00:00:00 2001
From: Jordan Lazare <Jordan.Lazare@amd.com>
Date: Mon, 11 Jul 2016 15:24:09 -0400
Subject: [PATCH 0615/1722] drm/amd/dal: Fix hang due to non-zeroed gamut
 adjustment

This fixes a regression caused by
commit d6d4c26a83ff2f

Change-Id: I711a7eca685c8fb374f4e660aef2ffdfabf37314
Signed-off-by: Jordan Lazare <Jordan.Lazare@amd.com>
Acked-by: Harry Wentland <harry.wentland@amd.com>
Signed-off-by: Kalyan Alle <kalyan.alle@amd.com>
---
 drivers/gpu/drm/amd/dal/dc/dc_types.h                      | 2 +-
 drivers/gpu/drm/amd/dal/dc/dce110/dce110_hw_sequencer.c    | 5 ++++-
 drivers/gpu/drm/amd/dal/dc/dce110/dce110_transform_gamut.c | 1 +
 drivers/gpu/drm/amd/dal/modules/color/color.c              | 6 +++---
 4 files changed, 9 insertions(+), 5 deletions(-)

diff --git a/drivers/gpu/drm/amd/dal/dc/dc_types.h b/drivers/gpu/drm/amd/dal/dc/dc_types.h
index c7f36c7..8392e67 100644
--- a/drivers/gpu/drm/amd/dal/dc/dc_types.h
+++ b/drivers/gpu/drm/amd/dal/dc/dc_types.h
@@ -529,7 +529,7 @@ struct freesync_context {
 
 struct colorspace_transform {
 	struct fixed31_32 matrix[12];
-	bool bypass;
+	bool enable_remap;
 };
 
 #endif /* DC_TYPES_H_ */
diff --git a/drivers/gpu/drm/amd/dal/dc/dce110/dce110_hw_sequencer.c b/drivers/gpu/drm/amd/dal/dc/dce110/dce110_hw_sequencer.c
index 64633e9..74e9328 100644
--- a/drivers/gpu/drm/amd/dal/dc/dce110/dce110_hw_sequencer.c
+++ b/drivers/gpu/drm/amd/dal/dc/dce110/dce110_hw_sequencer.c
@@ -1497,11 +1497,14 @@ static void set_plane_config(
 	enum blender_mode blender_mode = BLENDER_MODE_CURRENT_PIPE;
 	struct xfm_grph_csc_adjustment adjust;
 
+	memset(&adjust, 0, sizeof(adjust));
+	adjust.gamut_adjust_type = GRAPHICS_GAMUT_ADJUST_TYPE_BYPASS;
+
 	dc->hwss.enable_fe_clock(ctx, pipe_ctx->pipe_idx, true);
 
 	set_default_colors(pipe_ctx);
 
-	if (pipe_ctx->stream->public.gamut_remap_matrix.bypass == false) {
+	if (pipe_ctx->stream->public.gamut_remap_matrix.enable_remap == true) {
 		adjust.gamut_adjust_type = GRAPHICS_GAMUT_ADJUST_TYPE_SW;
 		adjust.temperature_matrix[0] =
 				pipe_ctx->stream->
diff --git a/drivers/gpu/drm/amd/dal/dc/dce110/dce110_transform_gamut.c b/drivers/gpu/drm/amd/dal/dc/dce110/dce110_transform_gamut.c
index 3c9eb56a..1848967 100644
--- a/drivers/gpu/drm/amd/dal/dc/dce110/dce110_transform_gamut.c
+++ b/drivers/gpu/drm/amd/dal/dc/dce110/dce110_transform_gamut.c
@@ -239,6 +239,7 @@ void dce110_transform_set_gamut_remap(
 	struct dce110_transform *xfm110 = TO_DCE110_TRANSFORM(xfm);
 
 	if (adjust->gamut_adjust_type != GRAPHICS_GAMUT_ADJUST_TYPE_SW)
+		/* Bypass if type is bypass or hw */
 		program_gamut_remap(xfm110, NULL);
 	else {
 		struct fixed31_32 arr_matrix[GAMUT_MATRIX_SIZE];
diff --git a/drivers/gpu/drm/amd/dal/modules/color/color.c b/drivers/gpu/drm/amd/dal/modules/color/color.c
index d8c760c..66797d7 100644
--- a/drivers/gpu/drm/amd/dal/modules/color/color.c
+++ b/drivers/gpu/drm/amd/dal/modules/color/color.c
@@ -683,7 +683,7 @@ bool mod_color_adjust_temperature(struct mod_color *mod_color,
 	for (i = 0; i < num_streams; i++) {
 		struct core_stream *core_stream = DC_STREAM_TO_CORE(streams[i]);
 
-		core_stream->public.gamut_remap_matrix.bypass = false;
+		core_stream->public.gamut_remap_matrix.enable_remap = true;
 
 		for (j = 0; j < 12; j++)
 			core_stream->public.gamut_remap_matrix.matrix[j] =
@@ -758,7 +758,7 @@ bool mod_color_adjust_source_gamut(struct mod_color *mod_color,
 	for (i = 0; i < num_streams; i++) {
 		struct core_stream *core_stream = DC_STREAM_TO_CORE(streams[i]);
 
-		core_stream->public.gamut_remap_matrix.bypass = false;
+		core_stream->public.gamut_remap_matrix.enable_remap = true;
 
 		for (j = 0; j < 12; j++)
 			core_stream->public.gamut_remap_matrix.matrix[j] =
@@ -833,7 +833,7 @@ bool mod_color_adjust_destination_gamut(struct mod_color *mod_color,
 	for (i = 0; i < num_streams; i++) {
 		struct core_stream *core_stream = DC_STREAM_TO_CORE(streams[i]);
 
-		core_stream->public.gamut_remap_matrix.bypass = false;
+		core_stream->public.gamut_remap_matrix.enable_remap = true;
 
 		for (j = 0; j < 12; j++)
 			core_stream->public.gamut_remap_matrix.matrix[j] =
-- 
2.7.4

