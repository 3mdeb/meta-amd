From 79be4eec32c9ca2a44cfe4779f8b1688f7b2875f Mon Sep 17 00:00:00 2001
From: David Rokhvarg <David.Rokhvarg@amd.com>
Date: Fri, 17 Jul 2015 16:12:28 -0400
Subject: [PATCH 372/401] amd/dal: Use TM_ACQUIRE_METHOD_SW for Detection.

Reviewed-By: David Rokhvarg <David.Rohkvarg@amd.com>
Signed-off-by: David Rokhvarg <David.Rokhvarg@amd.com>
Signed-off-by: Sanjay R Mehta <sanju.mehta@amd.com>
---
 drivers/gpu/drm/amd/dal/display_path/display_path.c | 2 ++
 drivers/gpu/drm/amd/dal/topology/tm_detection_mgr.c | 8 ++++----
 drivers/gpu/drm/amd/dal/topology/tm_resource_mgr.c  | 3 ++-
 3 files changed, 8 insertions(+), 5 deletions(-)

diff --git a/drivers/gpu/drm/amd/dal/display_path/display_path.c b/drivers/gpu/drm/amd/dal/display_path/display_path.c
index caf14e3..77c68b5 100644
--- a/drivers/gpu/drm/amd/dal/display_path/display_path.c
+++ b/drivers/gpu/drm/amd/dal/display_path/display_path.c
@@ -349,6 +349,8 @@ void dal_display_path_release_resources(struct display_path *path)
 		cntx->state.LINK = false;
 		cntx->state.AUDIO = false;
 		cntx->engine = ENGINE_ID_UNKNOWN;
+		cntx->input_config_signal = SIGNAL_TYPE_NONE;
+		cntx->output_config_signal = SIGNAL_TYPE_NONE;
 		cntx->link_config_interface = NULL;
 	}
 
diff --git a/drivers/gpu/drm/amd/dal/topology/tm_detection_mgr.c b/drivers/gpu/drm/amd/dal/topology/tm_detection_mgr.c
index 86eb300..4a445db 100644
--- a/drivers/gpu/drm/amd/dal/topology/tm_detection_mgr.c
+++ b/drivers/gpu/drm/amd/dal/topology/tm_detection_mgr.c
@@ -607,7 +607,7 @@ static bool apply_load_detection_based_edid_patch(
 					tm_resource_mgr_acquire_resources(
 						tm_dm->resource_mgr,
 						temp_path,
-					TM_ACQUIRE_METHOD_HW);
+					TM_ACQUIRE_METHOD_SW);
 				if (TM_RESULT_SUCCESS == tm_ret) {
 					signal =
 						dal_hw_sequencer_detect_load(
@@ -619,7 +619,7 @@ static bool apply_load_detection_based_edid_patch(
 					tm_resource_mgr_release_resources(
 						tm_dm->resource_mgr,
 						temp_path,
-					TM_ACQUIRE_METHOD_HW);
+					TM_ACQUIRE_METHOD_SW);
 				} else
 					BREAK_TO_DEBUGGER();
 			}
@@ -2065,7 +2065,7 @@ bool dal_tm_detection_mgr_detect_display(
 	}
 
 	if (!tm_resource_mgr_acquire_resources(tm_dm->resource_mgr,
-			display_path, TM_ACQUIRE_METHOD_HW))
+			display_path, TM_ACQUIRE_METHOD_SW))
 		return detect_performed;
 
 	/**Step 1: retrieve the current sink capabilities and Edid
@@ -2112,7 +2112,7 @@ bool dal_tm_detection_mgr_detect_display(
 	}
 
 	tm_resource_mgr_release_resources(tm_dm->resource_mgr, display_path,
-			TM_ACQUIRE_METHOD_HW);
+			TM_ACQUIRE_METHOD_SW);
 
 	return detect_performed;
 }
diff --git a/drivers/gpu/drm/amd/dal/topology/tm_resource_mgr.c b/drivers/gpu/drm/amd/dal/topology/tm_resource_mgr.c
index 9cff5e0..3e647e3 100644
--- a/drivers/gpu/drm/amd/dal/topology/tm_resource_mgr.c
+++ b/drivers/gpu/drm/amd/dal/topology/tm_resource_mgr.c
@@ -2051,8 +2051,9 @@ enum tm_result tm_resource_mgr_acquire_resources(
 		return TM_RESULT_FAILURE;
 	}
 
+	dal_display_path_acquire_links(display_path);
+
 	if (update_hw_state_needed(method)) {
-		dal_display_path_acquire_links(display_path);
 		dal_display_path_acquire(display_path);
 	}
 
-- 
1.9.1

