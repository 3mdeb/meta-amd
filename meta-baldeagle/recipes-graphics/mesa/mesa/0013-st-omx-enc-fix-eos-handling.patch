From 305c2ebdc6f65c6b79dc28246c5f9bc8364f7b7c Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Christian=20K=C3=B6nig?= <christian.koenig@amd.com>
Date: Mon, 4 Nov 2013 09:05:14 -0700
Subject: [PATCH 13/27] st/omx/enc: fix eos handling
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Signed-off-by: Christian KÃ¶nig <christian.koenig@amd.com>
---
 src/gallium/state_trackers/omx/vid_enc.c |   16 +++++++++++++---
 1 file changed, 13 insertions(+), 3 deletions(-)

diff --git a/src/gallium/state_trackers/omx/vid_enc.c b/src/gallium/state_trackers/omx/vid_enc.c
index 926d29c..02afd17 100644
--- a/src/gallium/state_trackers/omx/vid_enc.c
+++ b/src/gallium/state_trackers/omx/vid_enc.c
@@ -602,6 +602,14 @@ static OMX_ERRORTYPE vid_enc_EncodeFrame(omx_base_PortType *port, OMX_BUFFERHEAD
    struct pipe_h264_enc_picture_desc picture;
    struct pipe_video_buffer *vbuf = inp->buf;
 
+   pipe_resource_reference(&inp->bitstream, NULL);
+
+   if (buf->nFilledLen == 0) {
+      if (buf->nFlags & OMX_BUFFERFLAG_EOS)
+         buf->nFilledLen = buf->nAllocLen;
+      return base_port_SendBufferFunction(port, buf);
+   }
+
    if (buf->pOutputPortPrivate) {
       vbuf = buf->pOutputPortPrivate;
    } else {
@@ -638,7 +646,6 @@ static OMX_ERRORTYPE vid_enc_EncodeFrame(omx_base_PortType *port, OMX_BUFFERHEAD
 
    /* -------------- allocate output buffer --------- */
 
-   pipe_resource_reference(&inp->bitstream, NULL);
    inp->bitstream = pipe_buffer_create(priv->pipe->screen, PIPE_BIND_VERTEX_BUFFER,
                                        PIPE_USAGE_STREAM, size);
 
@@ -713,6 +720,11 @@ static void vid_enc_BufferEncoded(OMX_COMPONENTTYPE *comp, OMX_BUFFERHEADERTYPE*
    struct pipe_box box = {};
    unsigned size;
 
+   input->nFilledLen = 0; /* mark buffer as empty */
+
+   if (!inp->bitstream)
+      return;
+
    /* ------------- map result buffer ----------------- */
 
    if (outp->transfer)
@@ -732,8 +744,6 @@ static void vid_enc_BufferEncoded(OMX_COMPONENTTYPE *comp, OMX_BUFFERHEADERTYPE*
 
    priv->codec->get_feedback(priv->codec, inp->feedback, &size);
 
-   input->nFilledLen = 0; /* mark buffer as empty */
-
    output->nOffset = 0;
    output->nFilledLen = size; /* mark buffer as full */
 }
-- 
1.7.9.5

