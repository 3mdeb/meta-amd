From bd0eff01c22c4ea92f7d857d61b3d8ec0ec1683a Mon Sep 17 00:00:00 2001
From: Harry Wentland <harry.wentland@amd.com>
Date: Tue, 4 Oct 2016 14:36:46 -0400
Subject: [PATCH 1216/1722] drm/amd/dal: Don't do PSR or DRR stuff on underlay
 pipe

Change-Id: I282ea6ff33edf00197227fcf132440006ec7db65
Signed-off-by: Harry Wentland <harry.wentland@amd.com>
Acked-by: Harry Wentland <harry.wentland@amd.com>
Signed-off-by: Kalyan Alle <kalyan.alle@amd.com>
---
 drivers/gpu/drm/amd/dal/dc/core/dc.c | 10 ++++++----
 1 file changed, 6 insertions(+), 4 deletions(-)

diff --git a/drivers/gpu/drm/amd/dal/dc/core/dc.c b/drivers/gpu/drm/amd/dal/dc/core/dc.c
index c5d7c65..32ec2e8 100644
--- a/drivers/gpu/drm/amd/dal/dc/core/dc.c
+++ b/drivers/gpu/drm/amd/dal/dc/core/dc.c
@@ -204,10 +204,11 @@ static bool stream_adjust_vmin_vmax(struct dc *dc,
 	int i = 0;
 	bool ret = false;
 	struct pipe_ctx *pipes;
+	unsigned int underlay_idx = core_dc->res_pool->underlay_pipe_index;
 
 	for (i = 0; i < MAX_PIPES; i++) {
-		if (core_dc->current_context->res_ctx.pipe_ctx[i].stream
-				== core_stream) {
+		if (core_dc->current_context->res_ctx.pipe_ctx[i].stream == core_stream
+				&& i != underlay_idx) {
 
 			pipes = &core_dc->current_context->res_ctx.pipe_ctx[i];
 			core_dc->hwss.set_drr(&pipes, 1, vmin, vmax);
@@ -348,14 +349,15 @@ static bool setup_psr(struct dc *dc, const struct dc_stream *stream)
 	struct core_stream *core_stream = DC_STREAM_TO_CORE(stream);
 	struct pipe_ctx *pipes;
 	int i;
+	unsigned int underlay_idx = core_dc->res_pool->underlay_pipe_index;
 
 	for (i = 0; i < core_dc->link_count; i++)
 		dc_link_setup_psr(&core_dc->links[i]->public,
 				stream);
 
 	for (i = 0; i < MAX_PIPES; i++) {
-		if (core_dc->current_context->res_ctx.pipe_ctx[i].stream
-			== core_stream) {
+		if (core_dc->current_context->res_ctx.pipe_ctx[i].stream == core_stream
+				&& i != underlay_idx) {
 
 			pipes = &core_dc->current_context->res_ctx.pipe_ctx[i];
 			core_dc->hwss.set_static_screen_control(&pipes, 1,
-- 
2.7.4

