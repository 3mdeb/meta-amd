From f61fe1e8633c30236ad4aac766cae282a367cbcb Mon Sep 17 00:00:00 2001
From: Zeyu Fan <Zeyu.Fan@amd.com>
Date: Wed, 27 Jul 2016 17:13:49 -0400
Subject: [PATCH 0670/1722] drm/amd/dal: fixed scaler validation failure caused
 by compiler optimization.

Signed-off-by: Zeyu Fan <Zeyu.Fan@amd.com>
Acked-by: Harry Wentland <harry.wentland@amd.com>
Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
Signed-off-by: Kalyan Alle <kalyan.alle@amd.com>
---
 .../drm/amd/dal/dc/dce110/dce110_transform_scl.c    | 21 ++++++++++++++-------
 1 file changed, 14 insertions(+), 7 deletions(-)

diff --git a/drivers/gpu/drm/amd/dal/dc/dce110/dce110_transform_scl.c b/drivers/gpu/drm/amd/dal/dc/dce110/dce110_transform_scl.c
index 58da5a8..665adca 100644
--- a/drivers/gpu/drm/amd/dal/dc/dce110/dce110_transform_scl.c
+++ b/drivers/gpu/drm/amd/dal/dc/dce110/dce110_transform_scl.c
@@ -727,6 +727,11 @@ bool transform_get_optimal_number_of_taps_helper(
 	uint32_t pixel_width,
 	const struct scaling_taps *in_taps) {
 
+	/*In gcc linux, the scl_data->taps.v_taps will somehow be optimized out by compiler
+	 *and thus causing a scale tap validation failure. Declaring the scaler data with volatile
+	 *will avoid it to be optimized.
+	 */
+	volatile struct scaler_data *scl = scl_data;
 	int max_num_of_lines;
 
 	max_num_of_lines = dce110_transform_get_max_num_of_supported_lines(
@@ -738,21 +743,23 @@ bool transform_get_optimal_number_of_taps_helper(
 	 * maintain that much taps
 	 */
 	if (in_taps->v_taps) {
-		scl_data->taps = *in_taps;
-		return max_num_of_lines > scl_data->taps.v_taps;
+		scl->taps = *in_taps;
+		return max_num_of_lines > scl->taps.v_taps;
 	}
 
 	/*If no taps given as input set to max and reduce
 	 * as needed to get along, also
 	 * set horizontal taps to 4 regardless
 	 */
-	scl_data->taps.h_taps = 4;
-	scl_data->taps.v_taps = 4;
+	scl->taps.h_taps = 4;
+	scl->taps.v_taps = 4;
 
-	if (max_num_of_lines > scl_data->taps.v_taps)
+	if (max_num_of_lines > scl->taps.v_taps)
 		return true;
 
-	scl_data->taps.v_taps = max_num_of_lines - 1;
-	return scl_data->taps.v_taps > 1;
+	scl->taps.v_taps = max_num_of_lines - 1;
+
+
+	return scl->taps.v_taps > 1;
 
 }
-- 
2.7.4

