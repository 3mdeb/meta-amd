From 6f04e2bcc32877ea593f2636e44bf3a53f7c7cd2 Mon Sep 17 00:00:00 2001
From: Dmytro Laktyushkin <Dmytro.Laktyushkin@amd.com>
Date: Wed, 19 Oct 2016 13:55:33 -0400
Subject: [PATCH 1347/1722] drm/amd/dal: fix cz 3 display light up

Change-Id: I796fce60673299a097ac88a1b484291354603e2c
Signed-off-by: Dmytro Laktyushkin <Dmytro.Laktyushkin@amd.com>
Acked-by: Harry Wentland <harry.wentland@amd.com>
---
 drivers/gpu/drm/amd/dal/dc/core/dc.c | 12 +++++-------
 1 file changed, 5 insertions(+), 7 deletions(-)

diff --git a/drivers/gpu/drm/amd/dal/dc/core/dc.c b/drivers/gpu/drm/amd/dal/dc/core/dc.c
index a01385d..9512a9c 100644
--- a/drivers/gpu/drm/amd/dal/dc/core/dc.c
+++ b/drivers/gpu/drm/amd/dal/dc/core/dc.c
@@ -630,7 +630,7 @@ void ProgramPixelDurationV(unsigned int pixelClockInKHz )
 struct dc *dc_create(const struct dc_init_data *init_params)
  {
 	struct core_dc *core_dc = dm_alloc(sizeof(*core_dc));
-	bool has_underlay = false;
+	int full_pipe_count;
 
 	if (NULL == core_dc)
 		goto alloc_fail;
@@ -641,15 +641,13 @@ struct dc *dc_create(const struct dc_init_data *init_params)
 	/*TODO: separate HW and SW initialization*/
 	core_dc->hwss.init_hw(core_dc);
 
+	full_pipe_count = core_dc->res_pool->pipe_count;
+	if (core_dc->res_pool->underlay_pipe_index >= 0)
+		full_pipe_count--;
 	core_dc->public.caps.max_targets = dm_min(
-			core_dc->res_pool->pipe_count,
+			full_pipe_count,
 			core_dc->res_pool->stream_enc_count);
 
-	/* Don't report underlay pipe as target */
-	has_underlay = core_dc->res_pool->underlay_pipe_index >= 0;
-	if (has_underlay)
-		core_dc->public.caps.max_targets--;
-
 	core_dc->public.caps.max_links = core_dc->link_count;
 	core_dc->public.caps.max_audios = core_dc->res_pool->audio_count;
 
-- 
2.7.4

