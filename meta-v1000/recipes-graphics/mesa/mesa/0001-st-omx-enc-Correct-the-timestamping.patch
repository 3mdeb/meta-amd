From 7f45a95f73ee7d44eed2f098de25d0436c4e74e9 Mon Sep 17 00:00:00 2001
From: Nishanth Peethambaran <nishanth.peethambaran@amd.com>
Date: Thu, 29 Jun 2017 18:28:46 +0530
Subject: [PATCH 1/3] st/omx/enc: Correct the timestamping

Attach the timestamp to the encoder task and use that timestamp
while pushing bitstrema buffer to the omx client.

Signed-off-by: Indrajit Das <indrajit-kumar.das@amd.com>
---
 src/gallium/state_trackers/omx_bellagio/vid_enc.c | 3 +++
 1 file changed, 3 insertions(+)

diff --git a/src/gallium/state_trackers/omx_bellagio/vid_enc.c b/src/gallium/state_trackers/omx_bellagio/vid_enc.c
index 1a4fb62..9004ddd 100644
--- a/src/gallium/state_trackers/omx_bellagio/vid_enc.c
+++ b/src/gallium/state_trackers/omx_bellagio/vid_enc.c
@@ -58,6 +58,7 @@ struct encode_task {
    struct list_head list;
 
    struct pipe_video_buffer *buf;
+   OMX_TICKS timestamp;
    unsigned pic_order_cnt;
    struct pipe_resource *bitstream;
    void *feedback;
@@ -1174,6 +1175,7 @@ static OMX_ERRORTYPE vid_enc_EncodeFrame(omx_base_PortType *port, OMX_BUFFERHEAD
          return err;
       }
    }
+   task->timestamp = buf->nTimeStamp;
 
    /* -------------- determine picture type --------- */
    if (!(priv->pic_order_cnt % OMX_VID_ENC_IDR_PERIOD_DEFAULT) ||
@@ -1272,6 +1274,7 @@ static void vid_enc_BufferEncoded(OMX_COMPONENTTYPE *comp, OMX_BUFFERHEADERTYPE*
 
    output->nOffset = 0;
    output->nFilledLen = size; /* mark buffer as full */
+   output->nTimeStamp = task->timestamp;
 
    /* all output buffers contain exactly one frame */
    output->nFlags = OMX_BUFFERFLAG_ENDOFFRAME;
-- 
2.7.4

