From c3ef458901e646cd086e769e27135a6d160e6cbd Mon Sep 17 00:00:00 2001
From: Eric Yang <eric.yang2@amd.com>
Date: Wed, 13 Jul 2016 15:09:38 -0400
Subject: [PATCH 0640/1722] drm/amd/dal: use correct output member for pstate
 separation time

Signed-off-by: Eric Yang <eric.yang2@amd.com>
Acked-by: Harry Wentland <harry.wentland@amd.com>
Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
Signed-off-by: Kalyan Alle <kalyan.alle@amd.com>
---
 drivers/gpu/drm/amd/dal/dc/calcs/bandwidth_calcs.c  | 8 ++------
 drivers/gpu/drm/amd/dal/dc/core/dc.c                | 3 ++-
 drivers/gpu/drm/amd/dal/dc/dce110/dce110_resource.c | 4 ++--
 drivers/gpu/drm/amd/dal/dc/dce112/dce112_resource.c | 4 ++--
 drivers/gpu/drm/amd/dal/dc/inc/bandwidth_calcs.h    | 2 +-
 5 files changed, 9 insertions(+), 12 deletions(-)

diff --git a/drivers/gpu/drm/amd/dal/dc/calcs/bandwidth_calcs.c b/drivers/gpu/drm/amd/dal/dc/calcs/bandwidth_calcs.c
index 72d4019..d826390 100644
--- a/drivers/gpu/drm/amd/dal/dc/calcs/bandwidth_calcs.c
+++ b/drivers/gpu/drm/amd/dal/dc/calcs/bandwidth_calcs.c
@@ -4147,10 +4147,8 @@ bool bw_calcs(struct dc_context *ctx, const struct bw_calcs_dceip *dceip,
 		calcs_output->dispclk_khz =
 			bw_fixed_to_int(bw_mul(bw_results_internal->dispclk,
 					bw_int_to_fixed(1000)));
-		calcs_output->required_blackout_duration_us =
-			bw_fixed_to_int(bw_add(bw_results_internal->
-				blackout_duration_margin[yclk_lvl][sclk_lvl],
-				vbios->blackout_duration));
+		calcs_output->blackout_recovery_time_us =
+			bw_fixed_to_int(bw_results_internal->blackout_recovery_time);
 		calcs_output->required_sclk =
 			bw_fixed_to_int(bw_mul(bw_results_internal->required_sclk,
 					bw_int_to_fixed(1000)));
@@ -4169,8 +4167,6 @@ bool bw_calcs(struct dc_context *ctx, const struct bw_calcs_dceip *dceip,
 
 		/* units: nanosecond, 16bit storage. */
 
-
-
 		calcs_output->nbp_state_change_wm_ns[0].a_mark =
 			bw_fixed_to_int(bw_mul(bw_results_internal->
 				nbp_state_change_watermark[4], bw_int_to_fixed(1000)));
diff --git a/drivers/gpu/drm/amd/dal/dc/core/dc.c b/drivers/gpu/drm/amd/dal/dc/core/dc.c
index 68f4d41..f21f738 100644
--- a/drivers/gpu/drm/amd/dal/dc/core/dc.c
+++ b/drivers/gpu/drm/amd/dal/dc/core/dc.c
@@ -722,10 +722,11 @@ void pplib_apply_display_requirements(
 	pp_display_cfg->cpu_pstate_disable =
 			context->bw_results.cpup_state_change_enable == false;
 	pp_display_cfg->cpu_pstate_separation_time =
-			context->bw_results.required_blackout_duration_us;
+			context->bw_results.blackout_recovery_time_us;
 
 	pp_display_cfg->min_memory_clock_khz = context->bw_results.required_yclk
 		/ MEMORY_TYPE_MULTIPLIER;
+
 	pp_display_cfg->min_engine_clock_khz = context->bw_results.required_sclk;
 	pp_display_cfg->min_engine_clock_deep_sleep_khz
 			= context->bw_results.required_sclk_deep_sleep;
diff --git a/drivers/gpu/drm/amd/dal/dc/dce110/dce110_resource.c b/drivers/gpu/drm/amd/dal/dc/dce110/dce110_resource.c
index 25b9b35..21dd285 100644
--- a/drivers/gpu/drm/amd/dal/dc/dce110/dce110_resource.c
+++ b/drivers/gpu/drm/amd/dal/dc/dce110/dce110_resource.c
@@ -874,7 +874,7 @@ enum dc_status dce110_validate_bandwidth(
 			context->bw_results.stutter_mode_enable);
 		dal_logger_append(&log_entry,
 			"cstate: %d pstate: %d nbpstate: %d sync: %d dispclk: %d\n"
-			"sclk: %d sclk_sleep: %d yclk: %d blackout_duration: %d\n",
+			"sclk: %d sclk_sleep: %d yclk: %d blackout_recovery_time_us: %d\n",
 			context->bw_results.cpuc_state_change_enable,
 			context->bw_results.cpup_state_change_enable,
 			context->bw_results.nbp_state_change_enable,
@@ -883,7 +883,7 @@ enum dc_status dce110_validate_bandwidth(
 			context->bw_results.required_sclk,
 			context->bw_results.required_sclk_deep_sleep,
 			context->bw_results.required_yclk,
-			context->bw_results.required_blackout_duration_us);
+			context->bw_results.blackout_recovery_time_us);
 		dal_logger_close(&log_entry);
 	}
 	return result;
diff --git a/drivers/gpu/drm/amd/dal/dc/dce112/dce112_resource.c b/drivers/gpu/drm/amd/dal/dc/dce112/dce112_resource.c
index c5e3ce0..4ff6dc1 100644
--- a/drivers/gpu/drm/amd/dal/dc/dce112/dce112_resource.c
+++ b/drivers/gpu/drm/amd/dal/dc/dce112/dce112_resource.c
@@ -849,7 +849,7 @@ enum dc_status dce112_validate_bandwidth(
 			context->bw_results.stutter_mode_enable);
 		dal_logger_append(&log_entry,
 			"cstate: %d pstate: %d nbpstate: %d sync: %d dispclk: %d\n"
-			"sclk: %d sclk_sleep: %d yclk: %d blackout_duration: %d\n",
+			"sclk: %d sclk_sleep: %d yclk: %d blackout_recovery_time_us: %d\n",
 			context->bw_results.cpuc_state_change_enable,
 			context->bw_results.cpup_state_change_enable,
 			context->bw_results.nbp_state_change_enable,
@@ -858,7 +858,7 @@ enum dc_status dce112_validate_bandwidth(
 			context->bw_results.required_sclk,
 			context->bw_results.required_sclk_deep_sleep,
 			context->bw_results.required_yclk,
-			context->bw_results.required_blackout_duration_us);
+			context->bw_results.blackout_recovery_time_us);
 		dal_logger_close(&log_entry);
 	}
 	return result;
diff --git a/drivers/gpu/drm/amd/dal/dc/inc/bandwidth_calcs.h b/drivers/gpu/drm/amd/dal/dc/inc/bandwidth_calcs.h
index 83efb46..f0630e3 100644
--- a/drivers/gpu/drm/amd/dal/dc/inc/bandwidth_calcs.h
+++ b/drivers/gpu/drm/amd/dal/dc/inc/bandwidth_calcs.h
@@ -501,7 +501,7 @@ struct bw_calcs_output {
 	uint32_t required_sclk_deep_sleep;
 	uint32_t required_yclk;
 	uint32_t dispclk_khz;
-	int32_t required_blackout_duration_us;
+	int blackout_recovery_time_us;
 };
 
 enum bw_calcs_version {
-- 
2.7.4

