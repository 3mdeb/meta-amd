From f0613d85764a11f08a19d6c4e9b2f43ae4e59b2d Mon Sep 17 00:00:00 2001
From: Harry Wentland <harry.wentland@amd.com>
Date: Fri, 10 Jun 2016 09:16:21 -0400
Subject: [PATCH 0536/1722] drm/amd/dal: Fix 64-bit division on 32-bit system
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Signed-off-by: Harry Wentland <harry.wentland@amd.com>
Reviewed-by: Christian KÃ¶nig <christian.koenig@amd.com>
Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
Signed-off-by: Kalyan Alle <kalyan.alle@amd.com>
---
 drivers/gpu/drm/amd/dal/modules/freesync/freesync.c | 19 ++++++++++++++-----
 1 file changed, 14 insertions(+), 5 deletions(-)

diff --git a/drivers/gpu/drm/amd/dal/modules/freesync/freesync.c b/drivers/gpu/drm/amd/dal/modules/freesync/freesync.c
index afb1183..099284c 100644
--- a/drivers/gpu/drm/amd/dal/modules/freesync/freesync.c
+++ b/drivers/gpu/drm/amd/dal/modules/freesync/freesync.c
@@ -208,14 +208,20 @@ static void calc_vmin_vmax (const struct dc_stream *stream,
 	unsigned int min_frame_duration_in_ns = 0, max_frame_duration_in_ns = 0;
 
 	min_frame_duration_in_ns = (unsigned int)
-		((1000000000ULL * 1000000) / caps->max_refresh_in_micro_hz);
+		div64_u64((1000000000ULL * 1000000), caps->max_refresh_in_micro_hz);
 	max_frame_duration_in_ns = (unsigned int)
-		((1000000000ULL * 1000000) / caps->min_refresh_in_micro_hz);
+		div64_u64((1000000000ULL * 1000000), caps->min_refresh_in_micro_hz);
 
 	*vmax = (unsigned long long)(max_frame_duration_in_ns) *
-		stream->timing.pix_clk_khz / stream->timing.h_total / 1000000;
+		div64_u64(
+			div64_u64(stream->timing.pix_clk_khz,
+					stream->timing.h_total),
+			1000000);
 	*vmin = (unsigned long long)(min_frame_duration_in_ns) *
-		stream->timing.pix_clk_khz / stream->timing.h_total / 1000000;
+		div64_u64(
+			div64_u64(stream->timing.pix_clk_khz,
+					stream->timing.h_total),
+			1000000);
 
 	/* Field rate might not be the maximum rate
 	 * in which case we should adjust our vmin
@@ -228,7 +234,10 @@ static void calc_v_total_from_duration(const struct dc_stream *stream,
 		unsigned int duration_in_ns, int *v_total_nominal)
 {
 	*v_total_nominal = (unsigned long long)(duration_in_ns) *
-		stream->timing.pix_clk_khz / stream->timing.h_total / 1000000;
+		div64_u64(
+			div64_u64(stream->timing.pix_clk_khz,
+					stream->timing.h_total),
+				1000000);
 
 }
 /*
-- 
2.7.4

