From 18e90422b880562b1824e8b22f75cb5be9824421 Mon Sep 17 00:00:00 2001
From: Flora Cui <Flora.Cui@amd.com>
Date: Thu, 12 Jan 2017 11:03:44 +0800
Subject: [PATCH 23/39] implement import/export sem

Change-Id: I4900fbb046c912a905eded8a8349fa98b3ba822b
Signed-off-by: Flora Cui <Flora.Cui@amd.com>
Acked-by: Hawking Zhang <Hawking.Zhang@amd.com>
Signed-off-by: Avinash M N <avimn@amd.com>
---
 amdgpu/amdgpu.h          |  8 ++++++++
 amdgpu/amdgpu_cs.c       | 42 ++++++++++++++++++++++++++++++++++++++++++
 include/drm/amdgpu_drm.h |  2 ++
 3 files changed, 52 insertions(+)

diff --git a/amdgpu/amdgpu.h b/amdgpu/amdgpu.h
index bff3252..a9ef5ca 100644
--- a/amdgpu/amdgpu.h
+++ b/amdgpu/amdgpu.h
@@ -1638,6 +1638,14 @@ int amdgpu_cs_wait_sem(amdgpu_device_handle dev,
 		       uint32_t ring,
 		       amdgpu_sem_handle sem);
 
+int amdgpu_cs_export_sem(amdgpu_device_handle dev,
+			  amdgpu_sem_handle sem,
+			  int *shared_handle);
+
+int amdgpu_cs_import_sem(amdgpu_device_handle dev,
+			  int shared_handle,
+			  amdgpu_sem_handle *sem);
+
 /**
  *  destroy sem
  *
diff --git a/amdgpu/amdgpu_cs.c b/amdgpu/amdgpu_cs.c
index 8675806..8570714 100644
--- a/amdgpu/amdgpu_cs.c
+++ b/amdgpu/amdgpu_cs.c
@@ -668,6 +668,48 @@ int amdgpu_cs_wait_sem(amdgpu_device_handle dev,
 	return drmCommandWriteRead(dev->fd, DRM_AMDGPU_SEM, &args, sizeof(args));
 }
 
+int amdgpu_cs_export_sem(amdgpu_device_handle dev,
+			 amdgpu_sem_handle sem,
+			 int *shared_handle)
+{
+	union drm_amdgpu_sem args;
+	int r;
+
+	if (NULL == dev)
+		return -EINVAL;
+
+	/* Create the context */
+	memset(&args, 0, sizeof(args));
+	args.in.op = AMDGPU_SEM_OP_EXPORT_SEM;
+	args.in.handle = sem;
+	r = drmCommandWriteRead(dev->fd, DRM_AMDGPU_SEM, &args, sizeof(args));
+	if (r)
+		return r;
+	*shared_handle = args.out.fd;
+	return 0;
+}
+
+int amdgpu_cs_import_sem(amdgpu_device_handle dev,
+			 int shared_handle,
+			 amdgpu_sem_handle *sem)
+{
+	union drm_amdgpu_sem args;
+	int r;
+
+	if (NULL == dev)
+		return -EINVAL;
+
+	/* Create the context */
+	memset(&args, 0, sizeof(args));
+	args.in.op = AMDGPU_SEM_OP_IMPORT_SEM;
+	args.in.handle = shared_handle;
+	r = drmCommandWriteRead(dev->fd, DRM_AMDGPU_SEM, &args, sizeof(args));
+	if (r)
+		return r;
+	*sem = args.out.handle;
+	return 0;
+}
+
 int amdgpu_cs_destroy_sem(amdgpu_device_handle dev,
 			amdgpu_sem_handle sem)
 {
diff --git a/include/drm/amdgpu_drm.h b/include/drm/amdgpu_drm.h
index 6cf8c1b..216caa2 100644
--- a/include/drm/amdgpu_drm.h
+++ b/include/drm/amdgpu_drm.h
@@ -235,6 +235,8 @@ union drm_amdgpu_vm {
 #define AMDGPU_SEM_OP_WAIT_SEM         2
 #define AMDGPU_SEM_OP_SIGNAL_SEM       3
 #define AMDGPU_SEM_OP_DESTROY_SEM      4
+#define AMDGPU_SEM_OP_IMPORT_SEM       5
+#define AMDGPU_SEM_OP_EXPORT_SEM       6
 
 struct drm_amdgpu_sem_in {
 	/** AMDGPU_SEM_OP_* */
-- 
2.7.4

