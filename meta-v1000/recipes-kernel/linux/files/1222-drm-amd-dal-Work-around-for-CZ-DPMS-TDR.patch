From 09a3c712ae480627f0a4ee1702584d53d70b1956 Mon Sep 17 00:00:00 2001
From: Yongqiang Sun <yongqiang.sun@amd.com>
Date: Fri, 7 Oct 2016 09:23:45 -0400
Subject: [PATCH 1222/1722] drm/amd/dal: Work around for CZ DPMS TDR.

Change-Id: Idcaa60aa001c1639647cbc9bbaaea02086919a84
Signed-off-by: Yongqiang Sun <yongqiang.sun@amd.com>
Acked-by: Harry Wentland <harry.wentland@amd.com>
Signed-off-by: Kalyan Alle <kalyan.alle@amd.com>
---
 drivers/gpu/drm/amd/dal/dc/dce110/dce110_hw_sequencer.c | 3 +++
 drivers/gpu/drm/amd/dal/dc/dce110/dce110_mem_input.c    | 3 +++
 2 files changed, 6 insertions(+)

diff --git a/drivers/gpu/drm/amd/dal/dc/dce110/dce110_hw_sequencer.c b/drivers/gpu/drm/amd/dal/dc/dce110/dce110_hw_sequencer.c
index 46976ea..0cb1f9f 100644
--- a/drivers/gpu/drm/amd/dal/dc/dce110/dce110_hw_sequencer.c
+++ b/drivers/gpu/drm/amd/dal/dc/dce110/dce110_hw_sequencer.c
@@ -1688,6 +1688,9 @@ static void update_pending_status(struct pipe_ctx *pipe_ctx)
 			pipe_ctx->mi->funcs->mem_input_is_flip_pending(
 					pipe_ctx->mi);
 
+	if (surface->status.is_flip_pending && !surface->public.visible)
+		pipe_ctx->mi->current_address = pipe_ctx->mi->request_address;
+
 	surface->status.current_address = pipe_ctx->mi->current_address;
 }
 
diff --git a/drivers/gpu/drm/amd/dal/dc/dce110/dce110_mem_input.c b/drivers/gpu/drm/amd/dal/dc/dce110/dce110_mem_input.c
index e80313a..4761c32 100644
--- a/drivers/gpu/drm/amd/dal/dc/dce110/dce110_mem_input.c
+++ b/drivers/gpu/drm/amd/dal/dc/dce110/dce110_mem_input.c
@@ -402,6 +402,9 @@ bool dce110_mem_input_program_surface_flip_and_addr(
 	}
 
 	mem_input->request_address = *address;
+	if (flip_immediate)
+		mem_input->current_address = *address;
+
 	return true;
 }
 
-- 
2.7.4

