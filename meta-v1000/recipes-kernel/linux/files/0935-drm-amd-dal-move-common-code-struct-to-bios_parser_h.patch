From 1cb245fa5c20405fb320011e8845ed3f9457b2fe Mon Sep 17 00:00:00 2001
From: Tony Cheng <tony.cheng@amd.com>
Date: Wed, 24 Aug 2016 22:44:38 -0400
Subject: [PATCH 0935/1722] drm/amd/dal: move common code / struct to
 bios_parser_helper

Change-Id: Ibbcff07adf2c49c55cf757ade368f09ced19911f
Signed-off-by: Jordan Lazare <Jordan.Lazare@amd.com>
Acked-by: Harry Wentland <harry.wentland@amd.com>
Signed-off-by: Kalyan Alle <kalyan.alle@amd.com>
---
 drivers/gpu/drm/amd/dal/dc/bios/bios_parser.c      | 37 +++++++---------------
 .../gpu/drm/amd/dal/dc/bios/bios_parser_helper.c   | 11 +++++++
 .../gpu/drm/amd/dal/dc/bios/bios_parser_helper.h   | 10 ++++++
 .../amd/dal/dc/bios/bios_parser_types_internal.h   |  3 --
 4 files changed, 32 insertions(+), 29 deletions(-)

diff --git a/drivers/gpu/drm/amd/dal/dc/bios/bios_parser.c b/drivers/gpu/drm/amd/dal/dc/bios/bios_parser.c
index 2fee1a6..54e7880 100644
--- a/drivers/gpu/drm/amd/dal/dc/bios/bios_parser.c
+++ b/drivers/gpu/drm/amd/dal/dc/bios/bios_parser.c
@@ -54,11 +54,8 @@ static const uint8_t ext_display_connection_guid[NUMBER_OF_UCHAR_FOR_GUID] = {
 	0x39, 0x8E, 0x00, 0xA0,
 	0xC9, 0x69, 0x72, 0x3B};
 
-#define GET_IMAGE(type, offset) ((type *) get_image(bp, offset, sizeof(type)))
 #define DATA_TABLES(table) (bp->master_data_tbl->ListOfDataTables.table)
 
-static uint8_t *get_image(struct bios_parser *bp, uint32_t offset,
-	uint32_t size);
 static enum object_type object_type_from_bios_object_id(
 	uint32_t bios_object_id);
 static struct graphics_object_id object_id_from_bios_object_id(
@@ -521,9 +518,7 @@ enum bp_result dc_bios_get_voltage_ddc_info(struct dc_bios *dcb,
 	if (!DATA_TABLES(VoltageObjectInfo))
 		return result;
 
-	voltage_info_address = get_image(bp,
-		DATA_TABLES(VoltageObjectInfo),
-		sizeof(ATOM_COMMON_TABLE_HEADER));
+	voltage_info_address = get_image(&bp->base, DATA_TABLES(VoltageObjectInfo), sizeof(ATOM_COMMON_TABLE_HEADER));
 
 	header = (ATOM_COMMON_TABLE_HEADER *) voltage_info_address;
 
@@ -2653,8 +2648,7 @@ static uint32_t get_dest_obj_list(struct bios_parser *bp,
 		return 0;
 
 	offset += sizeof(uint8_t);
-	*id_list = (uint16_t *)get_image(bp, offset,
-			*number * sizeof(uint16_t));
+	*id_list = (uint16_t *)get_image(&bp->base, offset, *number * sizeof(uint16_t));
 
 	if (!*id_list)
 		return 0;
@@ -2681,8 +2675,7 @@ static uint32_t get_src_obj_list(struct bios_parser *bp, ATOM_OBJECT *object,
 		return 0;
 
 	offset += sizeof(uint8_t);
-	*id_list = (uint16_t *)get_image(bp, offset,
-			*number * sizeof(uint16_t));
+	*id_list = (uint16_t *)get_image(&bp->base, offset, *number * sizeof(uint16_t));
 
 	if (!*id_list)
 		return 0;
@@ -2719,15 +2712,6 @@ static uint32_t get_dst_number_from_object(struct bios_parser *bp,
 	return *number;
 }
 
-static uint8_t *get_image(struct bios_parser *bp,
-	uint32_t offset,
-	uint32_t size)
-{
-	if (bp->bios && offset + size < bp->bios_size)
-		return bp->bios + offset;
-	else
-		return NULL;
-}
 
 static struct graphics_object_id object_id_from_bios_object_id(
 	uint32_t bios_object_id)
@@ -3868,16 +3852,16 @@ static void process_ext_display_connection_info(struct bios_parser *bp,
 		uint8_t *original_bios;
 		/* Step 1: Replace bios image with the new copy which will be
 		 * patched */
-		bp->bios_local_image = dm_alloc(bp->bios_size);
+		bp->bios_local_image = dm_alloc(bp->base.bios_size);
 		if (bp->bios_local_image == NULL) {
 			BREAK_TO_DEBUGGER();
 			/* Failed to alloc bp->bios_local_image */
 			return;
 		}
 
-		memmove(bp->bios_local_image, bp->bios, bp->bios_size);
-		original_bios = bp->bios;
-		bp->bios = bp->bios_local_image;
+		memmove(bp->bios_local_image, bp->base.bios, bp->base.bios_size);
+		original_bios = bp->base.bios;
+		bp->base.bios = bp->bios_local_image;
 		connector_tbl =
 				GET_IMAGE(ATOM_OBJECT_TABLE, connector_tbl_offset);
 
@@ -3892,7 +3876,7 @@ static void process_ext_display_connection_info(struct bios_parser *bp,
 			memmove(
 					bp->bios_local_image,
 					original_bios,
-					bp->bios_size);
+					bp->base.bios_size);
 		}
 
 		/* Step 3: Compact connector table (remove null entries, valid
@@ -4365,10 +4349,11 @@ static bool bios_parser_construct(
 
 	if (!init->bios)
 		return false;
+ 
+        bp->base.bios = init->bios;
+        bp->base.bios_size = bp->base.bios[BIOS_IMAGE_SIZE_OFFSET] * BIOS_IMAGE_SIZE_UNIT;
 
 	bp->ctx = init->ctx;
-	bp->bios = init->bios;
-	bp->bios_size = bp->bios[BIOS_IMAGE_SIZE_OFFSET] * BIOS_IMAGE_SIZE_UNIT;
 	bp->bios_local_image = NULL;
 	bp->lcd_scale = LCD_SCALE_UNKNOWN;
 
diff --git a/drivers/gpu/drm/amd/dal/dc/bios/bios_parser_helper.c b/drivers/gpu/drm/amd/dal/dc/bios/bios_parser_helper.c
index 9da523c..26264f8 100644
--- a/drivers/gpu/drm/amd/dal/dc/bios/bios_parser_helper.c
+++ b/drivers/gpu/drm/amd/dal/dc/bios/bios_parser_helper.c
@@ -66,3 +66,14 @@ bool dal_bios_parser_init_bios_helper(
 		return false;
 	}
 }
+
+
+uint8_t *get_image(struct dc_bios *bp,
+	uint32_t offset,
+	uint32_t size)
+{
+	if (bp->bios && offset + size < bp->bios_size)
+		return bp->bios + offset;
+	else
+		return NULL;
+}
diff --git a/drivers/gpu/drm/amd/dal/dc/bios/bios_parser_helper.h b/drivers/gpu/drm/amd/dal/dc/bios/bios_parser_helper.h
index ada638c..4c14fd3 100644
--- a/drivers/gpu/drm/amd/dal/dc/bios/bios_parser_helper.h
+++ b/drivers/gpu/drm/amd/dal/dc/bios/bios_parser_helper.h
@@ -58,4 +58,14 @@ bool dal_bios_parser_init_bios_helper(
 	struct bios_parser *bp,
 	enum dce_version ver);
 
+
+uint8_t *get_image(struct dc_bios *bp, uint32_t offset,
+	uint32_t size);
+
+#define GET_IMAGE(type, offset) ((type *) get_image(&bp->base, offset, sizeof(type)))
+
+
+
+
+
 #endif
diff --git a/drivers/gpu/drm/amd/dal/dc/bios/bios_parser_types_internal.h b/drivers/gpu/drm/amd/dal/dc/bios/bios_parser_types_internal.h
index e710f76..b555a96 100644
--- a/drivers/gpu/drm/amd/dal/dc/bios/bios_parser_types_internal.h
+++ b/drivers/gpu/drm/amd/dal/dc/bios/bios_parser_types_internal.h
@@ -58,9 +58,6 @@ struct bios_parser {
 	uint32_t object_info_tbl_offset;
 	ATOM_MASTER_DATA_TABLE *master_data_tbl;
 
-	uint8_t *bios;
-	uint32_t bios_size;
-
 #if defined(CONFIG_DRM_AMD_DAL_VBIOS_PRESENT)
 	const struct bios_parser_helper *bios_helper;
 #endif /* CONFIG_DRM_AMD_DAL_VBIOS_PRESENT */
-- 
2.7.4

