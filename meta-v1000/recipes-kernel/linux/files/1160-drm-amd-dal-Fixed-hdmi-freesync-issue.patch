From d2d47ca20d2a591cd7bfde1f2c1c9438d190809c Mon Sep 17 00:00:00 2001
From: Yongqiang Sun <yongqiang.sun@amd.com>
Date: Wed, 28 Sep 2016 16:35:06 -0400
Subject: [PATCH 1160/1722] drm/amd/dal: Fixed hdmi freesync issue.

	Register index isn't increase when programing them.

Change-Id: I4dfcc6a6cfc36aef7766357b775052f34d08ad44
Signed-off-by: Yongqiang Sun <yongqiang.sun@amd.com>
Acked-by: Harry Wentland <harry.wentland@amd.com>
Signed-off-by: Kalyan Alle <kalyan.alle@amd.com>
---
 .../drm/amd/dal/dc/dce110/dce110_stream_encoder.c  | 74 ++++++++--------------
 .../drm/amd/dal/dc/dce110/dce110_stream_encoder.h  | 12 ++++
 2 files changed, 37 insertions(+), 49 deletions(-)

diff --git a/drivers/gpu/drm/amd/dal/dc/dce110/dce110_stream_encoder.c b/drivers/gpu/drm/amd/dal/dc/dce110/dce110_stream_encoder.c
index 7420e11..0f918a0 100644
--- a/drivers/gpu/drm/amd/dal/dc/dce110/dce110_stream_encoder.c
+++ b/drivers/gpu/drm/amd/dal/dc/dce110/dce110_stream_encoder.c
@@ -60,7 +60,6 @@ static void dce110_update_generic_info_packet(
 	const struct encoder_info_packet *info_packet)
 {
 	struct dc_context *ctx = enc110->base.ctx;
-	uint32_t addr;
 	uint32_t regval;
 	/* choose which generic packet to use */
 	{
@@ -86,18 +85,16 @@ static void dce110_update_generic_info_packet(
 		const uint32_t *content =
 			(const uint32_t *) &info_packet->sb[0];
 
-		uint32_t counter = 0;
-
-		addr = REG(AFMT_GENERIC_0);
-
-		do {
-			REG_WRITE(AFMT_GENERIC_0, *content++);
-			++counter;
-		} while (counter < 7);
+		REG_WRITE(AFMT_GENERIC_0, *content++);
+		REG_WRITE(AFMT_GENERIC_1, *content++);
+		REG_WRITE(AFMT_GENERIC_2, *content++);
+		REG_WRITE(AFMT_GENERIC_3, *content++);
+		REG_WRITE(AFMT_GENERIC_4, *content++);
+		REG_WRITE(AFMT_GENERIC_5, *content++);
+		REG_WRITE(AFMT_GENERIC_6, *content);
+		REG_WRITE(AFMT_GENERIC_7, 0);
 	}
 
-	REG_WRITE(AFMT_GENERIC_7, 0);
-
 	/* force double-buffered packet update */
 	{
 		REG_UPDATE_2(AFMT_VBI_PACKET_CONTROL,
@@ -114,8 +111,6 @@ static void dce110_update_hdmi_info_packet(
 {
 	struct dc_context *ctx = enc110->base.ctx;
 	uint32_t cont, send, line;
-	uint32_t addr;
-
 
 	if (info_packet->valid) {
 		dce110_update_generic_info_packet(
@@ -137,48 +132,30 @@ static void dce110_update_hdmi_info_packet(
 	}
 
 	/* choose which generic packet control to use */
-
 	switch (packet_index) {
 	case 0:
-	case 1:
-		addr = REG(HDMI_GENERIC_PACKET_CONTROL0);
+		REG_UPDATE_3(HDMI_GENERIC_PACKET_CONTROL0,
+				HDMI_GENERIC0_CONT, cont,
+				HDMI_GENERIC0_SEND, send,
+				HDMI_GENERIC0_LINE, line);
 		break;
-	case 2:
-	case 3:
-		addr = REG(HDMI_GENERIC_PACKET_CONTROL1);
+	case 1:
+		REG_UPDATE_3(HDMI_GENERIC_PACKET_CONTROL0,
+				HDMI_GENERIC1_CONT, cont,
+				HDMI_GENERIC1_SEND, send,
+				HDMI_GENERIC1_LINE, line);
 		break;
-	default:
-		/* invalid HW packet index */
-		dal_logger_write(
-			ctx->logger,
-			LOG_MAJOR_WARNING,
-			LOG_MINOR_COMPONENT_ENCODER,
-			"Invalid HW packet index: %s()\n",
-			__func__);
-		return;
-	}
-
-	switch (packet_index) {
-	case 0:
 	case 2:
-		REG_SET_3(
-			HDMI_GENERIC_PACKET_CONTROL0,
-			dm_read_reg(CTX, addr),
-			HDMI_GENERIC0_CONT, cont,
-			HDMI_GENERIC0_SEND, send,
-			HDMI_GENERIC0_LINE, line);
-
-
+		REG_UPDATE_3(HDMI_GENERIC_PACKET_CONTROL1,
+				HDMI_GENERIC2_CONT, cont,
+				HDMI_GENERIC2_SEND, send,
+				HDMI_GENERIC2_LINE, line);
 		break;
-	case 1:
 	case 3:
-		REG_SET_3(
-			HDMI_GENERIC_PACKET_CONTROL0,
-			dm_read_reg(CTX, addr),
-			HDMI_GENERIC1_CONT, cont,
-			HDMI_GENERIC1_SEND, send,
-			HDMI_GENERIC1_LINE, line);
-
+		REG_UPDATE_3(HDMI_GENERIC_PACKET_CONTROL1,
+				HDMI_GENERIC3_CONT, cont,
+				HDMI_GENERIC3_SEND, send,
+				HDMI_GENERIC3_LINE, line);
 		break;
 	default:
 		/* invalid HW packet index */
@@ -190,7 +167,6 @@ static void dce110_update_hdmi_info_packet(
 			__func__);
 		return;
 	}
-
 }
 
 /* setup stream encoder in dp mode */
diff --git a/drivers/gpu/drm/amd/dal/dc/dce110/dce110_stream_encoder.h b/drivers/gpu/drm/amd/dal/dc/dce110/dce110_stream_encoder.h
index 85ecf90..699e8cd 100644
--- a/drivers/gpu/drm/amd/dal/dc/dce110/dce110_stream_encoder.h
+++ b/drivers/gpu/drm/amd/dal/dc/dce110/dce110_stream_encoder.h
@@ -37,6 +37,12 @@
 	SRI(AFMT_AVI_INFO2, DIG, id), \
 	SRI(AFMT_AVI_INFO3, DIG, id), \
 	SRI(AFMT_GENERIC_0, DIG, id), \
+	SRI(AFMT_GENERIC_1, DIG, id), \
+	SRI(AFMT_GENERIC_2, DIG, id), \
+	SRI(AFMT_GENERIC_3, DIG, id), \
+	SRI(AFMT_GENERIC_4, DIG, id), \
+	SRI(AFMT_GENERIC_5, DIG, id), \
+	SRI(AFMT_GENERIC_6, DIG, id), \
 	SRI(AFMT_GENERIC_7, DIG, id), \
 	SRI(AFMT_GENERIC_HDR, DIG, id), \
 	SRI(AFMT_INFOFRAME_CONTROL0, DIG, id), \
@@ -87,6 +93,12 @@ struct dce110_stream_enc_registers {
 	uint32_t AFMT_AVI_INFO2;
 	uint32_t AFMT_AVI_INFO3;
 	uint32_t AFMT_GENERIC_0;
+	uint32_t AFMT_GENERIC_1;
+	uint32_t AFMT_GENERIC_2;
+	uint32_t AFMT_GENERIC_3;
+	uint32_t AFMT_GENERIC_4;
+	uint32_t AFMT_GENERIC_5;
+	uint32_t AFMT_GENERIC_6;
 	uint32_t AFMT_GENERIC_7;
 	uint32_t AFMT_GENERIC_HDR;
 	uint32_t AFMT_INFOFRAME_CONTROL0;
-- 
2.7.4

