From 8b4510618fe10064f006bc132712e985ab2df63c Mon Sep 17 00:00:00 2001
From: Slava Grigorev <slava.grigorev@amd.com>
Date: Thu, 16 Jan 2014 17:35:26 -0500
Subject: [PATCH 17/27] radeon/vce: Fixed bitstream (frame) size calculation
 after encode feedback is received

Signed-off-by: Slava Grigorev <slava.grigorev@amd.com>
---
 src/gallium/drivers/radeon/radeon_vce.c |    8 +++++++-
 1 file changed, 7 insertions(+), 1 deletion(-)

diff --git a/src/gallium/drivers/radeon/radeon_vce.c b/src/gallium/drivers/radeon/radeon_vce.c
index 8fdb898..fd0b24e 100644
--- a/src/gallium/drivers/radeon/radeon_vce.c
+++ b/src/gallium/drivers/radeon/radeon_vce.c
@@ -175,7 +175,13 @@ static void rvce_get_feedback(struct pipe_video_codec *encoder,
 
 	if (size) {
 		uint32_t *ptr = enc->ws->buffer_map(fb->cs_handle, enc->cs, PIPE_TRANSFER_READ_WRITE);
-		*size = ptr[4] - ptr[7];
+
+		if (ptr[1]) {
+			*size = ptr[4] - ptr[9];
+		} else {
+			*size = 0;
+		}
+
 		enc->ws->buffer_unmap(fb->cs_handle);
 	}
 	//dump_feedback(enc, fb);
-- 
1.7.9.5

