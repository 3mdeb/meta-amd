From 032e7d96c85ec3fdac5a8fc5109a529a38d99abe Mon Sep 17 00:00:00 2001
From: Zeyu Fan <Zeyu.Fan@amd.com>
Date: Wed, 19 Oct 2016 17:17:26 -0400
Subject: [PATCH 1352/1722] drm/amd/dal: Redefine stream encoder number caps
 for each version.

Change-Id: I003c5341814de0d2604c445ca682722a762d6abb
Signed-off-by: Zeyu Fan <Zeyu.Fan@amd.com>
Acked-by: Harry Wentland <harry.wentland@amd.com>
---
 drivers/gpu/drm/amd/dal/dc/core/dc_resource.c       | 5 +++--
 drivers/gpu/drm/amd/dal/dc/dce100/dce100_resource.c | 2 +-
 drivers/gpu/drm/amd/dal/dc/dce110/dce110_resource.c | 7 ++-----
 drivers/gpu/drm/amd/dal/dc/dce112/dce112_resource.c | 6 ++----
 drivers/gpu/drm/amd/dal/dc/dce80/dce80_resource.c   | 2 +-
 drivers/gpu/drm/amd/dal/dc/inc/resource.h           | 1 +
 6 files changed, 10 insertions(+), 13 deletions(-)

diff --git a/drivers/gpu/drm/amd/dal/dc/core/dc_resource.c b/drivers/gpu/drm/amd/dal/dc/core/dc_resource.c
index a0980dd..28bbc71 100644
--- a/drivers/gpu/drm/amd/dal/dc/core/dc_resource.c
+++ b/drivers/gpu/drm/amd/dal/dc/core/dc_resource.c
@@ -169,8 +169,8 @@ bool resource_construct(
 		pool->audio_count++;
 	}
 
-
-	for (i = 0; i < pool->stream_enc_count; i++) {
+	pool->stream_enc_count = 0;
+	for (i = 0; i < caps->num_stream_encoder; i++) {
 		/* TODO: rework fragile code*/
 		if (pool->stream_engines.u_all & 1 << i) {
 			pool->stream_enc[i] = create_funcs->create_stream_encoder(
@@ -178,6 +178,7 @@ bool resource_construct(
 			if (pool->stream_enc[i] == NULL)
 				DC_ERR("DC: failed to create stream_encoder!\n");
 		}
+		pool->stream_enc_count++;
 	}
 
 	for (i = 0; i < num_virtual_links; i++) {
diff --git a/drivers/gpu/drm/amd/dal/dc/dce100/dce100_resource.c b/drivers/gpu/drm/amd/dal/dc/dce100/dce100_resource.c
index 12d62ea..f1ca073 100644
--- a/drivers/gpu/drm/amd/dal/dc/dce100/dce100_resource.c
+++ b/drivers/gpu/drm/amd/dal/dc/dce100/dce100_resource.c
@@ -361,6 +361,7 @@ static const struct dce110_opp_reg_offsets dce100_opp_reg_offsets[] = {
 
 static const struct resource_caps res_cap = {
 	.num_audio = 6,
+	.num_stream_encoder = 6
 };
 
 #define CTX  ctx
@@ -936,7 +937,6 @@ static bool construct(
 	*************************************************/
 	pool->base.underlay_pipe_index = -1;
 	pool->base.pipe_count = dal_adapter_service_get_func_controllers_num(as);
-	pool->base.stream_enc_count = dal_adapter_service_get_stream_engines_num(as);
 	pool->base.scaler_filter = dal_scaler_filter_create(ctx);
 	dc->public.caps.max_downscale_ratio = 200;
 	dc->public.caps.i2c_speed_in_khz = 40;
diff --git a/drivers/gpu/drm/amd/dal/dc/dce110/dce110_resource.c b/drivers/gpu/drm/amd/dal/dc/dce110/dce110_resource.c
index 18ee44e..696e8e7 100644
--- a/drivers/gpu/drm/amd/dal/dc/dce110/dce110_resource.c
+++ b/drivers/gpu/drm/amd/dal/dc/dce110/dce110_resource.c
@@ -253,11 +253,7 @@ static const struct dce110_link_enc_registers link_enc_regs[] = {
 static const struct dce110_stream_enc_registers stream_enc_regs[] = {
 	stream_enc_regs(0),
 	stream_enc_regs(1),
-	stream_enc_regs(2),
-	stream_enc_regs(3),
-	stream_enc_regs(4),
-	stream_enc_regs(5),
-	stream_enc_regs(6),
+	stream_enc_regs(2)
 };
 
 #define audio_regs(id)\
@@ -331,6 +327,7 @@ static const struct dce110_clk_src_reg_offsets dce110_clk_src_reg_offsets[] = {
 
 static const struct resource_caps res_cap = {
 	.num_audio = 3,
+	.num_stream_encoder = 3
 };
 
 #define CTX  ctx
diff --git a/drivers/gpu/drm/amd/dal/dc/dce112/dce112_resource.c b/drivers/gpu/drm/amd/dal/dc/dce112/dce112_resource.c
index f4f7645..99d8f13 100644
--- a/drivers/gpu/drm/amd/dal/dc/dce112/dce112_resource.c
+++ b/drivers/gpu/drm/amd/dal/dc/dce112/dce112_resource.c
@@ -307,8 +307,7 @@ static const struct dce_audio_registers audio_regs[] = {
 	audio_regs(2),
 	audio_regs(3),
 	audio_regs(4),
-	audio_regs(5),
-	audio_regs(6),
+	audio_regs(5)
 };
 
 static const struct dce_audio_shift audio_shift = {
@@ -378,6 +377,7 @@ static const struct dce112_clk_src_reg_offsets dce112_clk_src_reg_offsets[] = {
 
 static const struct resource_caps res_cap = {
 	.num_audio = 6,
+	.num_stream_encoder = 6
 };
 
 #define CTX  ctx
@@ -1179,8 +1179,6 @@ static bool construct(
 	pool->base.underlay_pipe_index = -1;
 	pool->base.pipe_count =
 		dal_adapter_service_get_func_controllers_num(adapter_serv);
-	pool->base.stream_enc_count =
-		dal_adapter_service_get_stream_engines_num(adapter_serv);
 	dc->public.caps.max_downscale_ratio = 200;
 	dc->public.caps.i2c_speed_in_khz = 100;
 
diff --git a/drivers/gpu/drm/amd/dal/dc/dce80/dce80_resource.c b/drivers/gpu/drm/amd/dal/dc/dce80/dce80_resource.c
index 78413dc..506b93f 100644
--- a/drivers/gpu/drm/amd/dal/dc/dce80/dce80_resource.c
+++ b/drivers/gpu/drm/amd/dal/dc/dce80/dce80_resource.c
@@ -351,6 +351,7 @@ static const struct dce110_clk_src_reg_offsets dce80_clk_src_reg_offsets[] = {
 
 static const struct resource_caps res_cap = {
 	.num_audio = 6,
+	.num_stream_encoder = 6
 };
 
 #define CTX  ctx
@@ -855,7 +856,6 @@ static bool construct(
 	 *************************************************/
 	pool->base.underlay_pipe_index = -1;
 	pool->base.pipe_count = dal_adapter_service_get_func_controllers_num(as);
-	pool->base.stream_enc_count = dal_adapter_service_get_stream_engines_num(as);
 	dc->public.caps.max_downscale_ratio = 200;
 	dc->public.caps.i2c_speed_in_khz = 40;
 
diff --git a/drivers/gpu/drm/amd/dal/dc/inc/resource.h b/drivers/gpu/drm/amd/dal/dc/inc/resource.h
index 5eb7399..20a3b08 100644
--- a/drivers/gpu/drm/amd/dal/dc/inc/resource.h
+++ b/drivers/gpu/drm/amd/dal/dc/inc/resource.h
@@ -38,6 +38,7 @@ enum dce_version resource_parse_asic_id(
 
 struct resource_caps {
 	int num_audio;
+	int num_stream_encoder;
 };
 
 struct resource_straps {
-- 
2.7.4

