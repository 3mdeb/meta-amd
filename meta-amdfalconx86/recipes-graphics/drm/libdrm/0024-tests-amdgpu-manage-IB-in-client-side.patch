From 3179dae1656ac39755309d0f06fb6459a9bd1994 Mon Sep 17 00:00:00 2001
From: Jammy Zhou <Jammy.Zhou@amd.com>
Date: Mon, 25 May 2015 20:38:03 +0800
Subject: [PATCH 24/55] tests/amdgpu: manage IB in client side
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Signed-off-by: Jammy Zhou <Jammy.Zhou@amd.com>
Reviewed-by: Christian KÃ¶nig <christian.koenig@amd.com>
Signed-off-by: Arindam Nath <arindam.nath@amd.com>
---
 tests/amdgpu/basic_tests.c | 15 +++++++++++++++
 tests/amdgpu/cs_tests.c    |  7 -------
 2 files changed, 15 insertions(+), 7 deletions(-)

diff --git a/tests/amdgpu/basic_tests.c b/tests/amdgpu/basic_tests.c
index 67a8d3c..0ae25d6 100644
--- a/tests/amdgpu/basic_tests.c
+++ b/tests/amdgpu/basic_tests.c
@@ -210,6 +210,12 @@ static void amdgpu_command_submission_gfx_separate_ibs(void)
 	r = amdgpu_cs_query_fence_status(&fence_status, &expired);
 	CU_ASSERT_EQUAL(r, 0);
 
+	r = amdgpu_cs_free_ib(ib_result.handle);
+	CU_ASSERT_EQUAL(r, 0);
+
+	r = amdgpu_cs_free_ib(ib_result_ce.handle);
+	CU_ASSERT_EQUAL(r, 0);
+
 	r = amdgpu_cs_ctx_free(context_handle);
 	CU_ASSERT_EQUAL(r, 0);
 }
@@ -266,6 +272,9 @@ static void amdgpu_command_submission_gfx_shared_ib(void)
 	r = amdgpu_cs_query_fence_status(&fence_status, &expired);
 	CU_ASSERT_EQUAL(r, 0);
 
+	r = amdgpu_cs_free_ib(ib_result.handle);
+	CU_ASSERT_EQUAL(r, 0);
+
 	r = amdgpu_cs_ctx_free(context_handle);
 	CU_ASSERT_EQUAL(r, 0);
 }
@@ -324,6 +333,9 @@ static void amdgpu_command_submission_compute(void)
 
 		r = amdgpu_cs_query_fence_status(&fence_status, &expired);
 		CU_ASSERT_EQUAL(r, 0);
+
+		r = amdgpu_cs_free_ib(ib_result.handle);
+		CU_ASSERT_EQUAL(r, 0);
 	}
 
 	r = amdgpu_cs_ctx_free(context_handle);
@@ -394,6 +406,9 @@ static void amdgpu_sdma_test_exec_cs(amdgpu_context_handle context_handle,
 	r = amdgpu_cs_query_fence_status(&fence_status, &expired);
 	CU_ASSERT_EQUAL(r, 0);
 	CU_ASSERT_EQUAL(expired, true);
+
+	r = amdgpu_cs_free_ib(ib_result.handle);
+	CU_ASSERT_EQUAL(r, 0);
 }
 
 static void amdgpu_command_submission_sdma_write_linear(void)
diff --git a/tests/amdgpu/cs_tests.c b/tests/amdgpu/cs_tests.c
index 6d485ae..5fb11b1 100644
--- a/tests/amdgpu/cs_tests.c
+++ b/tests/amdgpu/cs_tests.c
@@ -133,13 +133,6 @@ static int submit(unsigned ndw, unsigned ip)
 	if (r)
 		return r;
 
-	r = amdgpu_cs_alloc_ib(context_handle, IB_SIZE, &ib_result);
-	if (r)
-		return r;
-
-	ib_handle = ib_result.handle;
-	ib_cpu = ib_result.cpu;
-
 	fence_status.context = context_handle;
 	fence_status.timeout_ns = AMDGPU_TIMEOUT_INFINITE;
 	fence_status.ip_type = ip;
-- 
1.9.1

