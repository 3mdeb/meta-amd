From c571ab9ef3a48060ff8f9ee8b7eaa57a629abf71 Mon Sep 17 00:00:00 2001
From: Harry Wentland <harry.wentland@amd.com>
Date: Wed, 12 Oct 2016 20:05:07 -0400
Subject: [PATCH 1319/1722] drm/amd/dal: Removing more unnecessary gpio
 indirection

Change-Id: Id7aa047dd273ecf4a80f278327837ad16a141ee4
Signed-off-by: Harry Wentland <harry.wentland@amd.com>
Acked-by: Harry Wentland <harry.wentland@amd.com>
---
 drivers/gpu/drm/amd/dal/dc/bios/bios_parser.c      |  4 +-
 drivers/gpu/drm/amd/dal/dc/core/dc_link.c          |  2 +-
 drivers/gpu/drm/amd/dal/dc/core/dc_link_ddc.c      |  4 +-
 drivers/gpu/drm/amd/dal/dc/gpio/ddc.c              | 17 +++-----
 drivers/gpu/drm/amd/dal/dc/gpio/ddc.h              | 38 -----------------
 drivers/gpu/drm/amd/dal/dc/gpio/gpio.h             | 48 ----------------------
 drivers/gpu/drm/amd/dal/dc/gpio/gpio_base.c        |  6 ---
 drivers/gpu/drm/amd/dal/dc/gpio/gpio_service.c     | 33 ---------------
 drivers/gpu/drm/amd/dal/dc/gpio/irq.c              | 11 +----
 drivers/gpu/drm/amd/dal/dc/gpio/irq.h              | 34 ---------------
 .../drm/amd/dal/include/gpio_service_interface.h   | 46 ++++++++++++++-------
 11 files changed, 43 insertions(+), 200 deletions(-)
 delete mode 100644 drivers/gpu/drm/amd/dal/dc/gpio/ddc.h
 delete mode 100644 drivers/gpu/drm/amd/dal/dc/gpio/gpio.h
 delete mode 100644 drivers/gpu/drm/amd/dal/dc/gpio/irq.h

diff --git a/drivers/gpu/drm/amd/dal/dc/bios/bios_parser.c b/drivers/gpu/drm/amd/dal/dc/bios/bios_parser.c
index 5d91cf7..f98f288 100644
--- a/drivers/gpu/drm/amd/dal/dc/bios/bios_parser.c
+++ b/drivers/gpu/drm/amd/dal/dc/bios/bios_parser.c
@@ -2932,7 +2932,7 @@ static bool i2c_read(
 		i2c_info->i2c_hw_assist,
 		i2c_info->i2c_line };
 
-	ddc = dal_gpio_service_create_ddc(as->gpio_service,
+	ddc = dal_gpio_create_ddc(as->gpio_service,
 		i2c_info->gpio_info.clk_a_register_index,
 		(1 << i2c_info->gpio_info.clk_a_shift), &hw_info);
 
@@ -2969,7 +2969,7 @@ static bool i2c_read(
 				&cmd);
 	}
 
-	dal_gpio_service_destroy_ddc(&ddc);
+	dal_gpio_destroy_ddc(&ddc);
 
 	return result;
 }
diff --git a/drivers/gpu/drm/amd/dal/dc/core/dc_link.c b/drivers/gpu/drm/amd/dal/dc/core/dc_link.c
index 21588be..de2855a 100644
--- a/drivers/gpu/drm/amd/dal/dc/core/dc_link.c
+++ b/drivers/gpu/drm/amd/dal/dc/core/dc_link.c
@@ -347,7 +347,7 @@ static bool is_dp_sink_present(struct core_link *link)
 
 	if (GPIO_RESULT_OK != dal_ddc_open(
 		ddc, GPIO_MODE_INPUT, GPIO_DDC_CONFIG_TYPE_MODE_I2C)) {
-		dal_gpio_service_destroy_ddc(&ddc);
+		dal_gpio_destroy_ddc(&ddc);
 
 		return present;
 	}
diff --git a/drivers/gpu/drm/amd/dal/dc/core/dc_link_ddc.c b/drivers/gpu/drm/amd/dal/dc/core/dc_link_ddc.c
index 55166e5..44f7d06 100644
--- a/drivers/gpu/drm/amd/dal/dc/core/dc_link_ddc.c
+++ b/drivers/gpu/drm/amd/dal/dc/core/dc_link_ddc.c
@@ -295,7 +295,7 @@ static bool construct(
 		hw_info.ddc_channel = i2c_info.i2c_line;
 		hw_info.hw_supported = i2c_info.i2c_hw_assist;
 
-		ddc_service->ddc_pin = dal_gpio_service_create_ddc(
+		ddc_service->ddc_pin = dal_gpio_create_ddc(
 			gpio_service,
 			i2c_info.gpio_info.clk_a_register_index,
 			1 << i2c_info.gpio_info.clk_a_shift,
@@ -340,7 +340,7 @@ struct ddc_service *dal_ddc_service_create(
 static void destruct(struct ddc_service *ddc)
 {
 	if (ddc->ddc_pin)
-		dal_gpio_service_destroy_ddc(&ddc->ddc_pin);;
+		dal_gpio_destroy_ddc(&ddc->ddc_pin);
 }
 
 void dal_ddc_service_destroy(struct ddc_service **ddc)
diff --git a/drivers/gpu/drm/amd/dal/dc/gpio/ddc.c b/drivers/gpu/drm/amd/dal/dc/gpio/ddc.c
index 4aa8901..9b46924 100644
--- a/drivers/gpu/drm/amd/dal/dc/gpio/ddc.c
+++ b/drivers/gpu/drm/amd/dal/dc/gpio/ddc.c
@@ -36,13 +36,6 @@
 #include "hw_translate.h"
 #include "hw_factory.h"
 #include "gpio_service.h"
-#include "gpio.h"
-
-/*
- * Header of this unit
- */
-
-#include "ddc.h"
 
 /*
  * Post-requisites: headers required by this unit
@@ -236,7 +229,7 @@ struct ddc *dal_gpio_create_ddc(
 		return NULL;
 	}
 
-	ddc->pin_data = dal_gpio_service_create_gpio(
+	ddc->pin_data = dal_gpio_create(
 		service, GPIO_ID_DDC_DATA, en, GPIO_PIN_OUTPUT_STATE_DEFAULT);
 
 	if (!ddc->pin_data) {
@@ -244,7 +237,7 @@ struct ddc *dal_gpio_create_ddc(
 		goto failure_1;
 	}
 
-	ddc->pin_clock = dal_gpio_service_create_gpio(
+	ddc->pin_clock = dal_gpio_create(
 		service, GPIO_ID_DDC_CLOCK, en, GPIO_PIN_OUTPUT_STATE_DEFAULT);
 
 	if (!ddc->pin_clock) {
@@ -259,7 +252,7 @@ struct ddc *dal_gpio_create_ddc(
 	return ddc;
 
 failure_2:
-	dal_gpio_service_destroy_gpio(&ddc->pin_data);
+	dal_gpio_destroy(&ddc->pin_data);
 
 failure_1:
 	dm_free(ddc);
@@ -270,8 +263,8 @@ failure_1:
 static void destruct(struct ddc *ddc)
 {
 	dal_ddc_close(ddc);
-	dal_gpio_service_destroy_gpio(&ddc->pin_data);
-	dal_gpio_service_destroy_gpio(&ddc->pin_clock);
+	dal_gpio_destroy(&ddc->pin_data);
+	dal_gpio_destroy(&ddc->pin_clock);
 
 }
 
diff --git a/drivers/gpu/drm/amd/dal/dc/gpio/ddc.h b/drivers/gpu/drm/amd/dal/dc/gpio/ddc.h
deleted file mode 100644
index 500c3cd..0000000
--- a/drivers/gpu/drm/amd/dal/dc/gpio/ddc.h
+++ /dev/null
@@ -1,38 +0,0 @@
-/*
- * Copyright 2012-15 Advanced Micro Devices, Inc.
- *
- * Permission is hereby granted, free of charge, to any person obtaining a
- * copy of this software and associated documentation files (the "Software"),
- * to deal in the Software without restriction, including without limitation
- * the rights to use, copy, modify, merge, publish, distribute, sublicense,
- * and/or sell copies of the Software, and to permit persons to whom the
- * Software is furnished to do so, subject to the following conditions:
- *
- * The above copyright notice and this permission notice shall be included in
- * all copies or substantial portions of the Software.
- *
- * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
- * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
- * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL
- * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR
- * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,
- * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
- * OTHER DEALINGS IN THE SOFTWARE.
- *
- * Authors: AMD
- *
- */
-
-#ifndef __DAL_DDC_H__
-#define __DAL_DDC_H__
-
-struct ddc *dal_gpio_create_ddc(
-	struct gpio_service *service,
-	uint32_t offset,
-	uint32_t mask,
-	struct gpio_ddc_hw_info *info);
-
-void dal_gpio_destroy_ddc(
-	struct ddc **ddc);
-
-#endif
diff --git a/drivers/gpu/drm/amd/dal/dc/gpio/gpio.h b/drivers/gpu/drm/amd/dal/dc/gpio/gpio.h
deleted file mode 100644
index 7fcbb69..0000000
--- a/drivers/gpu/drm/amd/dal/dc/gpio/gpio.h
+++ /dev/null
@@ -1,48 +0,0 @@
-/*
- * Copyright 2012-15 Advanced Micro Devices, Inc.
- *
- * Permission is hereby granted, free of charge, to any person obtaining a
- * copy of this software and associated documentation files (the "Software"),
- * to deal in the Software without restriction, including without limitation
- * the rights to use, copy, modify, merge, publish, distribute, sublicense,
- * and/or sell copies of the Software, and to permit persons to whom the
- * Software is furnished to do so, subject to the following conditions:
- *
- * The above copyright notice and this permission notice shall be included in
- * all copies or substantial portions of the Software.
- *
- * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
- * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
- * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL
- * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR
- * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,
- * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
- * OTHER DEALINGS IN THE SOFTWARE.
- *
- * Authors: AMD
- *
- */
-
-#ifndef __DAL_GPIO_H__
-#define __DAL_GPIO_H__
-
-struct gpio {
-	struct gpio_service *service;
-	struct hw_gpio_pin *pin;
-	enum gpio_id id;
-	uint32_t en;
-	enum gpio_mode mode;
-	/* when GPIO comes from VBIOS, it has defined output state */
-	enum gpio_pin_output_state output_state;
-};
-
-struct gpio *dal_gpio_create(
-	struct gpio_service *service,
-	enum gpio_id id,
-	uint32_t en,
-	enum gpio_pin_output_state output_state);
-
-void dal_gpio_destroy(
-	struct gpio **ptr);
-
-#endif
diff --git a/drivers/gpu/drm/amd/dal/dc/gpio/gpio_base.c b/drivers/gpu/drm/amd/dal/dc/gpio/gpio_base.c
index eeefaa2..d947933 100644
--- a/drivers/gpu/drm/amd/dal/dc/gpio/gpio_base.c
+++ b/drivers/gpu/drm/amd/dal/dc/gpio/gpio_base.c
@@ -37,12 +37,6 @@
 #include "gpio_service.h"
 
 /*
- * Header of this unit
- */
-
-#include "gpio.h"
-
-/*
  * Post-requisites: headers required by this unit
  */
 
diff --git a/drivers/gpu/drm/amd/dal/dc/gpio/gpio_service.c b/drivers/gpu/drm/amd/dal/dc/gpio/gpio_service.c
index 84e5666..b0350f8 100644
--- a/drivers/gpu/drm/amd/dal/dc/gpio/gpio_service.c
+++ b/drivers/gpu/drm/amd/dal/dc/gpio/gpio_service.c
@@ -46,9 +46,6 @@
  */
 
 #include "hw_gpio_pin.h"
-#include "gpio.h"
-#include "ddc.h"
-#include "irq.h"
 
 /*
  * This unit
@@ -148,36 +145,6 @@ failure_1:
 	return NULL;
 }
 
-struct gpio *dal_gpio_service_create_gpio(
-	struct gpio_service *service,
-	enum gpio_id id,
-	uint32_t en,
-	enum gpio_pin_output_state output_state)
-{
-	return dal_gpio_create(service, id, en, output_state);
-}
-
-void dal_gpio_service_destroy_gpio(
-	struct gpio **gpio)
-{
-	dal_gpio_destroy(gpio);
-}
-
-struct ddc *dal_gpio_service_create_ddc(
-	struct gpio_service *service,
-	uint32_t offset,
-	uint32_t mask,
-	struct gpio_ddc_hw_info *info)
-{
-	return dal_gpio_create_ddc(service, offset, mask, info);
-}
-
-void dal_gpio_service_destroy_ddc(
-	struct ddc **ddc)
-{
-	dal_gpio_destroy_ddc(ddc);
-}
-
 struct gpio *dal_gpio_service_create_irq(
 	struct gpio_service *service,
 	uint32_t offset,
diff --git a/drivers/gpu/drm/amd/dal/dc/gpio/irq.c b/drivers/gpu/drm/amd/dal/dc/gpio/irq.c
index 23bb75a..24537a9 100644
--- a/drivers/gpu/drm/amd/dal/dc/gpio/irq.c
+++ b/drivers/gpu/drm/amd/dal/dc/gpio/irq.c
@@ -35,13 +35,6 @@
 #include "hw_translate.h"
 #include "hw_factory.h"
 #include "gpio_service.h"
-#include "gpio.h"
-
-/*
- * Header of this unit
- */
-
-#include "irq.h"
 
 /*
  * Post-requisites: headers required by this unit
@@ -114,7 +107,7 @@ struct gpio *dal_gpio_create_irq(
 		return NULL;
 	}
 
-	irq = dal_gpio_service_create_gpio(
+	irq = dal_gpio_create(
 		service, id, en, GPIO_PIN_OUTPUT_STATE_DEFAULT);
 
 	if (irq)
@@ -127,7 +120,7 @@ struct gpio *dal_gpio_create_irq(
 static void destruct(struct gpio *irq)
 {
 	dal_gpio_close(irq);
-	dal_gpio_service_destroy_gpio(&irq);
+	dal_gpio_destroy(&irq);
 
 }
 
diff --git a/drivers/gpu/drm/amd/dal/dc/gpio/irq.h b/drivers/gpu/drm/amd/dal/dc/gpio/irq.h
deleted file mode 100644
index 8a016a1..0000000
--- a/drivers/gpu/drm/amd/dal/dc/gpio/irq.h
+++ /dev/null
@@ -1,34 +0,0 @@
-/*
- * Copyright 2012-15 Advanced Micro Devices, Inc.
- *
- * Permission is hereby granted, free of charge, to any person obtaining a
- * copy of this software and associated documentation files (the "Software"),
- * to deal in the Software without restriction, including without limitation
- * the rights to use, copy, modify, merge, publish, distribute, sublicense,
- * and/or sell copies of the Software, and to permit persons to whom the
- * Software is furnished to do so, subject to the following conditions:
- *
- * The above copyright notice and this permission notice shall be included in
- * all copies or substantial portions of the Software.
- *
- * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
- * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
- * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL
- * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR
- * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,
- * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
- * OTHER DEALINGS IN THE SOFTWARE.
- *
- * Authors: AMD
- *
- */
-
-#ifndef __DAL_IRQ_H__
-#define __DAL_IRQ_H__
-
-struct gpio *dal_gpio_create_irq(
-	struct gpio_service *service,
-	enum gpio_id id,
-	uint32_t en);
-
-#endif
diff --git a/drivers/gpu/drm/amd/dal/include/gpio_service_interface.h b/drivers/gpu/drm/amd/dal/include/gpio_service_interface.h
index 9da9057..cd93567 100644
--- a/drivers/gpu/drm/amd/dal/include/gpio_service_interface.h
+++ b/drivers/gpu/drm/amd/dal/include/gpio_service_interface.h
@@ -33,28 +33,29 @@
 
 struct gpio_service;
 
-struct gpio_service *dal_gpio_service_create(
-	enum dce_version dce_version_major,
-	enum dce_version dce_version_minor,
-	struct dc_context *ctx);
+struct gpio {
+	struct gpio_service *service;
+	struct hw_gpio_pin *pin;
+	enum gpio_id id;
+	uint32_t en;
+	enum gpio_mode mode;
+	/* when GPIO comes from VBIOS, it has defined output state */
+	enum gpio_pin_output_state output_state;
+};
 
-struct gpio *dal_gpio_service_create_gpio(
+struct gpio *dal_gpio_create(
 	struct gpio_service *service,
 	enum gpio_id id,
 	uint32_t en,
 	enum gpio_pin_output_state output_state);
 
-void dal_gpio_service_destroy_gpio(
-	struct gpio **gpio);
-
-struct ddc *dal_gpio_service_create_ddc(
-	struct gpio_service *service,
-	uint32_t offset,
-	uint32_t mask,
-	struct gpio_ddc_hw_info *info);
+void dal_gpio_destroy(
+	struct gpio **ptr);
 
-void dal_gpio_service_destroy_ddc(
-	struct ddc **ddc);
+struct gpio_service *dal_gpio_service_create(
+	enum dce_version dce_version_major,
+	enum dce_version dce_version_minor,
+	struct dc_context *ctx);
 
 struct gpio *dal_gpio_service_create_irq(
 	struct gpio_service *service,
@@ -64,9 +65,24 @@ struct gpio *dal_gpio_service_create_irq(
 void dal_gpio_service_destroy_irq(
 	struct gpio **ptr);
 
+struct ddc *dal_gpio_create_ddc(
+	struct gpio_service *service,
+	uint32_t offset,
+	uint32_t mask,
+	struct gpio_ddc_hw_info *info);
+
+
+void dal_gpio_destroy_ddc(
+	struct ddc **ddc);
+
 void dal_gpio_service_destroy(
 	struct gpio_service **ptr);
 
+struct gpio *dal_gpio_create_irq(
+	struct gpio_service *service,
+	enum gpio_id id,
+	uint32_t en);
+
 void dal_gpio_destroy_irq(
 	struct gpio **ptr);
 
-- 
2.7.4

