From 6bddeee7c322cdd80cd6e9eaa23201de495bae16 Mon Sep 17 00:00:00 2001
From: Clark Zheng <clark.zheng@amd.com>
Date: Thu, 2 Jul 2015 12:24:31 +0800
Subject: [PATCH 331/401] drm/amdgpu: Add blanking before reconfiguration front
 end

Signed-off-by: Sanjay R Mehta <sanju.mehta@amd.com>
---
 drivers/gpu/drm/amd/amdgpu/amdgpu_dm_types.c | 19 +++++++++++++------
 1 file changed, 13 insertions(+), 6 deletions(-)

diff --git a/drivers/gpu/drm/amd/amdgpu/amdgpu_dm_types.c b/drivers/gpu/drm/amd/amdgpu/amdgpu_dm_types.c
index 099816a..2dd2341 100644
--- a/drivers/gpu/drm/amd/amdgpu/amdgpu_dm_types.c
+++ b/drivers/gpu/drm/amd/amdgpu/amdgpu_dm_types.c
@@ -553,7 +553,6 @@ bool amdgpu_dm_mode_set(
 	amdgpu_dm_fill_surface_address(crtc, &addr_flip_info, afb, old_fb);
 
 	dal_set_blanking(adev->dm.dal, acrtc->crtc_id, false);
-
 	/* Turn vblank on after reset */
 	drm_crtc_vblank_on(crtc);
 
@@ -931,12 +930,20 @@ int amdgpu_dm_set_config(struct drm_mode_set *set)
 
 		/* program plane config */
 		pl_config.display_index = acrtc->crtc_id;
-		fill_plane_attributes(adev, &pl_config, set->crtc);
-		dal_setup_plane_configurations(adev->dm.dal, 1, &pl_config);
 
-		/* program the surface addr and flip control*/
-		addr_flip_info.display_index = acrtc->crtc_id;
-		amdgpu_dm_fill_surface_address(set->crtc, &addr_flip_info, afb, save_set.fb);
+		/*we won't handle the wrong case: FB size < crtc->mode(viewport size) */
+		if (set->fb->height >= set->crtc->mode.vdisplay &&
+				set->fb->width >= set->crtc->mode.hdisplay) {
+
+			/*Blank display before programming surface */
+			dal_set_blanking(adev->dm.dal, acrtc->crtc_id, true);
+			fill_plane_attributes(adev, &pl_config, set->crtc);
+			dal_setup_plane_configurations(adev->dm.dal, 1, &pl_config);
+			/* program the surface addr and flip control*/
+			addr_flip_info.display_index = acrtc->crtc_id;
+			amdgpu_dm_fill_surface_address(set->crtc, &addr_flip_info, afb, save_set.fb);
+			dal_set_blanking(adev->dm.dal, acrtc->crtc_id, false);
+		}
 	}
 	DRM_DEBUG_KMS("=== Finished dm_set_config ===\n");
 
-- 
1.9.1

