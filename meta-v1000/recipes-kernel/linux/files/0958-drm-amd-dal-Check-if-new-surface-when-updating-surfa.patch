From 306ef3f6dc00ba27f63e5ab8736c23918274e0ec Mon Sep 17 00:00:00 2001
From: Yongqiang Sun <yongqiang.sun@amd.com>
Date: Fri, 2 Sep 2016 13:25:29 -0400
Subject: [PATCH 0958/1722] drm/amd/dal: Check if new surface when updating
 surface

Change-Id: Icf883f4428d63beb025a68a367a89664a0912121
Signed-off-by: Yongqiang Sun <yongqiang.sun@amd.com>
Acked-by: Harry Wentland <harry.wentland@amd.com>
Signed-off-by: Kalyan Alle <kalyan.alle@amd.com>
---
 drivers/gpu/drm/amd/dal/dc/core/dc.c | 7 ++++++-
 1 file changed, 6 insertions(+), 1 deletion(-)

diff --git a/drivers/gpu/drm/amd/dal/dc/core/dc.c b/drivers/gpu/drm/amd/dal/dc/core/dc.c
index fc002c5..2148809 100644
--- a/drivers/gpu/drm/amd/dal/dc/core/dc.c
+++ b/drivers/gpu/drm/amd/dal/dc/core/dc.c
@@ -1349,6 +1349,7 @@ void dc_update_surfaces_for_target(struct dc *dc, struct dc_surface_update *upda
 	struct core_dc *core_dc = DC_TO_CORE(dc);
 	struct validate_context *context = core_dc->temp_flip_context;
 	int i;
+	bool is_new_surface[MAX_SURFACES] = { false };
 
 	*context = *core_dc->current_context;
 
@@ -1379,7 +1380,11 @@ void dc_update_surfaces_for_target(struct dc *dc, struct dc_surface_update *upda
 			return;
 
 		for (i = 0 ; i < surface_count; i++) {
+			struct core_surface *surface = DC_SURFACE_TO_CORE(updates[i].surface);
+
 			new_surfaces[i] = updates[i].surface;
+			if (find_pipe_ctx_by_surface(context, surface) == NULL)
+				is_new_surface[i] = true;
 		}
 
 		if (!resource_attach_surfaces_to_context(
@@ -1405,7 +1410,7 @@ void dc_update_surfaces_for_target(struct dc *dc, struct dc_surface_update *upda
 						PIPE_LOCK_CONTROL_SURFACE,
 						true);
 
-		if (updates[i].plane_info || updates[i].scaling_info) {
+		if (updates[i].plane_info || updates[i].scaling_info || is_new_surface[i]) {
 
 			if (updates[i].flip_addr) {
 				surface->public.address = updates[i].flip_addr->address;
-- 
2.7.4

