From 9455826b01f5b6216fe1f8fc4e1d787d369d73c5 Mon Sep 17 00:00:00 2001
From: ddznelad <david.dzneladze@amd.com>
Date: Thu, 18 Jun 2015 15:30:32 -0400
Subject: [PATCH 290/401] amd/dal: fix no audio with dp connection

Signed-off-by: Harry Wentland <harry.wentland@amd.com>
Reviewed-by: Mykola Lysenko<Mykola.Lysenko@amd.com>
Signed-off-by: Sanjay R Mehta <sanju.mehta@amd.com>
---
 .../amd/dal/gpu/dce110/dc_clock_gating_dce110.c    | 42 ++++++++++++++++++++--
 .../amd/dal/gpu/dce110/dc_clock_gating_dce110.h    |  5 ++-
 drivers/gpu/drm/amd/dal/gpu/dce110/gpu_dce110.c    |  3 +-
 3 files changed, 44 insertions(+), 6 deletions(-)

diff --git a/drivers/gpu/drm/amd/dal/gpu/dce110/dc_clock_gating_dce110.c b/drivers/gpu/drm/amd/dal/gpu/dce110/dc_clock_gating_dce110.c
index 186d283..7a33dbf 100644
--- a/drivers/gpu/drm/amd/dal/gpu/dce110/dc_clock_gating_dce110.c
+++ b/drivers/gpu/drm/amd/dal/gpu/dce110/dc_clock_gating_dce110.c
@@ -27,6 +27,8 @@
 
 #include "include/logger_interface.h"
 
+#include "dce/dce_11_0_d.h"
+#include "dce/dce_11_0_sh_mask.h"
 #include "dc_clock_gating_dce110.h"
 
 /******************************************************************************
@@ -39,12 +41,37 @@
 /******************************************************************************
  * static functions
  *****************************************************************************/
+static void force_hw_base_light_sleep(struct dal_context *dal_context)
+{
+	uint32_t addr = 0;
+	uint32_t value = 0;
+
+
+	addr = mmDC_MEM_GLOBAL_PWR_REQ_CNTL;
+	/* Read the mmDC_MEM_GLOBAL_PWR_REQ_CNTL to get the currently
+	 * programmed DC_MEM_GLOBAL_PWR_REQ_DIS*/
+	value = dal_read_reg(dal_context, addr);
+
+	set_reg_field_value(
+			value,
+			1,
+			DC_MEM_GLOBAL_PWR_REQ_CNTL,
+			DC_MEM_GLOBAL_PWR_REQ_DIS);
+
+	dal_write_reg(dal_context, addr, value);
+
+}
 
 static void enable_hw_base_light_sleep(struct dal_context *dal_context)
 {
 	NOT_IMPLEMENTED();
 }
 
+static void disable_hw_base_light_sleep(struct dal_context *dal_context)
+{
+	NOT_IMPLEMENTED();
+}
+
 static void disable_sw_manual_control_light_sleep(
 		struct dal_context *dal_context)
 {
@@ -61,10 +88,19 @@ static void enable_sw_manual_control_light_sleep(
  * public functions
  *****************************************************************************/
 
-void dal_dc_clock_gating_dce110_power_up(struct dal_context *dal_context)
+void dal_dc_clock_gating_dce110_power_up(
+		struct dal_context *dal_context,
+		bool enable)
 {
-	enable_hw_base_light_sleep(dal_context);
-	disable_sw_manual_control_light_sleep(dal_context);
+	if(enable)
+	{
+		enable_hw_base_light_sleep(dal_context);
+		disable_sw_manual_control_light_sleep(dal_context);
+	}
+	else
+	{
+		force_hw_base_light_sleep(dal_context);
+	}
 }
 
 void dal_dc_clock_gating_dce110_power_down(struct dal_context *dal_context)
diff --git a/drivers/gpu/drm/amd/dal/gpu/dce110/dc_clock_gating_dce110.h b/drivers/gpu/drm/amd/dal/gpu/dce110/dc_clock_gating_dce110.h
index d4daba5..3eb5fe7 100644
--- a/drivers/gpu/drm/amd/dal/gpu/dce110/dc_clock_gating_dce110.h
+++ b/drivers/gpu/drm/amd/dal/gpu/dce110/dc_clock_gating_dce110.h
@@ -26,7 +26,10 @@
 #ifndef __DAL_DC_CLOCK_GATING_DCE110_H__
 #define __DAL_DC_CLOCK_GATING_DCE110_H__
 
-void dal_dc_clock_gating_dce110_power_up(struct dal_context *dal_context);
+void dal_dc_clock_gating_dce110_power_up(
+		struct dal_context *dal_context,
+		bool enable);
+
 void dal_dc_clock_gating_dce110_power_down(struct dal_context *dal_context);
 
 #endif /* __DAL_DC_CLOCK_GATING_DCE110_H__ */
diff --git a/drivers/gpu/drm/amd/dal/gpu/dce110/gpu_dce110.c b/drivers/gpu/drm/amd/dal/gpu/dce110/gpu_dce110.c
index 8253b16..80f5a8f 100644
--- a/drivers/gpu/drm/amd/dal/gpu/dce110/gpu_dce110.c
+++ b/drivers/gpu/drm/amd/dal/gpu/dce110/gpu_dce110.c
@@ -217,8 +217,7 @@ static void power_up(struct gpu *base)
 
 	dal_gpu_power_up_base(base);
 
-	if (gpu110->dc_clock_gating)
-		dal_dc_clock_gating_dce110_power_up(base->dal_context);
+	dal_dc_clock_gating_dce110_power_up(base->dal_context, gpu110->dc_clock_gating );
 }
 
 static void power_down(
-- 
1.9.1

