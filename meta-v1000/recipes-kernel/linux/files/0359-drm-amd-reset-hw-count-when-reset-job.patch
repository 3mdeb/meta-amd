From 43d38428a41992becbc97f5c83c41620a577ee46 Mon Sep 17 00:00:00 2001
From: Chunming Zhou <David1.Zhou@amd.com>
Date: Fri, 22 Jul 2016 13:01:02 +0800
Subject: [PATCH 0359/1722] drm/amd: reset hw count when reset job
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Means the hw ring is empty after gpu reset.

Signed-off-by: Chunming Zhou <David1.Zhou@amd.com>
Reviewed-by: Christian KÃ¶nig <christian.koenig@amd.com>
Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
Signed-off-by: Kalyan Alle <kalyan.alle@amd.com>
---
 drivers/gpu/drm/amd/scheduler/gpu_scheduler.c | 3 +++
 1 file changed, 3 insertions(+)

diff --git a/drivers/gpu/drm/amd/scheduler/gpu_scheduler.c b/drivers/gpu/drm/amd/scheduler/gpu_scheduler.c
index 27c4ad2..0eeea29 100644
--- a/drivers/gpu/drm/amd/scheduler/gpu_scheduler.c
+++ b/drivers/gpu/drm/amd/scheduler/gpu_scheduler.c
@@ -393,6 +393,7 @@ void amd_sched_hw_job_reset(struct amd_gpu_scheduler *sched)
                         s_job->s_fence->parent = NULL;
                 }
         }
+        atomic_set(&sched->hw_rq_count, 0);
         spin_unlock(&sched->job_list_lock);
 }
 
@@ -410,6 +411,8 @@ void amd_sched_job_recovery(struct amd_gpu_scheduler *sched)
         list_for_each_entry(s_job, &sched->ring_mirror_list, node) {
                 struct amd_sched_fence *s_fence = s_job->s_fence;
                 struct fence *fence = sched->ops->run_job(s_job);
+
+                atomic_inc(&sched->hw_rq_count);
                 if (fence) {
                         s_fence->parent = fence_get(fence);
                         r = fence_add_callback(fence, &s_fence->cb,
-- 
2.7.4

