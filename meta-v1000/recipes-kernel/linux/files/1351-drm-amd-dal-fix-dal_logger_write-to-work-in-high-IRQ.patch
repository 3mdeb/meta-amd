From 47394e38766f001d0eaba7612ee150c357b9e9e5 Mon Sep 17 00:00:00 2001
From: Dmytro Laktyushkin <Dmytro.Laktyushkin@amd.com>
Date: Wed, 19 Oct 2016 17:17:47 -0400
Subject: [PATCH 1351/1722] drm/amd/dal: fix dal_logger_write to work in high
 IRQ

Change-Id: I49b9071b0cabd465ca1a77dd485012abb944f75c
Signed-off-by: Dmytro Laktyushkin <Dmytro.Laktyushkin@amd.com>
Acked-by: Harry Wentland <harry.wentland@amd.com>
---
 drivers/gpu/drm/amd/dal/dc/basics/logger.c | 36 +++++++++++++++++-------------
 1 file changed, 20 insertions(+), 16 deletions(-)

diff --git a/drivers/gpu/drm/amd/dal/dc/basics/logger.c b/drivers/gpu/drm/amd/dal/dc/basics/logger.c
index ff5da87..67a1ee2 100644
--- a/drivers/gpu/drm/amd/dal/dc/basics/logger.c
+++ b/drivers/gpu/drm/amd/dal/dc/basics/logger.c
@@ -598,36 +598,40 @@ void dal_logger_write(
 	const char *msg,
 	...)
 {
-
 	if (logger && dal_logger_should_log(logger, major, minor)) {
-
 		uint32_t size;
 		va_list args;
 		char buffer[DAL_LOGGER_BUFFER_MAX_LOG_LINE_SIZE];
 		struct log_entry entry;
 
 		va_start(args, msg);
-		dal_logger_open(logger, &entry, major, minor);
+
+		entry.major = LOG_MAJOR_COUNT;
+		entry.minor = 0;
+		entry.logger = logger;
+
+		entry.buf = buffer;
+
+		entry.buf_offset = 0;
+		entry.max_buf_bytes = DAL_LOGGER_BUFFER_MAX_SIZE * sizeof(char);
+
+		entry.major = major;
+		entry.minor = minor;
+
+		log_heading(&entry, major, minor);
 
 		size = dm_log_to_buffer(
 			buffer, DAL_LOGGER_BUFFER_MAX_LOG_LINE_SIZE, msg, args);
 
-		if (size > 0 && size <
-				DAL_LOGGER_BUFFER_MAX_LOG_LINE_SIZE - 1) {
+		entry.buf_offset += size;
 
-			if (buffer[size] == '\0')
-				size++; /* Add one for null terminator */
+		/* --Flush log_entry buffer-- */
+		/* print to kernel console */
+		log_to_debug_console(&entry);
+		/* log internally for dsat */
+		log_to_internal_buffer(&entry);
 
-			/* Concatenate onto end of entry buffer */
-			append_entry(&entry, buffer, size);
-		} else {
-			append_entry(&entry,
-				"LOG_ERROR, line too long or null\n", 35);
-		}
-
-		dal_logger_close(&entry);
 		va_end(args);
-
 	}
 }
 
-- 
2.7.4

