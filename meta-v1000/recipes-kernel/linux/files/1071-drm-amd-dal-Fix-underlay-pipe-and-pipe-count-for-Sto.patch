From f6e48b57284fceeb454774f446106f469f7787c6 Mon Sep 17 00:00:00 2001
From: Amy Zhang <Amy.Zhang@amd.com>
Date: Tue, 13 Sep 2016 16:14:15 -0400
Subject: [PATCH 1071/1722] drm/amd/dal: Fix underlay pipe and pipe count for
 Stoney

- Fixed bsod in dce110_validate_bandwidth for Stoney

Change-Id: Idb55a567bd2ec45a6f3007a7b407ceff654261ec
Signed-off-by: Amy Zhang <Amy.Zhang@amd.com>
Acked-by: Harry Wentland <harry.wentland@amd.com>
Signed-off-by: Kalyan Alle <kalyan.alle@amd.com>
---
 drivers/gpu/drm/amd/dal/dc/dce110/dce110_resource.c | 4 +++-
 1 file changed, 3 insertions(+), 1 deletion(-)

diff --git a/drivers/gpu/drm/amd/dal/dc/dce110/dce110_resource.c b/drivers/gpu/drm/amd/dal/dc/dce110/dce110_resource.c
index 3750cd5..ea92199 100644
--- a/drivers/gpu/drm/amd/dal/dc/dce110/dce110_resource.c
+++ b/drivers/gpu/drm/amd/dal/dc/dce110/dce110_resource.c
@@ -775,6 +775,7 @@ enum dc_status dce110_validate_bandwidth(
 	/* Due to organization of bw_calcs, the underlay pipe must be at the beginning of the array*/
 
 	if (underlay_pipe_ctx->stream) {
+		ASSERT (underlay_pipe_ctx->top_pipe);
 		bw_calcs_input_single_display(underlay_input, underlay_pipe_ctx->top_pipe, &max_htaps, &max_vtaps);
 		prev_timing = underlay_pipe_ctx->stream->public.timing;
 		underlay_input->underlay_mode = bw_def_yes;
@@ -1146,14 +1147,15 @@ static bool construct(
          *  Resource + asic cap harcoding                *
          *************************************************/
         pool->base.pipe_count = 3;
+        pool->base.stream_enc_count = 3;
         pool->base.underlay_pipe_index = 3;
  
         if (ASIC_REV_IS_STONEY(asic_id.hw_internal_rev)) {
                 pool->base.pipe_count = 2;
+                pool->base.stream_enc_count = 2;
                 pool->base.underlay_pipe_index = 2;
         }
  
-        pool->base.stream_enc_count = 3;
         dc->public.caps.max_downscale_ratio = 150;
         dc->public.caps.i2c_speed_in_khz = 100;
 
-- 
2.7.4

