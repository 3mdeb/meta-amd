From 9fffe4c31397a7380926628838d60030b7a7148b Mon Sep 17 00:00:00 2001
From: Chunming Zhou <David1.Zhou@amd.com>
Date: Thu, 30 Jun 2016 11:30:37 +0800
Subject: [PATCH 0279/1722] drm/amd: add amd_sched_hw_job_reset
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

amd_sched_hw_job_reset will remove callback from hw fence.

Signed-off-by: Chunming Zhou <David1.Zhou@amd.com>
Reviewed-by: Christian KÃ¶nig <christian.koenig@amd.com>
Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
Signed-off-by: Kalyan Alle <kalyan.alle@amd.com>
---
 drivers/gpu/drm/amd/scheduler/gpu_scheduler.c | 14 ++++++++++++++
 drivers/gpu/drm/amd/scheduler/gpu_scheduler.h |  1 +
 2 files changed, 15 insertions(+)

diff --git a/drivers/gpu/drm/amd/scheduler/gpu_scheduler.c b/drivers/gpu/drm/amd/scheduler/gpu_scheduler.c
index 77d876d..c9b3a60 100644
--- a/drivers/gpu/drm/amd/scheduler/gpu_scheduler.c
+++ b/drivers/gpu/drm/amd/scheduler/gpu_scheduler.c
@@ -381,6 +381,20 @@ static void amd_sched_job_timedout(struct work_struct *work)
 	job->sched->ops->timedout_job(job);
 }
 
+void amd_sched_hw_job_reset(struct amd_gpu_scheduler *sched)
+{
+        struct amd_sched_job *s_job;
+ 
+        spin_lock(&sched->job_list_lock);
+        list_for_each_entry_reverse(s_job, &sched->ring_mirror_list, node) {
+                if (fence_remove_callback(s_job->s_fence->parent, &s_job->s_fence->cb)) {
+                        fence_put(s_job->s_fence->parent);
+                        s_job->s_fence->parent = NULL;
+                }
+        }
+        spin_unlock(&sched->job_list_lock);
+}
+
 /**
  * Submit a job to the job queue
  *
diff --git a/drivers/gpu/drm/amd/scheduler/gpu_scheduler.h b/drivers/gpu/drm/amd/scheduler/gpu_scheduler.h
index 0d2d266..0238e86 100644
--- a/drivers/gpu/drm/amd/scheduler/gpu_scheduler.h
+++ b/drivers/gpu/drm/amd/scheduler/gpu_scheduler.h
@@ -154,4 +154,5 @@ int amd_sched_job_init(struct amd_sched_job *job,
 		       struct amd_gpu_scheduler *sched,
 		       struct amd_sched_entity *entity,
                        void *owner);
+void amd_sched_hw_job_reset(struct amd_gpu_scheduler *sched);
 #endif
-- 
2.7.4

