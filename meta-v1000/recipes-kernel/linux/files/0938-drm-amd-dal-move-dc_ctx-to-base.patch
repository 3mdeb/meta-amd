From 8338f5ee1f7c4a24f6373113405dd063ffd4ee42 Mon Sep 17 00:00:00 2001
From: Tony Cheng <tony.cheng@amd.com>
Date: Thu, 25 Aug 2016 21:15:57 -0400
Subject: [PATCH 0938/1722] drm/amd/dal: move dc_ctx to base

Change-Id: I0a4b518bef526cad363fc74c47f7c05a332eb291
Signed-off-by: Jordan Lazare <Jordan.Lazare@amd.com>
Acked-by: Harry Wentland <harry.wentland@amd.com>
Signed-off-by: Kalyan Alle <kalyan.alle@amd.com>
---
 drivers/gpu/drm/amd/dal/dc/bios/bios_parser.c      | 34 +++++++++++++++++++---
 .../amd/dal/dc/bios/bios_parser_types_internal.h   |  1 -
 drivers/gpu/drm/amd/dal/dc/bios/command_table.c    |  6 ++--
 drivers/gpu/drm/amd/dal/dc/dc_bios_types.h         |  2 ++
 4 files changed, 35 insertions(+), 8 deletions(-)

diff --git a/drivers/gpu/drm/amd/dal/dc/bios/bios_parser.c b/drivers/gpu/drm/amd/dal/dc/bios/bios_parser.c
index 6e76aaa..5554c54 100644
--- a/drivers/gpu/drm/amd/dal/dc/bios/bios_parser.c
+++ b/drivers/gpu/drm/amd/dal/dc/bios/bios_parser.c
@@ -3618,7 +3618,7 @@ static enum bp_result patch_bios_image_from_ext_display_connection_info(
 			return BP_RESULT_OK;
 		}
 
-		dal_logger_write(bp->ctx->logger,
+		dal_logger_write(bp->base.ctx->logger,
 				LOG_MAJOR_BIOS,
 				LOG_MINOR_BIOS_CMD_TABLE,
 				"%s: Failed to read Connection Info Table", __func__);
@@ -3916,9 +3916,9 @@ bool dc_bios_is_accelerated_mode(struct dc_bios *dcb)
 
 #ifdef CONFIG_DRM_AMD_DAL_VBIOS_PRESENT
 	return bp->bios_helper->is_accelerated_mode(
-			bp->ctx);
+			bp->base.ctx);
 #else
-	dal_logger_write(bp->ctx->logger,
+	dal_logger_write(bp->base.ctx->logger,
 			LOG_MAJOR_BIOS,
 			LOG_MINOR_BIOS_CMD_TABLE,
 			"%s: VBIOS is not supported", __func__);
@@ -3941,6 +3941,32 @@ void dc_bios_set_scratch_acc_mode_change(struct dc_bios *dcb)
 #endif
 }
 
+/**
+ * bios_parser_set_scratch_critical_state
+ *
+ * @brief
+ *  update critical state bit in VBIOS scratch register
+ *
+ * @param
+ *  bool - to set or reset state
+ */
+static void bios_parser_set_scratch_critical_state(
+        struct dc_bios *dcb,
+        bool state)
+{
+        struct bios_parser *bp = BP_FROM_DCB(dcb);
+
+#ifdef CONFIG_DRM_AMD_DAL_VBIOS_PRESENT
+        dce110_set_scratch_critical_state(
+                        bp->base.ctx, state);
+#else
+        dal_logger_write(bp->base.ctx->logger,
+                        LOG_MAJOR_BIOS,
+                        LOG_MINOR_BIOS_CMD_TABLE,
+                        "%s: VBIOS is not supported", __func__);
+#endif
+}
+
 /*
  * get_integrated_info_v8
  *
@@ -4454,7 +4480,7 @@ static bool bios_parser_construct(
         bp->base.bios = init->bios;
         bp->base.bios_size = bp->base.bios[BIOS_IMAGE_SIZE_OFFSET] * BIOS_IMAGE_SIZE_UNIT;
 
-	bp->ctx = init->ctx;
+        bp->base.ctx = init->ctx;
 	bp->bios_local_image = NULL;
 
 	rom_header_offset =
diff --git a/drivers/gpu/drm/amd/dal/dc/bios/bios_parser_types_internal.h b/drivers/gpu/drm/amd/dal/dc/bios/bios_parser_types_internal.h
index 4153c9f..69e11b2 100644
--- a/drivers/gpu/drm/amd/dal/dc/bios/bios_parser_types_internal.h
+++ b/drivers/gpu/drm/amd/dal/dc/bios/bios_parser_types_internal.h
@@ -52,7 +52,6 @@ enum spread_spectrum_id {
 
 struct bios_parser {
 	struct dc_bios base;
-	struct dc_context *ctx;
 
 	struct object_info_table object_info_tbl;
 	uint32_t object_info_tbl_offset;
diff --git a/drivers/gpu/drm/amd/dal/dc/bios/command_table.c b/drivers/gpu/drm/amd/dal/dc/bios/command_table.c
index 8701208..6836866 100644
--- a/drivers/gpu/drm/amd/dal/dc/bios/command_table.c
+++ b/drivers/gpu/drm/amd/dal/dc/bios/command_table.c
@@ -35,16 +35,16 @@
 #include "bios_parser_types_internal.h"
 
 #define EXEC_BIOS_CMD_TABLE(command, params)\
-	(cgs_atom_exec_cmd_table(bp->ctx->cgs_device, \
+	(cgs_atom_exec_cmd_table(bp->base.ctx->cgs_device, \
 		GetIndexIntoMasterTable(COMMAND, command), \
 		&params) == 0)
 
 #define BIOS_CMD_TABLE_REVISION(command, frev, crev)\
-	cgs_atom_get_cmd_table_revs(bp->ctx->cgs_device, \
+	cgs_atom_get_cmd_table_revs(bp->base.ctx->cgs_device, \
 		GetIndexIntoMasterTable(COMMAND, command), &frev, &crev)
 
 #define BIOS_CMD_TABLE_PARA_REVISION(command)\
-	bios_cmd_table_para_revision(bp->ctx->cgs_device, \
+	bios_cmd_table_para_revision(bp->base.ctx->cgs_device, \
 		GetIndexIntoMasterTable(COMMAND, command))
 
 static void init_dig_encoder_control(struct bios_parser *bp);
diff --git a/drivers/gpu/drm/amd/dal/dc/dc_bios_types.h b/drivers/gpu/drm/amd/dal/dc/dc_bios_types.h
index 5df1a37..bbded69 100644
--- a/drivers/gpu/drm/amd/dal/dc/dc_bios_types.h
+++ b/drivers/gpu/drm/amd/dal/dc/dc_bios_types.h
@@ -242,6 +242,8 @@ struct dc_bios {
 
 	uint8_t *bios;
 	uint32_t bios_size;
+
+	struct dc_context *ctx;
 };
 
 #endif /* DC_BIOS_TYPES_H */
-- 
2.7.4

