From da9e08774d6398cf0b19497fb60b8af8d7c2ce04 Mon Sep 17 00:00:00 2001
From: Zeyu Fan <Zeyu.Fan@amd.com>
Date: Wed, 19 Oct 2016 14:18:02 -0400
Subject: [PATCH 1350/1722] drm/amd/dal: Enable stream encoder support for next
 generation asics.

Change-Id: I864a63f5406ec8199a849c8d15642d80dc5af1c2
Signed-off-by: Zeyu Fan <Zeyu.Fan@amd.com>
Acked-by: Harry Wentland <harry.wentland@amd.com>
---
 drivers/gpu/drm/amd/dal/dc/core/dc_resource.c          |  3 +--
 drivers/gpu/drm/amd/dal/dc/dce/dce110_stream_encoder.h | 14 +++++++++-----
 drivers/gpu/drm/amd/dal/dc/dce100/dce100_resource.c    |  2 +-
 drivers/gpu/drm/amd/dal/dc/dce80/dce80_resource.c      |  2 +-
 4 files changed, 12 insertions(+), 9 deletions(-)

diff --git a/drivers/gpu/drm/amd/dal/dc/core/dc_resource.c b/drivers/gpu/drm/amd/dal/dc/core/dc_resource.c
index 4493971..a0980dd 100644
--- a/drivers/gpu/drm/amd/dal/dc/core/dc_resource.c
+++ b/drivers/gpu/drm/amd/dal/dc/core/dc_resource.c
@@ -141,8 +141,7 @@ bool resource_construct(
 	unsigned int num_audio = caps->num_audio;
 	struct resource_straps straps = {0};
 
-	if (!IS_FPGA_MAXIMUS_DC(dc->ctx->dce_environment))
-		create_funcs->read_dce_straps(dc->ctx, &straps);
+	create_funcs->read_dce_straps(dc->ctx, &straps);
 
 	/* find the total number of streams available via the
 	 * AZALIA_F0_CODEC_PIN_CONTROL_RESPONSE_CONFIGURATION_DEFAULT
diff --git a/drivers/gpu/drm/amd/dal/dc/dce/dce110_stream_encoder.h b/drivers/gpu/drm/amd/dal/dc/dce/dce110_stream_encoder.h
index 699e8cd..7c29c84 100644
--- a/drivers/gpu/drm/amd/dal/dc/dce/dce110_stream_encoder.h
+++ b/drivers/gpu/drm/amd/dal/dc/dce/dce110_stream_encoder.h
@@ -31,11 +31,15 @@
 #define DCE110STRENC_FROM_STRENC(stream_encoder)\
 	container_of(stream_encoder, struct dce110_stream_encoder, base)
 
+
+#define SE_COMMON_REG_LIST_DCE_BASE(id) \
+		SE_COMMON_REG_LIST_BASE(id),\
+		SRI(AFMT_AVI_INFO0, DIG, id), \
+		SRI(AFMT_AVI_INFO1, DIG, id), \
+		SRI(AFMT_AVI_INFO2, DIG, id), \
+		SRI(AFMT_AVI_INFO3, DIG, id)
+
 #define SE_COMMON_REG_LIST_BASE(id) \
-	SRI(AFMT_AVI_INFO0, DIG, id), \
-	SRI(AFMT_AVI_INFO1, DIG, id), \
-	SRI(AFMT_AVI_INFO2, DIG, id), \
-	SRI(AFMT_AVI_INFO3, DIG, id), \
 	SRI(AFMT_GENERIC_0, DIG, id), \
 	SRI(AFMT_GENERIC_1, DIG, id), \
 	SRI(AFMT_GENERIC_2, DIG, id), \
@@ -83,7 +87,7 @@
 	SRI(DP_SEC_TIMESTAMP, DP, id)
 
 #define SE_COMMON_REG_LIST(id)\
-	SE_COMMON_REG_LIST_BASE(id), \
+	SE_COMMON_REG_LIST_DCE_BASE(id), \
 	SRI(AFMT_CNTL, DIG, id)
 
 struct dce110_stream_enc_registers {
diff --git a/drivers/gpu/drm/amd/dal/dc/dce100/dce100_resource.c b/drivers/gpu/drm/amd/dal/dc/dce100/dce100_resource.c
index a776026..12d62ea 100644
--- a/drivers/gpu/drm/amd/dal/dc/dce100/dce100_resource.c
+++ b/drivers/gpu/drm/amd/dal/dc/dce100/dce100_resource.c
@@ -289,7 +289,7 @@ static const struct dce110_link_enc_registers link_enc_regs[] = {
 
 #define stream_enc_regs(id)\
 [id] = {\
-	SE_COMMON_REG_LIST_BASE(id),\
+	SE_COMMON_REG_LIST_DCE_BASE(id),\
 	.AFMT_CNTL = 0,\
 	.TMDS_CNTL = 0,\
 }
diff --git a/drivers/gpu/drm/amd/dal/dc/dce80/dce80_resource.c b/drivers/gpu/drm/amd/dal/dc/dce80/dce80_resource.c
index 753522d..78413dc 100644
--- a/drivers/gpu/drm/amd/dal/dc/dce80/dce80_resource.c
+++ b/drivers/gpu/drm/amd/dal/dc/dce80/dce80_resource.c
@@ -298,7 +298,7 @@ static const struct dce110_link_enc_registers link_enc_regs[] = {
 
 #define stream_enc_regs(id)\
 [id] = {\
-	SE_COMMON_REG_LIST_BASE(id),\
+	SE_COMMON_REG_LIST_DCE_BASE(id),\
 	.AFMT_CNTL = 0,\
 }
 
-- 
2.7.4

