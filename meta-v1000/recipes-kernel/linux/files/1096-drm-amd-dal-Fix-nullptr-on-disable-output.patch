From fa3838d830fea5dcb34026e7af7d5cbc717019f0 Mon Sep 17 00:00:00 2001
From: Vitaly Prosyak <vitaly.prosyak@amd.com>
Date: Fri, 16 Sep 2016 16:20:04 -0400
Subject: [PATCH 1096/1722] drm/amd/dal: Fix nullptr on disable output

 Add missed call remove sink from freesync module

Change-Id: Ia33a96b1336f4ba92a3013dab43d9679f3f1b4bf
Signed-off-by: Vitaly Prosyak <vitaly.prosyak@amd.com>
Acked-by: Harry Wentland <harry.wentland@amd.com>
Signed-off-by: Kalyan Alle <kalyan.alle@amd.com>
---
 drivers/gpu/drm/amd/dal/amdgpu_dm/amdgpu_dm.c | 12 +++++++++++-
 1 file changed, 11 insertions(+), 1 deletion(-)

diff --git a/drivers/gpu/drm/amd/dal/amdgpu_dm/amdgpu_dm.c b/drivers/gpu/drm/amd/dal/amdgpu_dm/amdgpu_dm.c
index a93aa08..d0f48b8 100644
--- a/drivers/gpu/drm/amd/dal/amdgpu_dm/amdgpu_dm.c
+++ b/drivers/gpu/drm/amd/dal/amdgpu_dm/amdgpu_dm.c
@@ -771,15 +771,22 @@ void amdgpu_dm_update_connector_after_detect(
 		/* For S3 resume with headless use eml_sink to fake target
 		 * because on resume connecotr->sink is set ti NULL
 		 */
+		mutex_lock(&dev->mode_config.mutex);
+
 		if (sink) {
+			if (aconnector->dc_sink)
+				amdgpu_dm_remove_sink_from_freesync_module(
+								connector);
 			aconnector->dc_sink = sink;
 			amdgpu_dm_add_sink_to_freesync_module(
-								connector, aconnector->edid);
+						connector, aconnector->edid);
 		} else {
 			amdgpu_dm_remove_sink_from_freesync_module(connector);
 			if (!aconnector->dc_sink)
 				aconnector->dc_sink = aconnector->dc_em_sink;
 		}
+
+		mutex_unlock(&dev->mode_config.mutex);
 		return;
 	}
 
@@ -808,6 +815,9 @@ void amdgpu_dm_update_connector_after_detect(
 	if (sink) {
 		/* TODO: check if we still need the S3 mode update workaround.
 		 * If yes, put it here. */
+		if (aconnector->dc_sink)
+			amdgpu_dm_remove_sink_from_freesync_module(
+							connector);
 
 		aconnector->dc_sink = sink;
 		if (sink->dc_edid.length == 0)
-- 
2.7.4

