From 83502857195a3b748a94e0a7d0773845f8f5bd60 Mon Sep 17 00:00:00 2001
From: Chunming Zhou <David1.Zhou@amd.com>
Date: Fri, 28 Apr 2017 17:22:29 +0800
Subject: [PATCH 30/38] amdgpu: add interface for reserve/unserve vmid v2

v2: delete unused comments.

Change-Id: If533576eb8a65bd019a3480d6fe2a64f23e3c944
Signed-off-by: Chunming Zhou <David1.Zhou@amd.com>
Reviewed-by: Monk Liu <monk.liu@amd.com>
Reviewed-by: Junwei Zhang <Jerry.Zhang@amd.com>
---
 amdgpu/amdgpu.h    | 13 +++++++++++++
 amdgpu/amdgpu_cs.c | 28 ++++++++++++++++++++++++++++
 2 files changed, 41 insertions(+)

diff --git a/amdgpu/amdgpu.h b/amdgpu/amdgpu.h
index e31c79f..7695b70 100644
--- a/amdgpu/amdgpu.h
+++ b/amdgpu/amdgpu.h
@@ -1582,6 +1582,19 @@ int amdgpu_cs_signal_sem(amdgpu_device_handle dev,
 			 uint32_t ip_instance,
 			 uint32_t ring,
 			 amdgpu_sem_handle sem);
+/**
+ *  reserve vmid for this process
+ *
+ * \param   dev    - [in] Device handle. See #amdgpu_device_initialize()
+ */
+int amdgpu_cs_reserved_vmid(amdgpu_device_handle dev);
+
+/**
+ *  unreserve vmid for this process
+ *
+ * \param   dev    - [in] Device handle. See #amdgpu_device_initialize()
+ */
+int amdgpu_cs_unreserved_vmid(amdgpu_device_handle dev);
 
 /**
  *  wait sem
diff --git a/amdgpu/amdgpu_cs.c b/amdgpu/amdgpu_cs.c
index 087e1d4..9328e4e 100644
--- a/amdgpu/amdgpu_cs.c
+++ b/amdgpu/amdgpu_cs.c
@@ -730,3 +730,31 @@ int amdgpu_cs_destroy_sem(amdgpu_device_handle dev,
 
 	return 0;
 }
+
+int amdgpu_cs_unreserved_vmid(amdgpu_device_handle dev)
+{
+	union drm_amdgpu_vm args;
+	int r;
+
+	if (NULL == dev)
+		return -EINVAL;
+
+	memset(&args, 0, sizeof(args));
+	args.in.op = AMDGPU_VM_OP_UNRESERVE_VMID;
+	r = drmCommandWriteRead(dev->fd, DRM_AMDGPU_VM, &args, sizeof(args));
+	return r;
+}
+
+int amdgpu_cs_reserved_vmid(amdgpu_device_handle dev)
+{
+	union drm_amdgpu_vm args;
+	int r;
+
+	if (NULL == dev)
+		return -EINVAL;
+
+	memset(&args, 0, sizeof(args));
+	args.in.op = AMDGPU_VM_OP_RESERVE_VMID;
+	r = drmCommandWriteRead(dev->fd, DRM_AMDGPU_VM, &args, sizeof(args));
+	return r;
+}
-- 
2.7.4

