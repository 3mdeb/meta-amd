From 97aa77095ee29dfc5e912431b145f12ee272a3d6 Mon Sep 17 00:00:00 2001
From: Hersen Wu <hersenxs.wu@amd.com>
Date: Tue, 17 May 2016 10:50:59 -0400
Subject: [PATCH 0493/1722] drm/amd/dal: fix plane split bug

Signed-off-by: Hersen Wu <hersenxs.wu@amd.com>
Acked-by: Jordan Lazare <Jordan.Lazare@amd.com>
Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
Signed-off-by: Kalyan Alle <kalyan.alle@amd.com>
---
 drivers/gpu/drm/amd/dal/dc/core/dc.c          |  3 ++-
 drivers/gpu/drm/amd/dal/dc/core/dc_resource.c | 16 +++++++++++++++-
 2 files changed, 17 insertions(+), 2 deletions(-)

diff --git a/drivers/gpu/drm/amd/dal/dc/core/dc.c b/drivers/gpu/drm/amd/dal/dc/core/dc.c
index 3deb3c8..c15c1ed 100644
--- a/drivers/gpu/drm/amd/dal/dc/core/dc.c
+++ b/drivers/gpu/drm/amd/dal/dc/core/dc.c
@@ -602,7 +602,8 @@ static void target_disable_memory_requests(struct dc_target *dc_target,
 		for (j = 0; j < MAX_PIPES; j++) {
 			struct timing_generator *tg = res_ctx->pipe_ctx[j].tg;
 
-			if (res_ctx->pipe_ctx[j].stream !=
+			if (res_ctx->pipe_ctx[j].parent_pipe != NULL ||
+				res_ctx->pipe_ctx[j].stream !=
 				DC_STREAM_TO_CORE(target->public.streams[i]))
 				continue;
 
diff --git a/drivers/gpu/drm/amd/dal/dc/core/dc_resource.c b/drivers/gpu/drm/amd/dal/dc/core/dc_resource.c
index 5079de3..2bcc1e5 100644
--- a/drivers/gpu/drm/amd/dal/dc/core/dc_resource.c
+++ b/drivers/gpu/drm/amd/dal/dc/core/dc_resource.c
@@ -963,6 +963,14 @@ enum dc_status resource_map_vmin_resources(
 		struct validate_context *context) {
 	/* TODO: Temporary hack. Forcing vmin here, one stream two pipes */
 	/* TODO: Lower  clock, change timing, etc? */
+
+	/* This function is called dc_validate_resources, dc_commit_targets,
+	 * by dc_commit_surfaces_to_target, each of them will
+	 * re-allocation buffer using
+	 * context = dm_alloc(sizeof(struct validate_context));
+	 * so pointer to buffer may be changed. In case save pointer to buffer
+	 * , handle will be needed
+	 */
 	if (context->target_count == 1 && context->targets[0]->public.stream_count == 1) {
 
 		uint8_t i;
@@ -991,8 +999,14 @@ enum dc_status resource_map_vmin_resources(
 		/* Determine if we've already acquired a vmin pipe previously */
 		for (i = 0; i < context->res_ctx.pool.pipe_count; i++) {
 			struct pipe_ctx *current_pipe_ctx = &context->res_ctx.pipe_ctx[i];
+
+			/* TODO: This workaround need rework  */
 			if (parent_pipe_ctx->stream == current_pipe_ctx->stream &&
-					current_pipe_ctx->parent_pipe == parent_pipe_ctx) {
+					current_pipe_ctx->parent_pipe != NULL) {
+				/* pointer to buffer may change. need update
+				 * when context be re-allocate
+				 */
+				current_pipe_ctx->parent_pipe = parent_pipe_ctx;
 				vmin_pipe_ctx = current_pipe_ctx;
 
 				/* Use same back-end as original pipe */
-- 
2.7.4

