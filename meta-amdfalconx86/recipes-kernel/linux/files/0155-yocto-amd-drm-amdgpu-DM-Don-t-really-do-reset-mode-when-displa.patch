From 6e4148249bfc79ae2070f540de09114d651f12b7 Mon Sep 17 00:00:00 2001
From: Clark Zheng <clark.zheng@amd.com>
Date: Wed, 10 Jun 2015 15:08:31 +0800
Subject: [PATCH 272/401] drm/amdgpu: [DM] Don't really do reset mode when
 display is connected

Signed-off-by: Harry Wentland <harry.wentland@amd.com>
Reviewed-by: Mykola Lysenko <mykola.lysenko@amd.com>
Signed-off-by: Sanjay R Mehta <sanju.mehta@amd.com>
---
 drivers/gpu/drm/amd/amdgpu/amdgpu_dm_types.c | 20 ++++++++++++++++----
 1 file changed, 16 insertions(+), 4 deletions(-)

diff --git a/drivers/gpu/drm/amd/amdgpu/amdgpu_dm_types.c b/drivers/gpu/drm/amd/amdgpu/amdgpu_dm_types.c
index cec89c7..00e960e 100644
--- a/drivers/gpu/drm/amd/amdgpu/amdgpu_dm_types.c
+++ b/drivers/gpu/drm/amd/amdgpu/amdgpu_dm_types.c
@@ -583,16 +583,28 @@ bool amdgpu_dm_mode_reset(struct drm_crtc *crtc)
 	struct amdgpu_crtc *acrtc = to_amdgpu_crtc(crtc);
 	uint32_t display_index = acrtc->crtc_id;
 
-	DRM_DEBUG_KMS("dal_reset_path_mode\n");
-
 	/* Turn vblank off before reset */
 	drm_crtc_vblank_off(crtc);
 
 	/* Blank the display */
 	dal_set_blanking(adev->dm.dal, acrtc->crtc_id, true);
 
-	/* the actual reset mode call */
-	ret = dal_reset_path_mode(adev->dm.dal, 1, &display_index);
+	/* Somehow we will get called from drm ask us reset mode
+	 * when fb is null, it will lead us remove mode unnecessarily
+	 * so change the code,we won't do the actual reset mode call
+	 * when display is connected,as that's unnecessarily and harmful.*/
+	if (dal_get_connected_targets_vector(adev->dm.dal)
+			& (1 << display_index)) {
+		ret = true;
+		DRM_DEBUG_KMS(
+			"Skip reset mode for disp_index %d\n",
+			display_index);
+	} else {
+		ret = dal_reset_path_mode(adev->dm.dal, 1, &display_index);
+		DRM_DEBUG_KMS(
+			"Do reset mode for disp_index %d\n",
+			display_index);
+	}
 
 	/* unpin the FB */
 	if (crtc->primary->fb)	{
-- 
1.9.1

