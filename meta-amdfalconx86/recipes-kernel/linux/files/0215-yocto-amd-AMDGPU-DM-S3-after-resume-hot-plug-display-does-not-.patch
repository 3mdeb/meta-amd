From afd6f5cab570728c07aa19ca21b0d40f833a46ad Mon Sep 17 00:00:00 2001
From: hersenwu <hersenxs.wu@amd.com>
Date: Thu, 2 Jul 2015 17:45:01 -0400
Subject: [PATCH 332/401] [AMDGPU][DM] S3 after resume hot plug display does
 not work

Signed-off-by: hersenwu <hersenxs.wu@amd.com>
Reviewed-by: Mykola Lysenko <mykola.lysenko@amd.com>
Signed-off-by: Sanjay R Mehta <sanju.mehta@amd.com>
---
 drivers/gpu/drm/amd/amdgpu/amdgpu_dm.c     |  2 ++
 drivers/gpu/drm/amd/amdgpu/amdgpu_dm_irq.c | 19 +++++++++++++++++++
 drivers/gpu/drm/amd/amdgpu/amdgpu_dm_irq.h |  7 +++++++
 3 files changed, 28 insertions(+)

diff --git a/drivers/gpu/drm/amd/amdgpu/amdgpu_dm.c b/drivers/gpu/drm/amd/amdgpu/amdgpu_dm.c
index 3b370e2..c0ec8c24 100644
--- a/drivers/gpu/drm/amd/amdgpu/amdgpu_dm.c
+++ b/drivers/gpu/drm/amd/amdgpu/amdgpu_dm.c
@@ -794,6 +794,8 @@ static int dm_resume(void *handle)
 	/* save previous connected display to reset mode correctly */
 	connected_displays_vector = prev_connected_displays_vector;
 
+	amdgpu_dm_irq_resume(adev);
+
 	dal_resume(dm->dal);
 
 	for (displays_number = 0, current_display_index = 0;
diff --git a/drivers/gpu/drm/amd/amdgpu/amdgpu_dm_irq.c b/drivers/gpu/drm/amd/amdgpu/amdgpu_dm_irq.c
index f99149c..838e0b5 100644
--- a/drivers/gpu/drm/amd/amdgpu/amdgpu_dm_irq.c
+++ b/drivers/gpu/drm/amd/amdgpu/amdgpu_dm_irq.c
@@ -28,6 +28,7 @@
 #include "amdgpu.h"
 #include "amdgpu_dm.h"
 #include "amdgpu_dm_irq.h"
+#include "include/dal_interface.h"
 
 
 /******************************************************************************
@@ -495,3 +496,21 @@ void amdgpu_dm_irq_fini(
 	/* Release the queue itself. */
 	destroy_workqueue(adev->dm.timer_workqueue);
 }
+
+int amdgpu_dm_irq_resume(
+	struct amdgpu_device *adev)
+{
+	int src;
+	struct list_head *hnd_list_h, *hnd_list_l;
+
+	DRM_DEBUG_KMS("DM_IRQ: resume\n");
+
+	/* re-enable HW interrupt */
+	for (src = DAL_IRQ_SOURCE_HPD1; src < DAL_IRQ_SOURCES_NUMBER; src++) {
+		hnd_list_l = &adev->dm.irq_handler_list_low_tab[src].head;
+		hnd_list_h = &adev->dm.irq_handler_list_high_tab[src];
+		if (!list_empty(hnd_list_l) || !list_empty(hnd_list_h))
+			dal_interrupt_set(adev->dm.dal, src, true);
+	}
+	return 0;
+}
diff --git a/drivers/gpu/drm/amd/amdgpu/amdgpu_dm_irq.h b/drivers/gpu/drm/amd/amdgpu/amdgpu_dm_irq.h
index d551ede..f67e560 100644
--- a/drivers/gpu/drm/amd/amdgpu/amdgpu_dm_irq.h
+++ b/drivers/gpu/drm/amd/amdgpu/amdgpu_dm_irq.h
@@ -105,4 +105,11 @@ void amdgpu_dm_irq_register_timer(
 	interrupt_handler ih,
 	void *args);
 
+/**
+ * amdgpu_dm_irq_resume - enable ASIC interrupt during resume.
+ *
+ */
+int amdgpu_dm_irq_resume(
+	struct amdgpu_device *adev);
+
 #endif /* __AMDGPU_DM_IRQ_H__ */
-- 
1.9.1

