From 3765cc037571e2cce939f45dfd577971f6002a79 Mon Sep 17 00:00:00 2001
From: Leo Liu <leo.liu@amd.com>
Date: Fri, 25 Oct 2013 10:23:45 -0400
Subject: [PATCH 06/27] st/omx/h264: implement support for field decoding

Signed-off-by: Leo Liu <leo.liu@amd.com>
---
 src/gallium/state_trackers/omx/vid_dec_h264.c |   10 +++++++++-
 1 file changed, 9 insertions(+), 1 deletion(-)

diff --git a/src/gallium/state_trackers/omx/vid_dec_h264.c b/src/gallium/state_trackers/omx/vid_dec_h264.c
index 072bbd7..20a6d9f 100644
--- a/src/gallium/state_trackers/omx/vid_dec_h264.c
+++ b/src/gallium/state_trackers/omx/vid_dec_h264.c
@@ -91,6 +91,7 @@ void vid_dec_h264_Init(vid_dec_PrivateType *priv)
    priv->Flush = vid_dec_h264_Flush;
    
    LIST_INITHEAD(&priv->codec_data.h264.dpb_list);
+   priv->picture.h264.field_order_cnt[0] = priv->picture.h264.field_order_cnt[1] = INT_MAX;
 }
 
 static void vid_dec_h264_BeginFrame(vid_dec_PrivateType *priv)
@@ -139,6 +140,7 @@ static void vid_dec_h264_EndFrame(vid_dec_PrivateType *priv)
 {
    struct dpb_list *entry;
    struct pipe_video_buffer *tmp;
+   bool top_field_first;
 
    if (!priv->frame_started)
       return;
@@ -151,6 +153,11 @@ static void vid_dec_h264_EndFrame(vid_dec_PrivateType *priv)
    priv->picture.h264.field_order_cnt_list[0][0] = priv->picture.h264.frame_num;
    priv->picture.h264.field_order_cnt_list[0][1] = priv->picture.h264.frame_num;
 
+   top_field_first = priv->picture.h264.field_order_cnt[0] <  priv->picture.h264.field_order_cnt[1];
+
+   if (priv->picture.h264.field_pic_flag && priv->picture.h264.bottom_field_flag != top_field_first)
+      return;
+
    /* add the decoded picture to the dpb list */
    entry = CALLOC_STRUCT(dpb_list);
    if (!entry)
@@ -161,6 +168,7 @@ static void vid_dec_h264_EndFrame(vid_dec_PrivateType *priv)
    LIST_ADDTAIL(&entry->list, &priv->codec_data.h264.dpb_list);
    ++priv->codec_data.h264.dpb_num;
    priv->target = NULL;
+   priv->picture.h264.field_order_cnt[0] = priv->picture.h264.field_order_cnt[1] = INT_MAX;
 
    if (priv->codec_data.h264.dpb_num <= DPB_MAX_SIZE)
       return;
@@ -665,7 +673,7 @@ static void slice_header(vid_dec_PrivateType *priv, struct vl_rbsp *rbsp,
    if (!sps->frame_mbs_only_flag) {
       unsigned field_pic_flag = vl_rbsp_u(rbsp, 1);
 
-      if (field_pic_flag != priv->picture.h264.field_pic_flag)
+      if (!field_pic_flag && field_pic_flag != priv->picture.h264.field_pic_flag)
          vid_dec_h264_EndFrame(priv);
 
       priv->picture.h264.field_pic_flag = field_pic_flag;
-- 
1.7.9.5

