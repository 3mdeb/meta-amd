From d6fbc932ccaa57cd9832cb758802b17427e5a086 Mon Sep 17 00:00:00 2001
From: Vitaly Prosyak <vitaly.prosyak@amd.com>
Date: Tue, 11 Oct 2016 14:25:26 -0500
Subject: [PATCH 1224/1722] drm/amd/dal: Fix null stream on disable output

Regardless  edid read success, add sink to
freesync module.

Change-Id: I2a2aa7419ffe4d1b20adb9923bb3c7afba63a306
Signed-off-by: Vitaly Prosyak <vitaly.prosyak@amd.com>
Acked-by: Harry Wentland <harry.wentland@amd.com>
Signed-off-by: Kalyan Alle <kalyan.alle@amd.com>
---
 drivers/gpu/drm/amd/dal/amdgpu_dm/amdgpu_dm.c       |  4 ++--
 drivers/gpu/drm/amd/dal/amdgpu_dm/amdgpu_dm_types.c | 14 ++++++++------
 2 files changed, 10 insertions(+), 8 deletions(-)

diff --git a/drivers/gpu/drm/amd/dal/amdgpu_dm/amdgpu_dm.c b/drivers/gpu/drm/amd/dal/amdgpu_dm/amdgpu_dm.c
index d0f48b8..4754b9f 100644
--- a/drivers/gpu/drm/amd/dal/amdgpu_dm/amdgpu_dm.c
+++ b/drivers/gpu/drm/amd/dal/amdgpu_dm/amdgpu_dm.c
@@ -826,12 +826,12 @@ void amdgpu_dm_update_connector_after_detect(
 			aconnector->edid =
 				(struct edid *) sink->dc_edid.raw_edid;
 
-			amdgpu_dm_add_sink_to_freesync_module(
-					connector, aconnector->edid);
 
 			drm_mode_connector_update_edid_property(connector,
 					aconnector->edid);
 		}
+		amdgpu_dm_add_sink_to_freesync_module(connector, aconnector->edid);
+
 	} else {
 		amdgpu_dm_remove_sink_from_freesync_module(connector);
 		drm_mode_connector_update_edid_property(connector, NULL);
diff --git a/drivers/gpu/drm/amd/dal/amdgpu_dm/amdgpu_dm_types.c b/drivers/gpu/drm/amd/dal/amdgpu_dm/amdgpu_dm_types.c
index 3019c00..11ac421 100644
--- a/drivers/gpu/drm/amd/dal/amdgpu_dm/amdgpu_dm_types.c
+++ b/drivers/gpu/drm/amd/dal/amdgpu_dm/amdgpu_dm_types.c
@@ -3128,13 +3128,15 @@ void amdgpu_dm_add_sink_to_freesync_module(
 	if (!adev->dm.freesync_module)
 		return;
 	/*
-	 * restrict for now freesync only for dp and edp
+	 * if edid non zero restrict freesync only for dp and edp
 	 */
-	if (amdgpu_connector->dc_sink->sink_signal == SIGNAL_TYPE_DISPLAY_PORT
-	    || amdgpu_connector->dc_sink->sink_signal == SIGNAL_TYPE_EDP) {
-		edid_check_required = is_dp_capable_without_timing_msa(
-					adev->dm.dc,
-					amdgpu_connector);
+	if (edid) {
+		if (amdgpu_connector->dc_sink->sink_signal == SIGNAL_TYPE_DISPLAY_PORT
+			|| amdgpu_connector->dc_sink->sink_signal == SIGNAL_TYPE_EDP) {
+			edid_check_required = is_dp_capable_without_timing_msa(
+						adev->dm.dc,
+						amdgpu_connector);
+		}
 	}
 	val_capable = 0;
 	if (edid_check_required == true && (edid->version > 1 ||
-- 
2.7.4

