From 7207d5feb832279ae767f79a2dc46946135fb7a1 Mon Sep 17 00:00:00 2001
From: Mykola Lysenko <Mykola.Lysenko@amd.com>
Date: Fri, 29 Apr 2016 13:48:21 +0800
Subject: [PATCH 0465/1722] drm/amd/dal: free memory on driver unload

Signed-off-by: Mykola Lysenko <Mykola.Lysenko@amd.com>
Acked-by: Harry Wentland <harry.wentland@amd.com>
Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
Signed-off-by: Kalyan Alle <kalyan.alle@amd.com>
---
 drivers/gpu/drm/amd/dal/dc/core/dc_link.c           | 8 ++++++++
 drivers/gpu/drm/amd/dal/modules/freesync/freesync.c | 6 ++++++
 2 files changed, 14 insertions(+)

diff --git a/drivers/gpu/drm/amd/dal/dc/core/dc_link.c b/drivers/gpu/drm/amd/dal/dc/core/dc_link.c
index 141bbba..f6ff1b7 100644
--- a/drivers/gpu/drm/amd/dal/dc/core/dc_link.c
+++ b/drivers/gpu/drm/amd/dal/dc/core/dc_link.c
@@ -58,11 +58,19 @@ enum {
  ******************************************************************************/
 static void destruct(struct core_link *link)
 {
+	int i;
+
 	if (link->ddc)
 		dal_ddc_service_destroy(&link->ddc);
 
 	if(link->link_enc)
 		link->link_enc->funcs->destroy(&link->link_enc);
+
+	if (link->public.local_sink)
+		dc_sink_release(link->public.local_sink);
+
+	for (i = 0; i < link->public.sink_count; ++i)
+		dc_sink_release(link->public.remote_sinks[i]);
 }
 
 /*
diff --git a/drivers/gpu/drm/amd/dal/modules/freesync/freesync.c b/drivers/gpu/drm/amd/dal/modules/freesync/freesync.c
index 002dbad..ed5a5af 100644
--- a/drivers/gpu/drm/amd/dal/modules/freesync/freesync.c
+++ b/drivers/gpu/drm/amd/dal/modules/freesync/freesync.c
@@ -93,8 +93,14 @@ fail_alloc_context:
 void mod_freesync_destroy(struct mod_freesync *mod_freesync)
 {
 	if (mod_freesync != NULL) {
+		int i;
 		struct core_freesync *core_freesync = MOD_FREESYNC_TO_CORE(mod_freesync);
 
+		for (i = 0; i < core_freesync->num_sinks; i++)
+			dc_sink_release(core_freesync->caps[i].sink);
+
+		dm_free(core_freesync->caps);
+
 		dm_free(core_freesync);
 	}
 }
-- 
2.7.4

