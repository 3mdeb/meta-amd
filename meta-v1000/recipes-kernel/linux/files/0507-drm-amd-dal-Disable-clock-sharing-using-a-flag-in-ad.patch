From 55f8d6d58d306d99fe18ac5bdc06e01aad117536 Mon Sep 17 00:00:00 2001
From: Prokhar Bhowal <Prokhar.Bhowal@amd.com>
Date: Fri, 27 May 2016 16:56:11 -0400
Subject: [PATCH 0507/1722] drm/amd/dal: Disable clock sharing using a flag in
 adapter service

Signed-off-by: Prokhar Bhowal <Prokhar.Bhowal@amd.com>
Acked-by: Harry Wentland <harry.wentland@amd.com>
Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
Signed-off-by: Kalyan Alle <kalyan.alle@amd.com>
---
 drivers/gpu/drm/amd/dal/dc/adapter/adapter_service.c        |  4 +++-
 drivers/gpu/drm/amd/dal/dc/core/dc_resource.c               | 11 +++++++----
 drivers/gpu/drm/amd/dal/dc/dc_types.h                       |  1 +
 drivers/gpu/drm/amd/dal/include/adapter_service_interface.h |  5 +++--
 4 files changed, 14 insertions(+), 7 deletions(-)

diff --git a/drivers/gpu/drm/amd/dal/dc/adapter/adapter_service.c b/drivers/gpu/drm/amd/dal/dc/adapter/adapter_service.c
index b4f9750..9cf5907 100644
--- a/drivers/gpu/drm/amd/dal/dc/adapter/adapter_service.c
+++ b/drivers/gpu/drm/amd/dal/dc/adapter/adapter_service.c
@@ -180,7 +180,8 @@ static struct feature_source_entry feature_entry_table[] = {
 	{FEATURE_DPMS_AUDIO_ENDPOINT_CONTROL, true, true},
 	{FEATURE_DISABLE_FBC_COMP_CLK_GATE, false, true},
 	{FEATURE_PIXEL_PERFECT_OUTPUT, false, true},
-	{FEATURE_8BPP_SUPPORTED, false, true}
+	{FEATURE_8BPP_SUPPORTED, false, true},
+	{FEATURE_DISABLE_CLOCK_SHARING, false, true}
 };
 
 /* Stores entire ASIC features by sets */
@@ -433,6 +434,7 @@ static bool override_default_parameters(
 	check_bool_feature(DISABLE_LPT_SUPPORT);
 	check_bool_feature(DUMMY_FBC_BACKEND);
 	check_bool_feature(ENABLE_GPU_SCALING);
+	check_bool_feature(DISABLE_CLOCK_SHARING);
 	default:
 		return false;
 	}
diff --git a/drivers/gpu/drm/amd/dal/dc/core/dc_resource.c b/drivers/gpu/drm/amd/dal/dc/core/dc_resource.c
index ecd5f82..1979170 100644
--- a/drivers/gpu/drm/amd/dal/dc/core/dc_resource.c
+++ b/drivers/gpu/drm/amd/dal/dc/core/dc_resource.c
@@ -219,11 +219,14 @@ struct clock_source *resource_find_used_clk_src_for_sharing(
 					struct resource_context *res_ctx,
 					struct pipe_ctx *pipe_ctx)
 {
-	int i;
+	if (!dal_adapter_service_is_feature_supported
+			(FEATURE_DISABLE_CLOCK_SHARING)) {
+		int i;
 
-	for (i = 0; i < MAX_PIPES; i++) {
-		if (is_sharable_clk_src(&res_ctx->pipe_ctx[i], pipe_ctx))
-			return res_ctx->pipe_ctx[i].clock_source;
+		for (i = 0; i < MAX_PIPES; i++) {
+			if (is_sharable_clk_src(&res_ctx->pipe_ctx[i], pipe_ctx))
+				return res_ctx->pipe_ctx[i].clock_source;
+		}
 	}
 
 	return NULL;
diff --git a/drivers/gpu/drm/amd/dal/dc/dc_types.h b/drivers/gpu/drm/amd/dal/dc/dc_types.h
index fd76440..e32154f 100644
--- a/drivers/gpu/drm/amd/dal/dc/dc_types.h
+++ b/drivers/gpu/drm/amd/dal/dc/dc_types.h
@@ -157,6 +157,7 @@ enum bool_param_shift {
 	DAL_PARAM_DISABLE_LPT_SUPPORT,
 	DAL_PARAM_DUMMY_FBC_BACKEND,
 	DAL_PARAM_ENABLE_GPU_SCALING,
+	DAL_PARAM_DISABLE_CLOCK_SHARING,
 	DAL_BOOL_PARAM_MAX
 };
 
diff --git a/drivers/gpu/drm/amd/dal/include/adapter_service_interface.h b/drivers/gpu/drm/amd/dal/include/adapter_service_interface.h
index cc093b1..59f395b 100644
--- a/drivers/gpu/drm/amd/dal/include/adapter_service_interface.h
+++ b/drivers/gpu/drm/amd/dal/include/adapter_service_interface.h
@@ -95,7 +95,7 @@ enum adapter_feature_id {
 	FEATURE_HDMI_DISABLE_DITHERING,
 	FEATURE_DP_DISABLE_DITHERING, /* 30th */
 	FEATURE_EMBEDDED_DISABLE_DITHERING,
-	FEATURE_DISABLE_AZ_CLOCK_GATING, /* 32th. This set is full */
+	FEATURE_DISABLE_AZ_CLOCK_GATING, /* 32nd. This set is full */
 	FEATURE_SET_01_END = FEATURE_SET_01_START + 31,
 
 	/* Boolean set, up to 32 entries */
@@ -130,7 +130,8 @@ enum adapter_feature_id {
 	FEATURE_SUPPORT_EXTERNAL_PANEL_DRR,
 	FEATURE_SUPPORT_SMOOTH_BRIGHTNESS,
 	FEATURE_ALLOW_DIRECT_MEMORY_ACCESS_TRIG, /* 30th */
-	FEATURE_POWER_GATING_LB_PORTION, /* 31nd. One more left. */
+	FEATURE_POWER_GATING_LB_PORTION,
+	FEATURE_DISABLE_CLOCK_SHARING, /* 32nd. Set Done. */
 	FEATURE_SET_02_END = FEATURE_SET_02_START + 31,
 
 	/* UInt set, 1 entry: DCP Bit Depth Reduction Mode */
-- 
2.7.4

