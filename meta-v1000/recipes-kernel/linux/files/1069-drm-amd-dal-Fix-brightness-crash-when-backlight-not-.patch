From 50a3d6790e53e146b336af2a6d4fc54a1e65a3c4 Mon Sep 17 00:00:00 2001
From: Krunoslav Kovac <Krunoslav.Kovac@amd.com>
Date: Fri, 9 Sep 2016 17:44:47 -0400
Subject: [PATCH 1069/1722] drm/amd/dal: Fix brightness crash when backlight
 not supported

Change-Id: I26b29f40dc4473b38dac30bc1a9a2924f5acf565
Signed-off-by: Krunoslav Kovac <Krunoslav.Kovac@amd.com>
Acked-by: Harry Wentland <harry.wentland@amd.com>
Signed-off-by: Kalyan Alle <kalyan.alle@amd.com>
---
 drivers/gpu/drm/amd/dal/modules/backlight/backlight.c | 7 +++++++
 1 file changed, 7 insertions(+)

diff --git a/drivers/gpu/drm/amd/dal/modules/backlight/backlight.c b/drivers/gpu/drm/amd/dal/modules/backlight/backlight.c
index 8796765..14fc3ea 100644
--- a/drivers/gpu/drm/amd/dal/modules/backlight/backlight.c
+++ b/drivers/gpu/drm/amd/dal/modules/backlight/backlight.c
@@ -173,6 +173,7 @@ struct mod_backlight *mod_backlight_create(struct dc *dc)
 		goto fail_alloc_state;
 
 	core_backlight->num_sinks = 0;
+	backlight_caps_valid = false;
 
 	if (dc == NULL)
 		goto fail_construct;
@@ -355,6 +356,9 @@ void mod_backlight_initialize_backlight_caps(struct mod_backlight
 		customCurvePresent     = (pExtCaps->numOfDataPoints > 0);
 
 		ASSERT(pExtCaps->numOfDataPoints <= 99);
+	} else {
+		dm_free(pExtCaps);
+		return;
 	}
 
 	if (customMinMaxPresent)
@@ -531,6 +535,9 @@ unsigned int mod_backlight_backlight_level_signal_to_percentage(
 				max = mid - 1;
 			else
 				break;
+
+			if (max == 0)
+				return invalid_backlight;
 		}
 		return mid;
 	}
-- 
2.7.4

