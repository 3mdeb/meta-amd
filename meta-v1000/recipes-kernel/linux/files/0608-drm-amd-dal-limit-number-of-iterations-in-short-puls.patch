From 79d52eeadcc48f21d0825893d0f892a71b592510 Mon Sep 17 00:00:00 2001
From: Mykola Lysenko <Mykola.Lysenko@amd.com>
Date: Thu, 5 May 2016 06:46:47 -0400
Subject: [PATCH 0608/1722] drm/amd/dal: limit number of iterations in short
 pulse handler

Change-Id: I39b03dd7cf269eaa88e9c9f5da8bdc9f9ae12491
Signed-off-by: Mykola Lysenko <Mykola.Lysenko@amd.com>
Acked-by: Harry Wentland <harry.wentland@amd.com>
Signed-off-by: Kalyan Alle <kalyan.alle@amd.com>
---
 drivers/gpu/drm/amd/dal/amdgpu_dm/amdgpu_dm.c | 11 ++++++++++-
 1 file changed, 10 insertions(+), 1 deletion(-)

diff --git a/drivers/gpu/drm/amd/dal/amdgpu_dm/amdgpu_dm.c b/drivers/gpu/drm/amd/dal/amdgpu_dm/amdgpu_dm.c
index c444d04..b04e213 100644
--- a/drivers/gpu/drm/amd/dal/amdgpu_dm/amdgpu_dm.c
+++ b/drivers/gpu/drm/amd/dal/amdgpu_dm/amdgpu_dm.c
@@ -845,6 +845,9 @@ static void dm_handle_hpd_rx_irq(struct amdgpu_connector *aconnector)
 	int dpcd_addr;
 	int dpcd_bytes_to_read;
 
+	const int max_process_count = 30;
+	int process_count = 0;
+
 	const struct dc_link_status *link_status = dc_link_get_status(aconnector->dc_link);
 
 	if (link_status->dpcd_caps->dpcd_rev.raw < 0x12) {
@@ -863,10 +866,13 @@ static void dm_handle_hpd_rx_irq(struct amdgpu_connector *aconnector)
 		esi,
 		dpcd_bytes_to_read);
 
-	while (dret == dpcd_bytes_to_read) {
+	while (dret == dpcd_bytes_to_read &&
+		process_count < max_process_count) {
 		uint8_t retry;
 		dret = 0;
 
+		process_count++;
+
 		DRM_DEBUG_KMS("ESI %02x %02x %02x\n", esi[0], esi[1], esi[2]);
 #if LINUX_VERSION_CODE >= KERNEL_VERSION(4, 3, 0)
 		/* handle HPD short pulse irq */
@@ -905,6 +911,9 @@ static void dm_handle_hpd_rx_irq(struct amdgpu_connector *aconnector)
 		} else
 			break;
 	}
+
+	if (process_count == max_process_count)
+		DRM_DEBUG_KMS("Loop exceeded max iterations\n");
 }
 
 static void handle_hpd_rx_irq(void *param)
-- 
2.7.4

