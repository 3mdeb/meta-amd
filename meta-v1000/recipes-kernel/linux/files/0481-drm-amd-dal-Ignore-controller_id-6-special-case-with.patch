From 313b3f3ce5391dbb182d418d4cfc9f510f1c40b9 Mon Sep 17 00:00:00 2001
From: Prokhar Bhowal <Prokhar.Bhowal@amd.com>
Date: Wed, 11 May 2016 12:16:16 -0400
Subject: [PATCH 0481/1722] drm/amd/dal: Ignore controller_id==6 special case
 with bp

Signed-off-by: Prokar Bhowal <Prokar.Bhowal@amd.com>
Acked-by: Jordan Lazare <Jordan.Lazare@amd.com>
Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
Signed-off-by: Kalyan Alle <kalyan.alle@amd.com>
---
 drivers/gpu/drm/amd/dal/dc/dce110/dce110_hw_sequencer.c | 17 +++++++++++++++--
 .../gpu/drm/amd/dal/dc/dce110/dce110_timing_generator.c |  2 +-
 2 files changed, 16 insertions(+), 3 deletions(-)

diff --git a/drivers/gpu/drm/amd/dal/dc/dce110/dce110_hw_sequencer.c b/drivers/gpu/drm/amd/dal/dc/dce110/dce110_hw_sequencer.c
index c1ae34a..4d02f5a 100644
--- a/drivers/gpu/drm/amd/dal/dc/dce110/dce110_hw_sequencer.c
+++ b/drivers/gpu/drm/amd/dal/dc/dce110/dce110_hw_sequencer.c
@@ -369,9 +369,22 @@ static bool dce110_enable_display_power_gating(
 	if (controller_id == DCE110_UNDERLAY_IDX)
 		controller_id = CONTROLLER_ID_UNDERLAY0 - 1;
 
-	if (power_gating != PIPE_GATING_CONTROL_INIT || controller_id == 0)
-		bp_result = dc_bios_enable_disp_power_gating(dcb, controller_id + 1, cntl);
+        if (power_gating != PIPE_GATING_CONTROL_INIT || controller_id == 0){
 
+		bp_result = dc_bios_enable_disp_power_gating(dcb, controller_id + 1, cntl);
+                /* Revert MASTER_UPDATE_MODE to 0 because bios sets it 2
+                 * by default when command table is called
+                 *
+                 * Bios parser accepts controller_id = 6 as indicative of
+                 * underlay pipe in dce110. But we do not support more
+                 * than 3.
+                 */
+                if (controller_id < CONTROLLER_ID_MAX - 1)
+                        dm_write_reg(ctx,
+                                HW_REG_CRTC(mmCRTC_MASTER_UPDATE_MODE, controller_id),
+                                0);
+        }
+ 
 	if (power_gating != PIPE_GATING_CONTROL_ENABLE)
 		dce110_init_pte(ctx);
 
diff --git a/drivers/gpu/drm/amd/dal/dc/dce110/dce110_timing_generator.c b/drivers/gpu/drm/amd/dal/dc/dce110/dce110_timing_generator.c
index 5572995..643ed9a 100644
--- a/drivers/gpu/drm/amd/dal/dc/dce110/dce110_timing_generator.c
+++ b/drivers/gpu/drm/amd/dal/dc/dce110/dce110_timing_generator.c
@@ -281,7 +281,7 @@ bool dce110_timing_generator_enable_crtc(struct timing_generator *tg)
 	 */
 	set_reg_field_value(
 		value,
-		3,
+		0,
 		CRTC_MASTER_UPDATE_MODE,
 		MASTER_UPDATE_MODE);
 
-- 
2.7.4

