From 4e9e7cfbadd19298ba8ccfcc9e814de039247a05 Mon Sep 17 00:00:00 2001
From: Yongqiang Sun <yongqiang.sun@amd.com>
Date: Thu, 14 Jul 2016 10:54:35 -0400
Subject: [PATCH 0647/1722] drm/amd/dal: add disable stutter mode to dce112 and
 underlay

Signed-off-by: Yongqiang Sun <yongqiang.sun@amd.com>
Acked-by: Harry Wentland <harry.wentland@amd.com>
Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
Signed-off-by: Kalyan Alle <kalyan.alle@amd.com>
---
 .../gpu/drm/amd/dal/dc/dce110/dce110_mem_input_v.c | 25 ++++++-------
 .../gpu/drm/amd/dal/dc/dce112/dce112_mem_input.c   | 43 ++++++----------------
 2 files changed, 24 insertions(+), 44 deletions(-)

diff --git a/drivers/gpu/drm/amd/dal/dc/dce110/dce110_mem_input_v.c b/drivers/gpu/drm/amd/dal/dc/dce110/dce110_mem_input_v.c
index f2c5659..c33d5b8 100644
--- a/drivers/gpu/drm/amd/dal/dc/dce110/dce110_mem_input_v.c
+++ b/drivers/gpu/drm/amd/dal/dc/dce110/dce110_mem_input_v.c
@@ -777,10 +777,18 @@ static void program_stutter_watermark(
 
 	stutter_cntl = dm_read_reg(ctx, stutter_addr);
 
-	set_reg_field_value(stutter_cntl,
-		1,
-		DPGV0_PIPE_STUTTER_CONTROL,
-		STUTTER_ENABLE);
+	if (ctx->dc->debug.disable_stutter) {
+		set_reg_field_value(stutter_cntl,
+			0,
+			DPGV0_PIPE_STUTTER_CONTROL,
+			STUTTER_ENABLE);
+	} else {
+		set_reg_field_value(stutter_cntl,
+			1,
+			DPGV0_PIPE_STUTTER_CONTROL,
+			STUTTER_ENABLE);
+	}
+
 	set_reg_field_value(stutter_cntl,
 		1,
 		DPGV0_PIPE_STUTTER_CONTROL,
@@ -802,15 +810,6 @@ static void program_stutter_watermark(
 	dm_write_reg(ctx, wm_addr, wm_mask_cntl);
 
 	stutter_cntl = dm_read_reg(ctx, stutter_addr);
-	set_reg_field_value(stutter_cntl,
-		1,
-		DPGV0_PIPE_STUTTER_CONTROL,
-		STUTTER_ENABLE);
-	set_reg_field_value(stutter_cntl,
-		1,
-		DPGV0_PIPE_STUTTER_CONTROL,
-		STUTTER_IGNORE_FBC);
-
 	/*Write watermark set B*/
 	set_reg_field_value(stutter_cntl,
 		marks.b_mark,
diff --git a/drivers/gpu/drm/amd/dal/dc/dce112/dce112_mem_input.c b/drivers/gpu/drm/amd/dal/dc/dce112/dce112_mem_input.c
index 4647177..dcbe9b4 100644
--- a/drivers/gpu/drm/amd/dal/dc/dce112/dce112_mem_input.c
+++ b/drivers/gpu/drm/amd/dal/dc/dce112/dce112_mem_input.c
@@ -157,10 +157,18 @@ static void program_stutter_watermark(
 
 	stutter_cntl = dm_read_reg(ctx, stutter_addr);
 
-	set_reg_field_value(stutter_cntl,
-		1,
-		DPG_PIPE_STUTTER_CONTROL,
-		STUTTER_ENABLE);
+	if (ctx->dc->debug.disable_stutter) {
+		set_reg_field_value(stutter_cntl,
+			0,
+			DPG_PIPE_STUTTER_CONTROL,
+			STUTTER_ENABLE);
+	} else {
+		set_reg_field_value(stutter_cntl,
+			1,
+			DPG_PIPE_STUTTER_CONTROL,
+			STUTTER_ENABLE);
+	}
+
 	set_reg_field_value(stutter_cntl,
 		1,
 		DPG_PIPE_STUTTER_CONTROL,
@@ -182,15 +190,6 @@ static void program_stutter_watermark(
 	dm_write_reg(ctx, wm_addr, wm_mask_cntl);
 
 	stutter_cntl = dm_read_reg(ctx, stutter_addr);
-	set_reg_field_value(stutter_cntl,
-		1,
-		DPG_PIPE_STUTTER_CONTROL,
-		STUTTER_ENABLE);
-	set_reg_field_value(stutter_cntl,
-		1,
-		DPG_PIPE_STUTTER_CONTROL,
-		STUTTER_IGNORE_FBC);
-
 	/*Write watermark set B*/
 	set_reg_field_value(stutter_cntl,
 		marks.b_mark,
@@ -207,15 +206,6 @@ static void program_stutter_watermark(
 	dm_write_reg(ctx, wm_addr, wm_mask_cntl);
 
 	stutter_cntl = dm_read_reg(ctx, stutter_addr);
-	set_reg_field_value(stutter_cntl,
-		1,
-		DPG_PIPE_STUTTER_CONTROL,
-		STUTTER_ENABLE);
-	set_reg_field_value(stutter_cntl,
-		1,
-		DPG_PIPE_STUTTER_CONTROL,
-		STUTTER_IGNORE_FBC);
-
 	/*Write watermark set C*/
 	set_reg_field_value(stutter_cntl,
 		marks.c_mark,
@@ -232,15 +222,6 @@ static void program_stutter_watermark(
 	dm_write_reg(ctx, wm_addr, wm_mask_cntl);
 
 	stutter_cntl = dm_read_reg(ctx, stutter_addr);
-	set_reg_field_value(stutter_cntl,
-		1,
-		DPG_PIPE_STUTTER_CONTROL,
-		STUTTER_ENABLE);
-	set_reg_field_value(stutter_cntl,
-		1,
-		DPG_PIPE_STUTTER_CONTROL,
-		STUTTER_IGNORE_FBC);
-
 	/*Write watermark set D*/
 	set_reg_field_value(stutter_cntl,
 		marks.d_mark,
-- 
2.7.4

