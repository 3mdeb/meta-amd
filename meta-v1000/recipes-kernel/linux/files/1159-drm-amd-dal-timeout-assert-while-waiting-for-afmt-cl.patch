From e9bdd946688b70592fc0cbb98925c883e238ae93 Mon Sep 17 00:00:00 2001
From: Hersen Wu <hersenxs.wu@amd.com>
Date: Wed, 28 Sep 2016 15:27:02 -0400
Subject: [PATCH 1159/1722] drm/amd/dal: timeout assert while waiting for afmt
 clock_on state

Change-Id: I98846e09cb5b5c10b7a1e6c06ea0dde6e6af3208
Signed-off-by: Hersen Wu <hersenxs.wu@amd.com>
Acked-by: Harry Wentland <harry.wentland@amd.com>
Signed-off-by: Kalyan Alle <kalyan.alle@amd.com>
---
 .../drm/amd/dal/dc/dce110/dce110_hw_sequencer.c    | 29 +++++++++++++---------
 .../drm/amd/dal/dc/dce110/dce110_stream_encoder.c  |  8 ++++--
 2 files changed, 23 insertions(+), 14 deletions(-)

diff --git a/drivers/gpu/drm/amd/dal/dc/dce110/dce110_hw_sequencer.c b/drivers/gpu/drm/amd/dal/dc/dce110/dce110_hw_sequencer.c
index b262923..46976ea 100644
--- a/drivers/gpu/drm/amd/dal/dc/dce110/dce110_hw_sequencer.c
+++ b/drivers/gpu/drm/amd/dal/dc/dce110/dce110_hw_sequencer.c
@@ -570,23 +570,16 @@ static void disable_stream(struct pipe_ctx *pipe_ctx)
 	struct core_stream *stream = pipe_ctx->stream;
 	struct core_link *link = stream->sink->link;
 
-	if (dc_is_hdmi_signal(pipe_ctx->stream->signal))
-		pipe_ctx->stream_enc->funcs->stop_hdmi_info_packets(
-			pipe_ctx->stream_enc);
-
-	if (dc_is_dp_signal(pipe_ctx->stream->signal))
-		pipe_ctx->stream_enc->funcs->stop_dp_info_packets(
-			pipe_ctx->stream_enc);
-
 	if (pipe_ctx->audio) {
-		pipe_ctx->stream_enc->funcs->audio_mute_control(pipe_ctx->stream_enc, true);
+		pipe_ctx->audio->funcs->az_disable(pipe_ctx->audio);
 
 		if (dc_is_dp_signal(pipe_ctx->stream->signal))
-			pipe_ctx->stream_enc->funcs->dp_audio_disable(pipe_ctx->stream_enc);
+			pipe_ctx->stream_enc->funcs->dp_audio_disable(
+					pipe_ctx->stream_enc);
 		else
-			pipe_ctx->stream_enc->funcs->hdmi_audio_disable(pipe_ctx->stream_enc);
+			pipe_ctx->stream_enc->funcs->hdmi_audio_disable(
+					pipe_ctx->stream_enc);
 
-		pipe_ctx->audio->funcs->az_disable(pipe_ctx->audio);
 		pipe_ctx->audio = NULL;
 
 		/* TODO: notify audio driver for if audio modes list changed
@@ -596,6 +589,18 @@ static void disable_stream(struct pipe_ctx *pipe_ctx)
 		 */
 	}
 
+	if (dc_is_hdmi_signal(pipe_ctx->stream->signal))
+		pipe_ctx->stream_enc->funcs->stop_hdmi_info_packets(
+			pipe_ctx->stream_enc);
+
+	if (dc_is_dp_signal(pipe_ctx->stream->signal))
+		pipe_ctx->stream_enc->funcs->stop_dp_info_packets(
+			pipe_ctx->stream_enc);
+
+	pipe_ctx->stream_enc->funcs->audio_mute_control(
+			pipe_ctx->stream_enc, true);
+
+
 	/* blank at encoder level */
 	if (dc_is_dp_signal(pipe_ctx->stream->signal))
 		pipe_ctx->stream_enc->funcs->dp_blank(pipe_ctx->stream_enc);
diff --git a/drivers/gpu/drm/amd/dal/dc/dce110/dce110_stream_encoder.c b/drivers/gpu/drm/amd/dal/dc/dce110/dce110_stream_encoder.c
index 5861606..7420e11 100644
--- a/drivers/gpu/drm/amd/dal/dc/dce110/dce110_stream_encoder.c
+++ b/drivers/gpu/drm/amd/dal/dc/dce110/dce110_stream_encoder.c
@@ -1226,9 +1226,13 @@ static void dce110_se_enable_audio_clock(
 
 	/* wait for AFMT clock to turn on,
 	 * expectation: this should complete in 1-2 reads
+	 *
+	 * REG_WAIT(AFMT_CNTL, AFMT_AUDIO_CLOCK_ON, !!enable, 1, 10);
+	 *
+	 * TODO: wait for clock_on does not work well. May need HW
+	 * program sequence. But audio seems work normally even without wait
+	 * for clock_on status change
 	 */
-	REG_WAIT(AFMT_CNTL, AFMT_AUDIO_CLOCK_ON, !!enable,
-			1, 10);
 }
 
 static void dce110_se_enable_dp_audio(
-- 
2.7.4

