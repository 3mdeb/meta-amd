From 907ec686b37fb735fabae38699bdb1c2597a523a Mon Sep 17 00:00:00 2001
From: Ayyappa Ch <ayyappa.chandolu@amd.com>
Date: Fri, 27 Jan 2017 15:47:21 +0530
Subject: [PATCH 1659/1722] drm/amdgpu: Add eviction_valuable TTM callback

Change-Id: I6255ebffb7efa70fa4a1a17ff77e71e79145c502
Signed-off-by: Harish Kasiviswanathan <Harish.Kasiviswanathan@amd.com>
Signed-off-by: Ayyappa Ch <ayyappa.chandolu@amd.com>
---
 drivers/gpu/drm/amd/amdgpu/amdgpu_ttm.c | 27 ++++++++++++++++++++++++++-
 1 file changed, 26 insertions(+), 1 deletion(-)

diff --git a/drivers/gpu/drm/amd/amdgpu/amdgpu_ttm.c b/drivers/gpu/drm/amd/amdgpu/amdgpu_ttm.c
index e9b3ea3..65b7e93 100644
--- a/drivers/gpu/drm/amd/amdgpu/amdgpu_ttm.c
+++ b/drivers/gpu/drm/amd/amdgpu/amdgpu_ttm.c
@@ -44,6 +44,7 @@
 #include <linux/debugfs.h>
 #include "amdgpu.h"
 #include "bif/bif_4_1_d.h"
+#include "amdgpu_amdkfd.h"
 
 #define DRM_FILE_PAGE_OFFSET (0x100000000ULL >> PAGE_SHIFT)
 
@@ -1130,6 +1131,10 @@ static struct list_head *amdgpu_ttm_swap_lru_tail(struct ttm_buffer_object *tbo)
 static bool amdgpu_ttm_bo_eviction_valuable(struct ttm_buffer_object *bo,
 					    const struct ttm_place *place)
 {
+	struct reservation_object_list *flist;
+	struct fence *f;
+	int i;
+	
 	if (bo->mem.mem_type == TTM_PL_VRAM &&
 	    bo->mem.start == AMDGPU_BO_INVALID_OFFSET) {
 		unsigned long num_pages = bo->mem.num_pages;
@@ -1148,7 +1153,27 @@ static bool amdgpu_ttm_bo_eviction_valuable(struct ttm_buffer_object *bo,
 		return false;
 	}
 
-	return ttm_bo_eviction_valuable(bo, place);
+	/* Don't evict this BO if it's outside of the
+	 * requested placement range
+	 */
+	if (!ttm_bo_eviction_valuable(bo, place))
+		return false;
+	/* If bo is a KFD BO, check if the bo belongs to the current process.
+	 * If true, then return false as any KFD process needs all its BOs to
+	 * be resident to run successfully
+	 */
+	flist = reservation_object_get_list(bo->resv);
+	if (!flist)
+		return true;
+
+	for (i = 0; i < flist->shared_count; ++i) {
+		f = rcu_dereference_protected(flist->shared[i],
+			reservation_object_held(bo->resv));
+		if (amd_kfd_fence_check_mm(f, current->mm))
+			return false;
+	}
+
+	return true;
 }
 
 static struct ttm_bo_driver amdgpu_bo_driver = {
-- 
2.7.4

