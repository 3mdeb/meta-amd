From aa399c9b8bab3903c30482ccb1493315e6431b9c Mon Sep 17 00:00:00 2001
From: Dmytro Laktyushkin <Dmytro.Laktyushkin@amd.com>
Date: Fri, 5 Aug 2016 15:17:50 -0400
Subject: [PATCH 0724/1722] drm/amd/dal: add pending surfaces to allow matching
 pre commit to flip

Signed-off-by: Dmytro Laktyushkin <Dmytro.Laktyushkin@amd.com>
Acked-by: Harry Wentland <harry.wentland@amd.com>
Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
Signed-off-by: Kalyan Alle <kalyan.alle@amd.com>
---
 drivers/gpu/drm/amd/dal/dc/core/dc.c     | 18 ++++++++++++++----
 drivers/gpu/drm/amd/dal/dc/inc/core_dc.h |  1 +
 2 files changed, 15 insertions(+), 4 deletions(-)

diff --git a/drivers/gpu/drm/amd/dal/dc/core/dc.c b/drivers/gpu/drm/amd/dal/dc/core/dc.c
index 0454c40..3b14f56 100644
--- a/drivers/gpu/drm/amd/dal/dc/core/dc.c
+++ b/drivers/gpu/drm/amd/dal/dc/core/dc.c
@@ -1105,17 +1105,22 @@ bool dc_isr_commit_surfaces_to_target(
                 status = core_dc->hwss.apply_ctx_to_surface_unlock(core_dc, core_dc->pending_context);
                 core_dc->pending_context->locked = false;
         }
- 
+        if (core_dc->pending_context) {
+                ASSERT(core_dc->retired_context == NULL);
+                core_dc->retired_context = core_dc->current_context;
+                core_dc->current_context = core_dc->pending_context;
+                core_dc->pending_context = NULL;
+        }
+  
         return status == DC_OK;
 }
 
 bool dc_post_commit_surfaces_to_target(
                 struct dc *dc)
 {
-        int i;
         struct core_dc *core_dc = DC_TO_CORE(dc);
- 
-        if (!core_dc->pending_context)
+        
+	if (!core_dc->pending_context)
                 return true;
  
         if (core_dc->pending_context->locked)
@@ -1141,6 +1146,11 @@ bool dc_post_commit_surfaces_to_target(
 	dm_free(core_dc->current_context);
         core_dc->current_context = core_dc->pending_context;
         core_dc->pending_context = NULL;
+        if (core_dc->retired_context) {
+                resource_validate_ctx_destruct(core_dc->retired_context);
+                dm_free(core_dc->retired_context);
+                core_dc->retired_context = NULL;
+        }
 	return true;
 }
 
diff --git a/drivers/gpu/drm/amd/dal/dc/inc/core_dc.h b/drivers/gpu/drm/amd/dal/dc/inc/core_dc.h
index 4c29595..17efc25 100644
--- a/drivers/gpu/drm/amd/dal/dc/inc/core_dc.h
+++ b/drivers/gpu/drm/amd/dal/dc/inc/core_dc.h
@@ -22,6 +22,7 @@ struct coe_dc {
 	struct core_link *links[MAX_PIPES * 2];
 
 	/* TODO: determine max number of targets*/
+        struct validate_context *retired_context;
 	struct validate_context *current_context;
         struct validate_context *pending_context;
 	struct resource_pool res_pool;
-- 
2.7.4

