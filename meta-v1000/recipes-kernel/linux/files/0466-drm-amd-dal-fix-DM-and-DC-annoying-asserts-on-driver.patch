From 891580cca8e4d03971d5b6f6aca62bc7b9e1f09c Mon Sep 17 00:00:00 2001
From: Mykola Lysenko <Mykola.Lysenko@amd.com>
Date: Wed, 20 Apr 2016 18:03:02 +0800
Subject: [PATCH 0466/1722] drm/amd/dal: fix DM and DC annoying asserts on
 driver unload

Related to memory deallocation and irq unregistration

Signed-off-by: Mykola Lysenko <Mykola.Lysenko@amd.com>
Acked-by: Harry Wentland <harry.wentland@amd.com>
Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
Signed-off-by: Kalyan Alle <kalyan.alle@amd.com>
---
 .../gpu/drm/amd/dal/dc/dce100/dce100_resource.c    | 30 ++++++++++++++--------
 .../gpu/drm/amd/dal/dc/dce112/dce112_resource.c    | 30 ++++++++++++++--------
 2 files changed, 38 insertions(+), 22 deletions(-)

diff --git a/drivers/gpu/drm/amd/dal/dc/dce100/dce100_resource.c b/drivers/gpu/drm/amd/dal/dc/dce100/dce100_resource.c
index 90df1fb..165c0ef 100644
--- a/drivers/gpu/drm/amd/dal/dc/dce100/dce100_resource.c
+++ b/drivers/gpu/drm/amd/dal/dc/dce100/dce100_resource.c
@@ -477,17 +477,25 @@ struct output_pixel_processor *dce100_opp_create(
 
 void dce100_opp_destroy(struct output_pixel_processor **opp)
 {
-	dm_free(FROM_DCE11_OPP(*opp)->regamma.coeff128_dx);
-	dm_free(FROM_DCE11_OPP(*opp)->regamma.coeff128_oem);
-	dm_free(FROM_DCE11_OPP(*opp)->regamma.coeff128);
-	dm_free(FROM_DCE11_OPP(*opp)->regamma.axis_x_1025);
-	dm_free(FROM_DCE11_OPP(*opp)->regamma.axis_x_256);
-	dm_free(FROM_DCE11_OPP(*opp)->regamma.coordinates_x);
-	dm_free(FROM_DCE11_OPP(*opp)->regamma.rgb_regamma);
-	dm_free(FROM_DCE11_OPP(*opp)->regamma.rgb_resulted);
-	dm_free(FROM_DCE11_OPP(*opp)->regamma.rgb_oem);
-	dm_free(FROM_DCE11_OPP(*opp)->regamma.rgb_user);
-	dm_free(FROM_DCE11_OPP(*opp));
+	struct dce110_opp *dce110_opp;
+
+	if (!opp || !*opp)
+		return;
+
+	dce110_opp = FROM_DCE11_OPP(*opp);
+
+	dm_free(dce110_opp->regamma.coeff128_dx);
+	dm_free(dce110_opp->regamma.coeff128_oem);
+	dm_free(dce110_opp->regamma.coeff128);
+	dm_free(dce110_opp->regamma.axis_x_1025);
+	dm_free(dce110_opp->regamma.axis_x_256);
+	dm_free(dce110_opp->regamma.coordinates_x);
+	dm_free(dce110_opp->regamma.rgb_regamma);
+	dm_free(dce110_opp->regamma.rgb_resulted);
+	dm_free(dce110_opp->regamma.rgb_oem);
+	dm_free(dce110_opp->regamma.rgb_user);
+	dm_free(dce110_opp);
+
 	*opp = NULL;
 }
 
diff --git a/drivers/gpu/drm/amd/dal/dc/dce112/dce112_resource.c b/drivers/gpu/drm/amd/dal/dc/dce112/dce112_resource.c
index 3ee692c..79a5b93 100644
--- a/drivers/gpu/drm/amd/dal/dc/dce112/dce112_resource.c
+++ b/drivers/gpu/drm/amd/dal/dc/dce112/dce112_resource.c
@@ -493,17 +493,25 @@ struct output_pixel_processor *dce112_opp_create(
 
 void dce112_opp_destroy(struct output_pixel_processor **opp)
 {
-	dm_free(FROM_DCE11_OPP(*opp)->regamma.coeff128_dx);
-	dm_free(FROM_DCE11_OPP(*opp)->regamma.coeff128_oem);
-	dm_free(FROM_DCE11_OPP(*opp)->regamma.coeff128);
-	dm_free(FROM_DCE11_OPP(*opp)->regamma.axis_x_1025);
-	dm_free(FROM_DCE11_OPP(*opp)->regamma.axis_x_256);
-	dm_free(FROM_DCE11_OPP(*opp)->regamma.coordinates_x);
-	dm_free(FROM_DCE11_OPP(*opp)->regamma.rgb_regamma);
-	dm_free(FROM_DCE11_OPP(*opp)->regamma.rgb_resulted);
-	dm_free(FROM_DCE11_OPP(*opp)->regamma.rgb_oem);
-	dm_free(FROM_DCE11_OPP(*opp)->regamma.rgb_user);
-	dm_free(FROM_DCE11_OPP(*opp));
+	struct dce110_opp *dce110_opp;
+
+	if (!opp || !*opp)
+		return;
+
+	dce110_opp = FROM_DCE11_OPP(*opp);
+
+	dm_free(dce110_opp->regamma.coeff128_dx);
+	dm_free(dce110_opp->regamma.coeff128_oem);
+	dm_free(dce110_opp->regamma.coeff128);
+	dm_free(dce110_opp->regamma.axis_x_1025);
+	dm_free(dce110_opp->regamma.axis_x_256);
+	dm_free(dce110_opp->regamma.coordinates_x);
+	dm_free(dce110_opp->regamma.rgb_regamma);
+	dm_free(dce110_opp->regamma.rgb_resulted);
+	dm_free(dce110_opp->regamma.rgb_oem);
+	dm_free(dce110_opp->regamma.rgb_user);
+
+	dm_free(dce110_opp);
 	*opp = NULL;
 }
 
-- 
2.7.4

