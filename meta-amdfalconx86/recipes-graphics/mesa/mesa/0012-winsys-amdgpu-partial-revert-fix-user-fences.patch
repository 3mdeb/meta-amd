From 5f8f43a046b5ec4167201ee9ccfe0f8e8ff62878 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Christian=20K=C3=B6nig?= <christian.koenig@amd.com>
Date: Fri, 24 Jul 2015 10:27:55 +0200
Subject: [PATCH 12/16] winsys/amdgpu: partial revert "fix user fences"
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

The index is indeed in qword, libdrm is doing the multiplication.

Signed-off-by: Christian KÃ¶nig <christian.koenig@amd.com>
Reviewed-by: Alex Deucher <alexander.deucher@amd.com>
Signed-off-by: Arindam Nath <arindam.nath@amd.com>
---
 src/gallium/winsys/amdgpu/drm/amdgpu_cs.c | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/src/gallium/winsys/amdgpu/drm/amdgpu_cs.c b/src/gallium/winsys/amdgpu/drm/amdgpu_cs.c
index 5910325..dbda6fe 100644
--- a/src/gallium/winsys/amdgpu/drm/amdgpu_cs.c
+++ b/src/gallium/winsys/amdgpu/drm/amdgpu_cs.c
@@ -581,7 +581,7 @@ void amdgpu_cs_emit_ioctl_oneshot(struct amdgpu_cs *cs, struct amdgpu_cs_context
    csc->request.fence_info.handle = NULL;
    if (csc->request.ip_type != AMDGPU_HW_IP_UVD && csc->request.ip_type != AMDGPU_HW_IP_VCE) {
 	csc->request.fence_info.handle = cs->ctx->user_fence_bo;
-	csc->request.fence_info.offset = cs->base.ring_type * 8;
+	csc->request.fence_info.offset = cs->base.ring_type;
    }
    r = amdgpu_cs_submit(cs->ctx->ctx, 0, &csc->request, 1);
    if (r) {
@@ -597,7 +597,7 @@ void amdgpu_cs_emit_ioctl_oneshot(struct amdgpu_cs *cs, struct amdgpu_cs_context
       uint64_t *user_fence = NULL;
       if (csc->request.ip_type != AMDGPU_HW_IP_UVD && csc->request.ip_type != AMDGPU_HW_IP_VCE)
          user_fence = cs->ctx->user_fence_cpu_address_base +
-                      csc->request.fence_info.offset / 8;
+                      csc->request.fence_info.offset;
       amdgpu_fence_submitted(csc->fence, &csc->request, user_fence);
 
       pipe_mutex_lock(ws->bo_fence_lock);
-- 
1.9.1

