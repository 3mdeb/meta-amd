From c35064fd866a4dc6ece8640f019c526684eee587 Mon Sep 17 00:00:00 2001
From: Yongqiang Sun <yongqiang.sun@amd.com>
Date: Thu, 25 Aug 2016 09:06:04 -0400
Subject: [PATCH 0846/1722] drm/amd/dal: Create isr_surface_update DC interface

Signed-off-by: Yongqiang Sun <yongqiang.sun@amd.com>
Acked-by: Harry Wentland <harry.wentland@amd.com>
Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
Signed-off-by: Kalyan Alle <kalyan.alle@amd.com>
---
 drivers/gpu/drm/amd/dal/dc/core/dc.c | 39 ++++++++++++++++++++++++++++++++++++
 drivers/gpu/drm/amd/dal/dc/dc.h      | 14 ++++++++++++-
 2 files changed, 52 insertions(+), 1 deletion(-)

diff --git a/drivers/gpu/drm/amd/dal/dc/core/dc.c b/drivers/gpu/drm/amd/dal/dc/core/dc.c
index dc63548..af1b250 100644
--- a/drivers/gpu/drm/amd/dal/dc/core/dc.c
+++ b/drivers/gpu/drm/amd/dal/dc/core/dc.c
@@ -1353,6 +1353,45 @@ bool dc_update_surfaces_for_target(
 	return true;
 }
 
+static struct pipe_ctx *find_pipe_ctx_by_surface(struct validate_context *context,
+		const struct core_surface *surface)
+{
+	int i;
+	struct pipe_ctx *pipe_ctx = NULL;
+
+	for (i = 0; i < context->res_ctx.pool->pipe_count; i++) {
+		pipe_ctx = &context->res_ctx.pipe_ctx[i];
+		if (pipe_ctx->surface == surface)
+			break;
+		pipe_ctx = NULL;
+	}
+	ASSERT(pipe_ctx);
+	return pipe_ctx;
+}
+
+void dc_isr_surface_update(struct dc *dc, struct dc_surface_update *update)
+{
+	struct core_surface *surface = DC_SURFACE_TO_CORE(update->surface);
+	struct core_dc *core_dc = DC_TO_CORE(dc);
+	struct validate_context *context = core_dc->current_context;
+	struct pipe_ctx *pipe_ctx = NULL;
+
+	pipe_ctx = find_pipe_ctx_by_surface(context, surface);
+
+	if (!pipe_ctx)
+		return;
+
+	if (update->address || update->flip_immediate) {
+		if (update->address)
+			surface->public.address = *update->address;
+
+		if (update->flip_immediate)
+			surface->public.flip_immediate = *update->flip_immediate;
+
+		core_dc->hwss.update_plane_addr(core_dc, pipe_ctx);
+	}
+}
+
 uint8_t dc_get_current_target_count(const struct dc *dc)
 {
 	struct core_dc *core_dc = DC_TO_CORE(dc);
diff --git a/drivers/gpu/drm/amd/dal/dc/dc.h b/drivers/gpu/drm/amd/dal/dc/dc.h
index aa920b0..dff621f 100644
--- a/drivers/gpu/drm/amd/dal/dc/dc.h
+++ b/drivers/gpu/drm/amd/dal/dc/dc.h
@@ -167,9 +167,20 @@ struct dc_surface {
 	enum dc_rotation_angle rotation;
 	enum plane_stereo_format stereo_format;
 
-	struct dc_gamma *gamma_correction;
+	const struct dc_gamma *gamma_correction;
 };
 
+struct dc_surface_update {
+	const struct dc_surface *surface;
+
+	/* update parameters.  null means no updates */
+	struct dc_plane_address *address;
+	bool *flip_immediate;
+/*	struct rect *src_rect;
+	struct rect *dst_rect;
+	struct rect *clip_rect;*/
+
+};
 /*
  * This structure is filled in by dc_surface_get_status and contains
  * the last requested address and the currently active address so the called
@@ -265,6 +276,7 @@ bool dc_update_surfaces_for_target(
 		uint8_t surface_count,
 		struct dc_target *dc_target);
 
+void dc_isr_surface_update(struct dc *dc, struct dc_surface_update *update);
 /*******************************************************************************
  * Target Interfaces
  ******************************************************************************/
-- 
2.7.4

