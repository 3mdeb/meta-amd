From cd90a108786041e5c94d86a061cb666734f1ef87 Mon Sep 17 00:00:00 2001
From: Tony Cheng <tony.cheng@amd.com>
Date: Thu, 25 Aug 2016 21:40:48 -0400
Subject: [PATCH 0940/1722] drm/amd/dal: move bios_local_image to base

Change-Id: I145bd66ae9cc74564d873c0976b00715fb5bd544
Signed-off-by: Jordan Lazare <Jordan.Lazare@amd.com>
Acked-by: Harry Wentland <harry.wentland@amd.com>
Signed-off-by: Kalyan Alle <kalyan.alle@amd.com>
---
 drivers/gpu/drm/amd/dal/dc/bios/bios_parser.c          | 18 +++++++++---------
 .../drm/amd/dal/dc/bios/bios_parser_types_internal.h   |  2 --
 drivers/gpu/drm/amd/dal/dc/dc_bios_types.h             |  2 ++
 3 files changed, 11 insertions(+), 11 deletions(-)

diff --git a/drivers/gpu/drm/amd/dal/dc/bios/bios_parser.c b/drivers/gpu/drm/amd/dal/dc/bios/bios_parser.c
index bb78d3c..341f42d 100644
--- a/drivers/gpu/drm/amd/dal/dc/bios/bios_parser.c
+++ b/drivers/gpu/drm/amd/dal/dc/bios/bios_parser.c
@@ -125,8 +125,8 @@ struct dc_bios *bios_parser_create(
 
 static void destruct(struct bios_parser *bp)
 {
-	if (bp->bios_local_image)
-		dm_free(bp->bios_local_image);
+	if (bp->base.bios_local_image)
+		dm_free(bp->base.bios_local_image);
 }
 
 static void bios_parser_destroy(struct dc_bios **dcb)
@@ -3840,16 +3840,16 @@ static void process_ext_display_connection_info(struct bios_parser *bp,
 		uint8_t *original_bios;
 		/* Step 1: Replace bios image with the new copy which will be
 		 * patched */
-		bp->bios_local_image = dm_alloc(bp->base.bios_size);
-		if (bp->bios_local_image == NULL) {
+		bp->base.bios_local_image = dm_alloc(bp->base.bios_size);
+		if (bp->base.bios_local_image == NULL) {
 			BREAK_TO_DEBUGGER();
-			/* Failed to alloc bp->bios_local_image */
+			/* Failed to alloc bp->base.bios_local_image */
 			return;
 		}
 
-		memmove(bp->bios_local_image, bp->base.bios, bp->base.bios_size);
+		memmove(bp->base.bios_local_image, bp->base.bios, bp->base.bios_size);
 		original_bios = bp->base.bios;
-		bp->base.bios = bp->bios_local_image;
+		bp->base.bios = bp->base.bios_local_image;
 		connector_tbl =
 				GET_IMAGE(ATOM_OBJECT_TABLE, connector_tbl_offset);
 
@@ -3862,7 +3862,7 @@ static void process_ext_display_connection_info(struct bios_parser *bp,
 			 * again original image provided and afterwards
 			 * only remove null entries */
 			memmove(
-					bp->bios_local_image,
+					bp->base.bios_local_image,
 					original_bios,
 					bp->base.bios_size);
 		}
@@ -4469,7 +4469,7 @@ static bool bios_parser_construct(
         bp->base.bios_size = bp->base.bios[BIOS_IMAGE_SIZE_OFFSET] * BIOS_IMAGE_SIZE_UNIT;
 
         bp->base.ctx = init->ctx;
-	bp->bios_local_image = NULL;
+        bp->base.bios_local_image = NULL;
 
 	rom_header_offset =
 	GET_IMAGE(uint16_t, OFFSET_TO_POINTER_TO_ATOM_ROM_HEADER);
diff --git a/drivers/gpu/drm/amd/dal/dc/bios/bios_parser_types_internal.h b/drivers/gpu/drm/amd/dal/dc/bios/bios_parser_types_internal.h
index be12ac7..b286a18 100644
--- a/drivers/gpu/drm/amd/dal/dc/bios/bios_parser_types_internal.h
+++ b/drivers/gpu/drm/amd/dal/dc/bios/bios_parser_types_internal.h
@@ -64,8 +64,6 @@ struct bios_parser {
 	const struct command_table_helper *cmd_helper;
 	struct cmd_tbl cmd_tbl;
 
-	uint8_t *bios_local_image;
-
 	bool remap_device_tags;
 };
 
diff --git a/drivers/gpu/drm/amd/dal/dc/dc_bios_types.h b/drivers/gpu/drm/amd/dal/dc/dc_bios_types.h
index bbded69..2b370ff 100644
--- a/drivers/gpu/drm/amd/dal/dc/dc_bios_types.h
+++ b/drivers/gpu/drm/amd/dal/dc/dc_bios_types.h
@@ -243,6 +243,8 @@ struct dc_bios {
 	uint8_t *bios;
 	uint32_t bios_size;
 
+	uint8_t *bios_local_image;
+
 	struct dc_context *ctx;
 };
 
-- 
2.7.4

