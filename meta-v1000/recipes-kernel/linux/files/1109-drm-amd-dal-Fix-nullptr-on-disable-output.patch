From da3f2710cac85d58026743f61e3af6fa281cbbbf Mon Sep 17 00:00:00 2001
From: Vitaly Prosyak <vitaly.prosyak@amd.com>
Date: Thu, 22 Sep 2016 16:19:58 -0400
Subject: [PATCH 1109/1722] drm/amd/dal: Fix nullptr on disable output

Remove stream first and then add a new stream
to avoid stream release by freesync module.

Change-Id: Iae64ffef5a8774203ad60facc3b6ef197423a733
Signed-off-by: Vitaly Prosyak <vitaly.prosyak@amd.com>
Acked-by: Harry Wentland <harry.wentland@amd.com>
Signed-off-by: Kalyan Alle <kalyan.alle@amd.com>
---
 .../gpu/drm/amd/dal/amdgpu_dm/amdgpu_dm_types.c    | 38 ++++++++--------------
 1 file changed, 13 insertions(+), 25 deletions(-)

diff --git a/drivers/gpu/drm/amd/dal/amdgpu_dm/amdgpu_dm_types.c b/drivers/gpu/drm/amd/dal/amdgpu_dm/amdgpu_dm_types.c
index 369e337..3f54c3e 100644
--- a/drivers/gpu/drm/amd/dal/amdgpu_dm/amdgpu_dm_types.c
+++ b/drivers/gpu/drm/amd/dal/amdgpu_dm/amdgpu_dm_types.c
@@ -2492,11 +2492,6 @@ int amdgpu_dm_atomic_commit(
 			acrtc->enabled = true;
 			acrtc->hw_mode = crtc->state->mode;
 			crtc->hwmode = crtc->state->mode;
-			if (adev->dm.freesync_module)
-				for (j = 0; j < acrtc->target->stream_count; j++)
-					mod_freesync_add_stream(
-							adev->dm.freesync_module,
-							acrtc->target->streams[j]);
 			break;
 		}
 
@@ -2614,11 +2609,17 @@ int amdgpu_dm_atomic_commit(
 		 */
 		struct amdgpu_crtc *acrtc = new_crtcs[i];
 
-		if (adev->dm.freesync_module)
+		if (adev->dm.freesync_module) {
+			for (j = 0; j < acrtc->target->stream_count; j++)
+				mod_freesync_add_stream(
+						adev->dm.freesync_module,
+						acrtc->target->streams[j]);
+
 			mod_freesync_notify_mode_change(
 						adev->dm.freesync_module,
 						acrtc->target->streams,
 						acrtc->target->stream_count);
+		}
 
 		manage_dm_interrupts(adev, acrtc, true);
 		dm_crtc_cursor_reset(&acrtc->base);
@@ -2729,45 +2730,32 @@ void dm_restore_drm_connector_state(struct drm_device *dev, struct drm_connector
 			}
 		}
 
-		if (adev->dm.freesync_module)
-			for (i = 0; i < disconnected_acrtc->target->stream_count; i++)
-				mod_freesync_add_stream(
-						adev->dm.freesync_module,
-						disconnected_acrtc->target->streams[i]);
-
 		/* DC is optimized not to do anything if 'targets' didn't change. */
 		if (!dc_commit_targets(dc, commit_targets,
 				commit_targets_count)) {
 			DRM_INFO("Failed to restore connector state!\n");
-			if (adev->dm.freesync_module)
-				for (i = 0; i < disconnected_acrtc->target->stream_count; i++)
-					mod_freesync_remove_stream(
-							adev->dm.freesync_module,
-							disconnected_acrtc->target->streams[i]);
 			dc_target_release(disconnected_acrtc->target);
 			disconnected_acrtc->target = current_target;
 			manage_dm_interrupts(adev, disconnected_acrtc, true);
 			return;
 		}
 
-		if (adev->dm.freesync_module)
+		if (adev->dm.freesync_module) {
 			for (i = 0; i < current_target->stream_count; i++)
 				mod_freesync_remove_stream(
 						adev->dm.freesync_module,
 						current_target->streams[i]);
-
+			for (i = 0; i < new_target->stream_count; i++)
+				mod_freesync_add_stream(
+						adev->dm.freesync_module,
+						new_target->streams[i]);
+		}
 		list_for_each_entry(crtc, &dev->mode_config.crtc_list, head) {
 			struct amdgpu_crtc *acrtc = to_amdgpu_crtc(crtc);
 
 			if (acrtc->target != NULL) {
 				acrtc->otg_inst =
 					dc_target_get_status(acrtc->target)->primary_otg_inst;
-
-				if (adev->dm.freesync_module)
-					mod_freesync_notify_mode_change(
-							adev->dm.freesync_module,
-							acrtc->target->streams,
-							acrtc->target->stream_count);
 			}
 		}
 
-- 
2.7.4

